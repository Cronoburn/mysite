/**
 * @license almond 0.3.3 Copyright jQuery Foundation and other contributors.
 * Released under MIT license, http://github.com/requirejs/almond/LICENSE
 */

/*!
 * Sizzle CSS Selector Engine v2.2.1
 * http://sizzlejs.com/
 *
 * Copyright jQuery Foundation and other contributors
 * Released under the MIT license
 * http://jquery.org/license
 *
 * Date: 2015-10-17
 */

/*
jed.js
v0.5.0beta

https://github.com/SlexAxton/Jed
-----------
A gettext compatible i18n library for modern JavaScript Applications

by Alex Sexton - AlexSexton [at] gmail - @SlexAxton
WTFPL license for use
Dojo CLA for contributions

Jed offers the entire applicable GNU gettext spec'd set of
functions, but also offers some nicer wrappers around them.
The api for gettext was written for a language with no function
overloading, so Jed allows a little more of that.

Many thanks to Joshua I. Miller - unrtst@cpan.org - who wrote
gettext.js back in 2008. I was able to vet a lot of my ideas
against his. I also made sure Jed passed against his tests
in order to offer easy upgrades -- jsgettext.berlios.de
*/

// Underscore 1.3.0 was used to port and is licensed

/**
   sprintf() for JavaScript 0.7-beta1
   http://www.diveintojavascript.com/projects/javascript-sprintf

   Copyright (c) Alexandru Marasteanu <alexaholic [at) gmail (dot] com>
   All rights reserved.

   Redistribution and use in source and binary forms, with or without
   modification, are permitted provided that the following conditions are met:
       * Redistributions of source code must retain the above copyright
         notice, this list of conditions and the following disclaimer.
       * Redistributions in binary form must reproduce the above copyright
         notice, this list of conditions and the following disclaimer in the
         documentation and/or other materials provided with the distribution.
       * Neither the name of sprintf() for JavaScript nor the
         names of its contributors may be used to endorse or promote products
         derived from this software without specific prior written permission.

   THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND
   ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
   WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
   DISCLAIMED. IN NO EVENT SHALL Alexandru Marasteanu BE LIABLE FOR ANY
   DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
   (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
   LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
   ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
   (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
   SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
  */

/**
 * @license text 2.0.15 Copyright jQuery Foundation and other contributors.
 * Released under MIT license, http://github.com/requirejs/text/LICENSE
 */

/*!
 * jQuery Browser Plugin 0.1.0
 * https://github.com/gabceb/jquery-browser-plugin
 *
 * Original jquery-browser code Copyright 2005, 2015 jQuery Foundation, Inc. and other contributors
 * http://jquery.org/license
 *
 * Modifications Copyright 2015 Gabriel Cebrian
 * https://github.com/gabceb
 *
 * Released under the MIT license
 *
 * Date: 05-07-2015
 */

/* Lo-Dash Template Loader v1.0.1
 * Copyright 2015, Tim Branyen (@tbranyen).
 * loader.js may be freely distributed under the MIT license.
 */

//# sourceMappingURL=pluggable.js.map;
// Converse.js (A browser based XMPP chat client)
// http://conversejs.org
//
// Copyright (c) 2012-2017, Jan-Carel Brand <jc@opkode.com>
// Licensed under the Mozilla Public License (MPLv2)
//

// Converse.js (A browser based XMPP chat client)
// http://conversejs.org
//
// Copyright (c) 2012-2017, Jan-Carel Brand <jc@opkode.com>
// Licensed under the Mozilla Public License (MPLv2)
//

!function(e,t){"function"==typeof define&&define.amd?define([],t):e.converse=t()}(this,function(){var requirejs,require,define;!function(e){function t(e,t){return v.call(e,t)}function n(e,t){var n,i,o,s,r,a,l,c,u,d,h,p,_=t&&t.split("/"),m=f.map,g=m&&m["*"]||{};if(e){for(e=e.split("/"),r=e.length-1,f.nodeIdCompat&&y.test(e[r])&&(e[r]=e[r].replace(y,"")),"."===e[0].charAt(0)&&_&&(p=_.slice(0,_.length-1),e=p.concat(e)),u=0;u<e.length;u++)if(h=e[u],"."===h)e.splice(u,1),u-=1;else if(".."===h){if(0===u||1===u&&".."===e[2]||".."===e[u-1])continue;u>0&&(e.splice(u-1,2),u-=2)}e=e.join("/")}if((_||g)&&m){for(n=e.split("/"),u=n.length;u>0;u-=1){if(i=n.slice(0,u).join("/"),_)for(d=_.length;d>0;d-=1)if(o=m[_.slice(0,d).join("/")],o&&(o=o[i])){s=o,a=u;break}if(s)break;!l&&g&&g[i]&&(l=g[i],c=u)}!s&&l&&(s=l,a=c),s&&(n.splice(0,a,s),e=n.join("/"))}return e}function i(t,n){return function(){var i=b.call(arguments,0);return"string"!=typeof i[0]&&1===i.length&&i.push(null),d.apply(e,i.concat([t,n]))}}function o(e){return function(t){return n(t,e)}}function s(e){return function(t){_[e]=t}}function r(n){if(t(m,n)){var i=m[n];delete m[n],g[n]=!0,u.apply(e,i)}if(!t(_,n)&&!t(g,n))throw new Error("No "+n);return _[n]}function a(e){var t,n=e?e.indexOf("!"):-1;return n>-1&&(t=e.substring(0,n),e=e.substring(n+1,e.length)),[t,e]}function l(e){return e?a(e):[]}function c(e){return function(){return f&&f.config&&f.config[e]||{}}}var u,d,h,p,_={},m={},f={},g={},v=Object.prototype.hasOwnProperty,b=[].slice,y=/\.js$/;h=function(e,t){var i,s=a(e),l=s[0],c=t[1];return e=s[1],l&&(l=n(l,c),i=r(l)),l?e=i&&i.normalize?i.normalize(e,o(c)):n(e,c):(e=n(e,c),s=a(e),l=s[0],e=s[1],l&&(i=r(l))),{f:l?l+"!"+e:e,n:e,pr:l,p:i}},p={require:function(e){return i(e)},exports:function(e){var t=_[e];return"undefined"!=typeof t?t:_[e]={}},module:function(e){return{id:e,uri:"",exports:_[e],config:c(e)}}},u=function(n,o,a,c){var u,d,f,v,b,y,w,x=[],C=typeof a;if(c=c||n,y=l(c),"undefined"===C||"function"===C){for(o=!o.length&&a.length?["require","exports","module"]:o,b=0;b<o.length;b+=1)if(v=h(o[b],y),d=v.f,"require"===d)x[b]=p.require(n);else if("exports"===d)x[b]=p.exports(n),w=!0;else if("module"===d)u=x[b]=p.module(n);else if(t(_,d)||t(m,d)||t(g,d))x[b]=r(d);else{if(!v.p)throw new Error(n+" missing "+d);v.p.load(v.n,i(c,!0),s(d),{}),x[b]=_[d]}f=a?a.apply(_[n],x):void 0,n&&(u&&u.exports!==e&&u.exports!==_[n]?_[n]=u.exports:f===e&&w||(_[n]=f))}else n&&(_[n]=a)},requirejs=require=d=function(t,n,i,o,s){if("string"==typeof t)return p[t]?p[t](n):r(h(t,l(n)).f);if(!t.splice){if(f=t,f.deps&&d(f.deps,f.callback),!n)return;n.splice?(t=n,n=i,i=null):t=e}return n=n||function(){},"function"==typeof i&&(i=o,o=s),o?u(e,t,n,i):setTimeout(function(){u(e,t,n,i)},4),d},d.config=function(e){return d(e)},requirejs._defined=_,define=function(e,n,i){if("string"!=typeof e)throw new Error("See almond README: incorrect module build, no module name");n.splice||(i=n,n=[]),t(_,e)||t(m,e)||(m[e]=[e,n,i])},define.amd={jQuery:!0}}(),define("almond",function(){}),function(e){function t(e,t,n,i){var o,s,r,a,l,c,d,p,_=t&&t.ownerDocument,m=t?t.nodeType:9;if(n=n||[],"string"!=typeof e||!e||1!==m&&9!==m&&11!==m)return n;if(!i&&((t?t.ownerDocument||t:z)!==M&&T(t),t=t||M,F)){if(11!==m&&(c=ge.exec(e)))if(o=c[1]){if(9===m){if(!(r=t.getElementById(o)))return n;if(r.id===o)return n.push(r),n}else if(_&&(r=_.getElementById(o))&&$(t,r)&&r.id===o)return n.push(r),n}else{if(c[2])return K.apply(n,t.getElementsByTagName(e)),n;if((o=c[3])&&w.getElementsByClassName&&t.getElementsByClassName)return K.apply(n,t.getElementsByClassName(o)),n}if(w.qsa&&!V[e+" "]&&(!O||!O.test(e))){if(1!==m)_=t,p=e;else if("object"!==t.nodeName.toLowerCase()){for((a=t.getAttribute("id"))?a=a.replace(be,"\\$&"):t.setAttribute("id",a=q),d=k(e),s=d.length,l=he.test(a)?"#"+a:"[id='"+a+"']";s--;)d[s]=l+" "+h(d[s]);p=d.join(","),_=ve.test(e)&&u(t.parentNode)||t}if(p)try{return K.apply(n,_.querySelectorAll(p)),n}catch(e){}finally{a===q&&t.removeAttribute("id")}}}return N(e.replace(ae,"$1"),t,n,i)}function n(){function e(n,i){return t.push(n+" ")>x.cacheLength&&delete e[t.shift()],e[n+" "]=i}var t=[];return e}function i(e){return e[q]=!0,e}function o(e){var t=M.createElement("div");try{return!!e(t)}catch(e){return!1}finally{t.parentNode&&t.parentNode.removeChild(t),t=null}}function s(e,t){for(var n=e.split("|"),i=n.length;i--;)x.attrHandle[n[i]]=t}function r(e,t){var n=t&&e,i=n&&1===e.nodeType&&1===t.nodeType&&(~t.sourceIndex||G)-(~e.sourceIndex||G);if(i)return i;if(n)for(;n=n.nextSibling;)if(n===t)return-1;return e?1:-1}function a(e){return function(t){var n=t.nodeName.toLowerCase();return"input"===n&&t.type===e}}function l(e){return function(t){var n=t.nodeName.toLowerCase();return("input"===n||"button"===n)&&t.type===e}}function c(e){return i(function(t){return t=+t,i(function(n,i){for(var o,s=e([],n.length,t),r=s.length;r--;)n[o=s[r]]&&(n[o]=!(i[o]=n[o]))})})}function u(e){return e&&"undefined"!=typeof e.getElementsByTagName&&e}function d(){}function h(e){for(var t=0,n=e.length,i="";t<n;t++)i+=e[t].value;return i}function p(e,t,n){var i=t.dir,o=n&&"parentNode"===i,s=U++;return t.first?function(t,n,s){for(;t=t[i];)if(1===t.nodeType||o)return e(t,n,s)}:function(t,n,r){var a,l,c,u=[P,s];if(r){for(;t=t[i];)if((1===t.nodeType||o)&&e(t,n,r))return!0}else for(;t=t[i];)if(1===t.nodeType||o){if(c=t[q]||(t[q]={}),l=c[t.uniqueID]||(c[t.uniqueID]={}),(a=l[i])&&a[0]===P&&a[1]===s)return u[2]=a[2];if(l[i]=u,u[2]=e(t,n,r))return!0}}}function _(e){return e.length>1?function(t,n,i){for(var o=e.length;o--;)if(!e[o](t,n,i))return!1;return!0}:e[0]}function m(e,n,i){for(var o=0,s=n.length;o<s;o++)t(e,n[o],i);return i}function f(e,t,n,i,o){for(var s,r=[],a=0,l=e.length,c=null!=t;a<l;a++)(s=e[a])&&(n&&!n(s,i,o)||(r.push(s),c&&t.push(a)));return r}function g(e,t,n,o,s,r){return o&&!o[q]&&(o=g(o)),s&&!s[q]&&(s=g(s,r)),i(function(i,r,a,l){var c,u,d,h=[],p=[],_=r.length,g=i||m(t||"*",a.nodeType?[a]:a,[]),v=!e||!i&&t?g:f(g,h,e,a,l),b=n?s||(i?e:_||o)?[]:r:v;if(n&&n(v,b,a,l),o)for(c=f(b,p),o(c,[],a,l),u=c.length;u--;)(d=c[u])&&(b[p[u]]=!(v[p[u]]=d));if(i){if(s||e){if(s){for(c=[],u=b.length;u--;)(d=b[u])&&c.push(v[u]=d);s(null,b=[],c,l)}for(u=b.length;u--;)(d=b[u])&&(c=s?ee(i,d):h[u])>-1&&(i[c]=!(r[c]=d))}}else b=f(b===r?b.splice(_,b.length):b),s?s(null,r,b,l):K.apply(r,b)})}function v(e){for(var t,n,i,o=e.length,s=x.relative[e[0].type],r=s||x.relative[" "],a=s?1:0,l=p(function(e){return e===t},r,!0),c=p(function(e){return ee(t,e)>-1},r,!0),u=[function(e,n,i){var o=!s&&(i||n!==A)||((t=n).nodeType?l(e,n,i):c(e,n,i));return t=null,o}];a<o;a++)if(n=x.relative[e[a].type])u=[p(_(u),n)];else{if(n=x.filter[e[a].type].apply(null,e[a].matches),n[q]){for(i=++a;i<o&&!x.relative[e[i].type];i++);return g(a>1&&_(u),a>1&&h(e.slice(0,a-1).concat({value:" "===e[a-2].type?"*":""})).replace(ae,"$1"),n,a<i&&v(e.slice(a,i)),i<o&&v(e=e.slice(i)),i<o&&h(e))}u.push(n)}return _(u)}function b(e,n){var o=n.length>0,s=e.length>0,r=function(i,r,a,l,c){var u,d,h,p=0,_="0",m=i&&[],g=[],v=A,b=i||s&&x.find.TAG("*",c),y=P+=null==v?1:Math.random()||.1,w=b.length;for(c&&(A=r===M||r||c);_!==w&&null!=(u=b[_]);_++){if(s&&u){for(d=0,r||u.ownerDocument===M||(T(u),a=!F);h=e[d++];)if(h(u,r||M,a)){l.push(u);break}c&&(P=y)}o&&((u=!h&&u)&&p--,i&&m.push(u))}if(p+=_,o&&_!==p){for(d=0;h=n[d++];)h(m,g,r,a);if(i){if(p>0)for(;_--;)m[_]||g[_]||(g[_]=X.call(l));g=f(g)}K.apply(l,g),c&&!i&&g.length>0&&p+n.length>1&&t.uniqueSort(l)}return c&&(P=y,A=v),m};return o?i(r):r}var y,w,x,C,S,k,j,N,A,E,R,T,M,D,F,O,I,B,$,q="sizzle"+1*new Date,z=e.document,P=0,U=0,L=n(),H=n(),V=n(),J=function(e,t){return e===t&&(R=!0),0},G=1<<31,W={}.hasOwnProperty,Y=[],X=Y.pop,Q=Y.push,K=Y.push,Z=Y.slice,ee=function(e,t){for(var n=0,i=e.length;n<i;n++)if(e[n]===t)return n;return-1},te="checked|selected|async|autofocus|autoplay|controls|defer|disabled|hidden|ismap|loop|multiple|open|readonly|required|scoped",ne="[\\x20\\t\\r\\n\\f]",ie="(?:\\\\.|[\\w-]|[^\\x00-\\xa0])+",oe="\\["+ne+"*("+ie+")(?:"+ne+"*([*^$|!~]?=)"+ne+"*(?:'((?:\\\\.|[^\\\\'])*)'|\"((?:\\\\.|[^\\\\\"])*)\"|("+ie+"))|)"+ne+"*\\]",se=":("+ie+")(?:\\((('((?:\\\\.|[^\\\\'])*)'|\"((?:\\\\.|[^\\\\\"])*)\")|((?:\\\\.|[^\\\\()[\\]]|"+oe+")*)|.*)\\)|)",re=new RegExp(ne+"+","g"),ae=new RegExp("^"+ne+"+|((?:^|[^\\\\])(?:\\\\.)*)"+ne+"+$","g"),le=new RegExp("^"+ne+"*,"+ne+"*"),ce=new RegExp("^"+ne+"*([>+~]|"+ne+")"+ne+"*"),ue=new RegExp("="+ne+"*([^\\]'\"]*?)"+ne+"*\\]","g"),de=new RegExp(se),he=new RegExp("^"+ie+"$"),pe={ID:new RegExp("^#("+ie+")"),CLASS:new RegExp("^\\.("+ie+")"),TAG:new RegExp("^("+ie+"|[*])"),ATTR:new RegExp("^"+oe),PSEUDO:new RegExp("^"+se),CHILD:new RegExp("^:(only|first|last|nth|nth-last)-(child|of-type)(?:\\("+ne+"*(even|odd|(([+-]|)(\\d*)n|)"+ne+"*(?:([+-]|)"+ne+"*(\\d+)|))"+ne+"*\\)|)","i"),bool:new RegExp("^(?:"+te+")$","i"),needsContext:new RegExp("^"+ne+"*[>+~]|:(even|odd|eq|gt|lt|nth|first|last)(?:\\("+ne+"*((?:-\\d)?\\d*)"+ne+"*\\)|)(?=[^-]|$)","i")},_e=/^(?:input|select|textarea|button)$/i,me=/^h\d$/i,fe=/^[^{]+\{\s*\[native \w/,ge=/^(?:#([\w-]+)|(\w+)|\.([\w-]+))$/,ve=/[+~]/,be=/'|\\/g,ye=new RegExp("\\\\([\\da-f]{1,6}"+ne+"?|("+ne+")|.)","ig"),we=function(e,t,n){var i="0x"+t-65536;return i!==i||n?t:i<0?String.fromCharCode(i+65536):String.fromCharCode(i>>10|55296,1023&i|56320)},xe=function(){T()};try{K.apply(Y=Z.call(z.childNodes),z.childNodes),Y[z.childNodes.length].nodeType}catch(e){K={apply:Y.length?function(e,t){Q.apply(e,Z.call(t))}:function(e,t){for(var n=e.length,i=0;e[n++]=t[i++];);e.length=n-1}}}w=t.support={},S=t.isXML=function(e){var t=e&&(e.ownerDocument||e).documentElement;return!!t&&"HTML"!==t.nodeName},T=t.setDocument=function(e){var t,n,i=e?e.ownerDocument||e:z;return i!==M&&9===i.nodeType&&i.documentElement?(M=i,D=M.documentElement,F=!S(M),(n=M.defaultView)&&n.top!==n&&(n.addEventListener?n.addEventListener("unload",xe,!1):n.attachEvent&&n.attachEvent("onunload",xe)),w.attributes=o(function(e){return e.className="i",!e.getAttribute("className")}),w.getElementsByTagName=o(function(e){return e.appendChild(M.createComment("")),!e.getElementsByTagName("*").length}),w.getElementsByClassName=fe.test(M.getElementsByClassName),w.getById=o(function(e){return D.appendChild(e).id=q,!M.getElementsByName||!M.getElementsByName(q).length}),w.getById?(x.find.ID=function(e,t){if("undefined"!=typeof t.getElementById&&F){var n=t.getElementById(e);return n?[n]:[]}},x.filter.ID=function(e){var t=e.replace(ye,we);return function(e){return e.getAttribute("id")===t}}):(delete x.find.ID,x.filter.ID=function(e){var t=e.replace(ye,we);return function(e){var n="undefined"!=typeof e.getAttributeNode&&e.getAttributeNode("id");return n&&n.value===t}}),x.find.TAG=w.getElementsByTagName?function(e,t){return"undefined"!=typeof t.getElementsByTagName?t.getElementsByTagName(e):w.qsa?t.querySelectorAll(e):void 0}:function(e,t){var n,i=[],o=0,s=t.getElementsByTagName(e);if("*"===e){for(;n=s[o++];)1===n.nodeType&&i.push(n);return i}return s},x.find.CLASS=w.getElementsByClassName&&function(e,t){if("undefined"!=typeof t.getElementsByClassName&&F)return t.getElementsByClassName(e)},I=[],O=[],(w.qsa=fe.test(M.querySelectorAll))&&(o(function(e){D.appendChild(e).innerHTML="<a id='"+q+"'></a><select id='"+q+"-\r\\' msallowcapture=''><option selected=''></option></select>",e.querySelectorAll("[msallowcapture^='']").length&&O.push("[*^$]="+ne+"*(?:''|\"\")"),e.querySelectorAll("[selected]").length||O.push("\\["+ne+"*(?:value|"+te+")"),e.querySelectorAll("[id~="+q+"-]").length||O.push("~="),e.querySelectorAll(":checked").length||O.push(":checked"),e.querySelectorAll("a#"+q+"+*").length||O.push(".#.+[+~]")}),o(function(e){var t=M.createElement("input");t.setAttribute("type","hidden"),e.appendChild(t).setAttribute("name","D"),e.querySelectorAll("[name=d]").length&&O.push("name"+ne+"*[*^$|!~]?="),e.querySelectorAll(":enabled").length||O.push(":enabled",":disabled"),e.querySelectorAll("*,:x"),O.push(",.*:")})),(w.matchesSelector=fe.test(B=D.matches||D.webkitMatchesSelector||D.mozMatchesSelector||D.oMatchesSelector||D.msMatchesSelector))&&o(function(e){w.disconnectedMatch=B.call(e,"div"),B.call(e,"[s!='']:x"),I.push("!=",se)}),O=O.length&&new RegExp(O.join("|")),I=I.length&&new RegExp(I.join("|")),t=fe.test(D.compareDocumentPosition),$=t||fe.test(D.contains)?function(e,t){var n=9===e.nodeType?e.documentElement:e,i=t&&t.parentNode;return e===i||!(!i||1!==i.nodeType||!(n.contains?n.contains(i):e.compareDocumentPosition&&16&e.compareDocumentPosition(i)))}:function(e,t){if(t)for(;t=t.parentNode;)if(t===e)return!0;return!1},J=t?function(e,t){if(e===t)return R=!0,0;var n=!e.compareDocumentPosition-!t.compareDocumentPosition;return n?n:(n=(e.ownerDocument||e)===(t.ownerDocument||t)?e.compareDocumentPosition(t):1,1&n||!w.sortDetached&&t.compareDocumentPosition(e)===n?e===M||e.ownerDocument===z&&$(z,e)?-1:t===M||t.ownerDocument===z&&$(z,t)?1:E?ee(E,e)-ee(E,t):0:4&n?-1:1)}:function(e,t){if(e===t)return R=!0,0;var n,i=0,o=e.parentNode,s=t.parentNode,a=[e],l=[t];if(!o||!s)return e===M?-1:t===M?1:o?-1:s?1:E?ee(E,e)-ee(E,t):0;if(o===s)return r(e,t);for(n=e;n=n.parentNode;)a.unshift(n);for(n=t;n=n.parentNode;)l.unshift(n);for(;a[i]===l[i];)i++;return i?r(a[i],l[i]):a[i]===z?-1:l[i]===z?1:0},M):M},t.matches=function(e,n){return t(e,null,null,n)},t.matchesSelector=function(e,n){if((e.ownerDocument||e)!==M&&T(e),n=n.replace(ue,"='$1']"),w.matchesSelector&&F&&!V[n+" "]&&(!I||!I.test(n))&&(!O||!O.test(n)))try{var i=B.call(e,n);if(i||w.disconnectedMatch||e.document&&11!==e.document.nodeType)return i}catch(e){}return t(n,M,null,[e]).length>0},t.contains=function(e,t){return(e.ownerDocument||e)!==M&&T(e),$(e,t)},t.attr=function(e,t){(e.ownerDocument||e)!==M&&T(e);var n=x.attrHandle[t.toLowerCase()],i=n&&W.call(x.attrHandle,t.toLowerCase())?n(e,t,!F):void 0;return void 0!==i?i:w.attributes||!F?e.getAttribute(t):(i=e.getAttributeNode(t))&&i.specified?i.value:null},t.error=function(e){throw new Error("Syntax error, unrecognized expression: "+e)},t.uniqueSort=function(e){var t,n=[],i=0,o=0;if(R=!w.detectDuplicates,E=!w.sortStable&&e.slice(0),e.sort(J),R){for(;t=e[o++];)t===e[o]&&(i=n.push(o));for(;i--;)e.splice(n[i],1)}return E=null,e},C=t.getText=function(e){var t,n="",i=0,o=e.nodeType;if(o){if(1===o||9===o||11===o){if("string"==typeof e.textContent)return e.textContent;for(e=e.firstChild;e;e=e.nextSibling)n+=C(e)}else if(3===o||4===o)return e.nodeValue}else for(;t=e[i++];)n+=C(t);return n},x=t.selectors={cacheLength:50,createPseudo:i,match:pe,attrHandle:{},find:{},relative:{">":{dir:"parentNode",first:!0}," ":{dir:"parentNode"},"+":{dir:"previousSibling",first:!0},"~":{dir:"previousSibling"}},preFilter:{ATTR:function(e){return e[1]=e[1].replace(ye,we),e[3]=(e[3]||e[4]||e[5]||"").replace(ye,we),"~="===e[2]&&(e[3]=" "+e[3]+" "),e.slice(0,4)},CHILD:function(e){return e[1]=e[1].toLowerCase(),"nth"===e[1].slice(0,3)?(e[3]||t.error(e[0]),e[4]=+(e[4]?e[5]+(e[6]||1):2*("even"===e[3]||"odd"===e[3])),e[5]=+(e[7]+e[8]||"odd"===e[3])):e[3]&&t.error(e[0]),e},PSEUDO:function(e){var t,n=!e[6]&&e[2];return pe.CHILD.test(e[0])?null:(e[3]?e[2]=e[4]||e[5]||"":n&&de.test(n)&&(t=k(n,!0))&&(t=n.indexOf(")",n.length-t)-n.length)&&(e[0]=e[0].slice(0,t),e[2]=n.slice(0,t)),e.slice(0,3))}},filter:{TAG:function(e){var t=e.replace(ye,we).toLowerCase();return"*"===e?function(){return!0}:function(e){return e.nodeName&&e.nodeName.toLowerCase()===t}},CLASS:function(e){var t=L[e+" "];return t||(t=new RegExp("(^|"+ne+")"+e+"("+ne+"|$)"))&&L(e,function(e){return t.test("string"==typeof e.className&&e.className||"undefined"!=typeof e.getAttribute&&e.getAttribute("class")||"")})},ATTR:function(e,n,i){return function(o){var s=t.attr(o,e);return null==s?"!="===n:!n||(s+="","="===n?s===i:"!="===n?s!==i:"^="===n?i&&0===s.indexOf(i):"*="===n?i&&s.indexOf(i)>-1:"$="===n?i&&s.slice(-i.length)===i:"~="===n?(" "+s.replace(re," ")+" ").indexOf(i)>-1:"|="===n&&(s===i||s.slice(0,i.length+1)===i+"-"))}},CHILD:function(e,t,n,i,o){var s="nth"!==e.slice(0,3),r="last"!==e.slice(-4),a="of-type"===t;return 1===i&&0===o?function(e){return!!e.parentNode}:function(t,n,l){var c,u,d,h,p,_,m=s!==r?"nextSibling":"previousSibling",f=t.parentNode,g=a&&t.nodeName.toLowerCase(),v=!l&&!a,b=!1;if(f){if(s){for(;m;){for(h=t;h=h[m];)if(a?h.nodeName.toLowerCase()===g:1===h.nodeType)return!1;_=m="only"===e&&!_&&"nextSibling"}return!0}if(_=[r?f.firstChild:f.lastChild],r&&v){for(h=f,d=h[q]||(h[q]={}),u=d[h.uniqueID]||(d[h.uniqueID]={}),c=u[e]||[],p=c[0]===P&&c[1],b=p&&c[2],h=p&&f.childNodes[p];h=++p&&h&&h[m]||(b=p=0)||_.pop();)if(1===h.nodeType&&++b&&h===t){u[e]=[P,p,b];break}}else if(v&&(h=t,d=h[q]||(h[q]={}),u=d[h.uniqueID]||(d[h.uniqueID]={}),c=u[e]||[],p=c[0]===P&&c[1],b=p),b===!1)for(;(h=++p&&h&&h[m]||(b=p=0)||_.pop())&&((a?h.nodeName.toLowerCase()!==g:1!==h.nodeType)||!++b||(v&&(d=h[q]||(h[q]={}),u=d[h.uniqueID]||(d[h.uniqueID]={}),u[e]=[P,b]),h!==t)););return b-=o,b===i||b%i===0&&b/i>=0}}},PSEUDO:function(e,n){var o,s=x.pseudos[e]||x.setFilters[e.toLowerCase()]||t.error("unsupported pseudo: "+e);return s[q]?s(n):s.length>1?(o=[e,e,"",n],x.setFilters.hasOwnProperty(e.toLowerCase())?i(function(e,t){for(var i,o=s(e,n),r=o.length;r--;)i=ee(e,o[r]),e[i]=!(t[i]=o[r])}):function(e){return s(e,0,o)}):s}},pseudos:{not:i(function(e){var t=[],n=[],o=j(e.replace(ae,"$1"));return o[q]?i(function(e,t,n,i){for(var s,r=o(e,null,i,[]),a=e.length;a--;)(s=r[a])&&(e[a]=!(t[a]=s))}):function(e,i,s){return t[0]=e,o(t,null,s,n),t[0]=null,!n.pop()}}),has:i(function(e){return function(n){return t(e,n).length>0}}),contains:i(function(e){return e=e.replace(ye,we),function(t){return(t.textContent||t.innerText||C(t)).indexOf(e)>-1}}),lang:i(function(e){return he.test(e||"")||t.error("unsupported lang: "+e),e=e.replace(ye,we).toLowerCase(),function(t){var n;do if(n=F?t.lang:t.getAttribute("xml:lang")||t.getAttribute("lang"))return n=n.toLowerCase(),n===e||0===n.indexOf(e+"-");while((t=t.parentNode)&&1===t.nodeType);return!1}}),target:function(t){var n=e.location&&e.location.hash;return n&&n.slice(1)===t.id},root:function(e){return e===D},focus:function(e){return e===M.activeElement&&(!M.hasFocus||M.hasFocus())&&!!(e.type||e.href||~e.tabIndex)},enabled:function(e){return e.disabled===!1},disabled:function(e){return e.disabled===!0},checked:function(e){var t=e.nodeName.toLowerCase();return"input"===t&&!!e.checked||"option"===t&&!!e.selected},selected:function(e){return e.parentNode&&e.parentNode.selectedIndex,e.selected===!0},empty:function(e){for(e=e.firstChild;e;e=e.nextSibling)if(e.nodeType<6)return!1;return!0},parent:function(e){return!x.pseudos.empty(e)},header:function(e){return me.test(e.nodeName)},input:function(e){return _e.test(e.nodeName)},button:function(e){var t=e.nodeName.toLowerCase();return"input"===t&&"button"===e.type||"button"===t},text:function(e){var t;return"input"===e.nodeName.toLowerCase()&&"text"===e.type&&(null==(t=e.getAttribute("type"))||"text"===t.toLowerCase())},first:c(function(){return[0]}),last:c(function(e,t){return[t-1]}),eq:c(function(e,t,n){return[n<0?n+t:n]}),even:c(function(e,t){for(var n=0;n<t;n+=2)e.push(n);return e}),odd:c(function(e,t){for(var n=1;n<t;n+=2)e.push(n);return e}),lt:c(function(e,t,n){for(var i=n<0?n+t:n;--i>=0;)e.push(i);return e}),gt:c(function(e,t,n){for(var i=n<0?n+t:n;++i<t;)e.push(i);return e})}},x.pseudos.nth=x.pseudos.eq;for(y in{radio:!0,checkbox:!0,file:!0,password:!0,image:!0})x.pseudos[y]=a(y);for(y in{submit:!0,reset:!0})x.pseudos[y]=l(y);d.prototype=x.filters=x.pseudos,x.setFilters=new d,k=t.tokenize=function(e,n){var i,o,s,r,a,l,c,u=H[e+" "];if(u)return n?0:u.slice(0);for(a=e,l=[],c=x.preFilter;a;){i&&!(o=le.exec(a))||(o&&(a=a.slice(o[0].length)||a),l.push(s=[])),i=!1,(o=ce.exec(a))&&(i=o.shift(),s.push({value:i,type:o[0].replace(ae," ")}),a=a.slice(i.length));for(r in x.filter)!(o=pe[r].exec(a))||c[r]&&!(o=c[r](o))||(i=o.shift(),s.push({value:i,type:r,matches:o}),a=a.slice(i.length));if(!i)break}return n?a.length:a?t.error(e):H(e,l).slice(0)},j=t.compile=function(e,t){var n,i=[],o=[],s=V[e+" "];if(!s){for(t||(t=k(e)),n=t.length;n--;)s=v(t[n]),s[q]?i.push(s):o.push(s);s=V(e,b(o,i)),s.selector=e}return s},N=t.select=function(e,t,n,i){var o,s,r,a,l,c="function"==typeof e&&e,d=!i&&k(e=c.selector||e);if(n=n||[],1===d.length){if(s=d[0]=d[0].slice(0),s.length>2&&"ID"===(r=s[0]).type&&w.getById&&9===t.nodeType&&F&&x.relative[s[1].type]){if(t=(x.find.ID(r.matches[0].replace(ye,we),t)||[])[0],!t)return n;c&&(t=t.parentNode),e=e.slice(s.shift().value.length)}for(o=pe.needsContext.test(e)?0:s.length;o--&&(r=s[o],!x.relative[a=r.type]);)if((l=x.find[a])&&(i=l(r.matches[0].replace(ye,we),ve.test(s[0].type)&&u(t.parentNode)||t))){if(s.splice(o,1),e=i.length&&h(s),!e)return K.apply(n,i),n;break}}return(c||j(e,d))(i,t,!F,n,!t||ve.test(e)&&u(t.parentNode)||t),n},w.sortStable=q.split("").sort(J).join("")===q,w.detectDuplicates=!!R,T(),w.sortDetached=o(function(e){return 1&e.compareDocumentPosition(M.createElement("div"))}),o(function(e){return e.innerHTML="<a href='#'></a>","#"===e.firstChild.getAttribute("href")})||s("type|href|height|width",function(e,t,n){if(!n)return e.getAttribute(t,"type"===t.toLowerCase()?1:2)}),w.attributes&&o(function(e){return e.innerHTML="<input/>",e.firstChild.setAttribute("value",""),""===e.firstChild.getAttribute("value")})||s("value",function(e,t,n){if(!n&&"input"===e.nodeName.toLowerCase())return e.defaultValue}),o(function(e){return null==e.getAttribute("disabled")})||s(te,function(e,t,n){var i;if(!n)return e[t]===!0?t.toLowerCase():(i=e.getAttributeNode(t))&&i.specified?i.value:null}),"function"==typeof define&&define.amd?define("sizzle",[],function(){return t}):"undefined"!=typeof module&&module.exports?module.exports=t:e.Sizzle=t}(window),String.prototype.endsWith||(String.prototype.endsWith=function(e,t){var n=this.toString();(void 0===t||t>n.length)&&(t=n.length),t-=e.length;var i=n.indexOf(e,t);return i!==-1&&i===t}),String.prototype.startsWith||(String.prototype.startsWith=function(e,t){return t=t||0,this.substr(t,e.length)===e}),String.prototype.splitOnce||(String.prototype.splitOnce=function(e){var t=this.split(e);return[t.shift(),t.join(e)]}),String.prototype.trim||(String.prototype.trim=function(){return this.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,"")}),define("polyfill",function(){}),function(e,t){function n(e){return d.PF.compile(e||"nplurals=2; plural=(n != 1);")}function i(e,t){this._key=e,this._i18n=t}var o=Array.prototype,s=Object.prototype,r=o.slice,a=s.hasOwnProperty,l=o.forEach,c={},u={forEach:function(e,t,n){var i,o,s;if(null!==e)if(l&&e.forEach===l)e.forEach(t,n);else if(e.length===+e.length){for(i=0,o=e.length;i<o;i++)if(i in e&&t.call(n,e[i],i,e)===c)return}else for(s in e)if(a.call(e,s)&&t.call(n,e[s],s,e)===c)return},extend:function(e){return this.forEach(r.call(arguments,1),function(t){for(var n in t)e[n]=t[n]}),e}},d=function(e){if(this.defaults={locale_data:{messages:{"":{domain:"messages",lang:"en",plural_forms:"nplurals=2; plural=(n != 1);"}}},domain:"messages"},this.options=u.extend({},this.defaults,e),this.textdomain(this.options.domain),e.domain&&!this.options.locale_data[this.options.domain])throw new Error("Text domain set to non-existent domain: `"+e.domain+"`")};d.context_delimiter=String.fromCharCode(4),u.extend(i.prototype,{onDomain:function(e){return this._domain=e,this},withContext:function(e){return this._context=e,this},ifPlural:function(e,t){return this._val=e,this._pkey=t,this},fetch:function(e){return"[object Array]"!={}.toString.call(e)&&(e=[].slice.call(arguments)),(e&&e.length?d.sprintf:function(e){return e})(this._i18n.dcnpgettext(this._domain,this._context,this._key,this._pkey,this._val),e)}}),u.extend(d.prototype,{translate:function(e){return new i(e,this)},textdomain:function(e){return e?void(this._textdomain=e):this._textdomain},gettext:function(e){return this.dcnpgettext.call(this,t,t,e)},dgettext:function(e,n){return this.dcnpgettext.call(this,e,t,n)},dcgettext:function(e,n){return this.dcnpgettext.call(this,e,t,n)},ngettext:function(e,n,i){return this.dcnpgettext.call(this,t,t,e,n,i)},dngettext:function(e,n,i,o){return this.dcnpgettext.call(this,e,t,n,i,o)},dcngettext:function(e,n,i,o){return this.dcnpgettext.call(this,e,t,n,i,o)},pgettext:function(e,n){return this.dcnpgettext.call(this,t,e,n)},dpgettext:function(e,t,n){return this.dcnpgettext.call(this,e,t,n)},dcpgettext:function(e,t,n){return this.dcnpgettext.call(this,e,t,n)},npgettext:function(e,n,i,o){return this.dcnpgettext.call(this,t,e,n,i,o)},dnpgettext:function(e,t,n,i,o){return this.dcnpgettext.call(this,e,t,n,i,o)},dcnpgettext:function(e,t,i,o,s){o=o||i,e=e||this._textdomain,s="undefined"==typeof s?1:s;var r;if(!this.options)return r=new d,r.dcnpgettext.call(r,void 0,void 0,i,o,s);if(!this.options.locale_data)throw new Error("No locale data provided.");if(!this.options.locale_data[e])throw new Error("Domain `"+e+"` was not found.");if(!this.options.locale_data[e][""])throw new Error("No locale meta information provided.");if(!i)throw new Error("No translation key found.");if("number"!=typeof s&&(s=parseInt(s,10),isNaN(s)))throw new Error("The number that was passed in is not a number.");var a,l,c=t?t+d.context_delimiter+i:i,u=this.options.locale_data,h=u[e],p=h[""].plural_forms||(u.messages||this.defaults.locale_data.messages)[""].plural_forms,_=n(p)(s)+1;if(!h)throw new Error("No domain named `"+e+"` could be found.");return a=h[c],!a||_>=a.length?(this.options.missing_key_callback&&this.options.missing_key_callback(c),l=[null,i,o],l[n(p)(s)+1]):(l=a[_],l?l:(l=[null,i,o],l[n(p)(s)+1]))}});var h=function(){function e(e){return Object.prototype.toString.call(e).slice(8,-1).toLowerCase()}function t(e,t){for(var n=[];t>0;n[--t]=e);return n.join("")}var n=function(){return n.cache.hasOwnProperty(arguments[0])||(n.cache[arguments[0]]=n.parse(arguments[0])),n.format.call(null,n.cache[arguments[0]],arguments)};return n.format=function(n,i){var o,s,r,a,l,c,u,d=1,p=n.length,_="",m=[];for(s=0;s<p;s++)if(_=e(n[s]),"string"===_)m.push(n[s]);else if("array"===_){if(a=n[s],a[2])for(o=i[d],r=0;r<a[2].length;r++){if(!o.hasOwnProperty(a[2][r]))throw h('[sprintf] property "%s" does not exist',a[2][r]);o=o[a[2][r]]}else o=a[1]?i[a[1]]:i[d++];if(/[^s]/.test(a[8])&&"number"!=e(o))throw h("[sprintf] expecting number but found %s",e(o));switch("undefined"!=typeof o&&null!==o||(o=""),a[8]){case"b":o=o.toString(2);break;case"c":o=String.fromCharCode(o);break;case"d":o=parseInt(o,10);break;case"e":o=a[7]?o.toExponential(a[7]):o.toExponential();break;case"f":o=a[7]?parseFloat(o).toFixed(a[7]):parseFloat(o);break;case"o":o=o.toString(8);break;case"s":o=(o=String(o))&&a[7]?o.substring(0,a[7]):o;break;case"u":o=Math.abs(o);break;case"x":o=o.toString(16);break;case"X":o=o.toString(16).toUpperCase()}o=/[def]/.test(a[8])&&a[3]&&o>=0?"+"+o:o,c=a[4]?"0"==a[4]?"0":a[4].charAt(1):" ",u=a[6]-String(o).length,l=a[6]?t(c,u):"",m.push(a[5]?o+l:l+o)}return m.join("")},n.cache={},n.parse=function(e){for(var t=e,n=[],i=[],o=0;t;){if(null!==(n=/^[^\x25]+/.exec(t)))i.push(n[0]);else if(null!==(n=/^\x25{2}/.exec(t)))i.push("%");else{if(null===(n=/^\x25(?:([1-9]\d*)\$|\(([^\)]+)\))?(\+)?(0|'[^$])?(-)?(\d+)?(?:\.(\d+))?([b-fosuxX])/.exec(t)))throw"[sprintf] huh?";if(n[2]){o|=1;var s=[],r=n[2],a=[];if(null===(a=/^([a-z_][a-z_\d]*)/i.exec(r)))throw"[sprintf] huh?";for(s.push(a[1]);""!==(r=r.substring(a[0].length));)if(null!==(a=/^\.([a-z_][a-z_\d]*)/i.exec(r)))s.push(a[1]);else{if(null===(a=/^\[(\d+)\]/.exec(r)))throw"[sprintf] huh?";s.push(a[1])}n[2]=s}else o|=2;if(3===o)throw"[sprintf] mixing positional and named placeholders is not (yet) supported";i.push(n)}t=t.substring(n[0].length)}return i},n}(),p=function(e,t){return t.unshift(e),h.apply(null,t)};d.parse_plural=function(e,t){return e=e.replace(/n/g,t),d.parse_expression(e)},d.sprintf=function(e,t){return"[object Array]"=={}.toString.call(t)?p(e,[].slice.call(t)):h.apply(this,[].slice.call(arguments))},d.prototype.sprintf=function(){return d.sprintf.apply(this,arguments)},d.PF={},d.PF.parse=function(e){var t=d.PF.extractPluralExpr(e);return d.PF.parser.parse.call(d.PF.parser,t)},d.PF.compile=function(e){function t(e){return e===!0?1:e?e:0}var n=d.PF.parse(e);return function(e){return t(d.PF.interpreter(n)(e))}},d.PF.interpreter=function(e){return function(t){switch(e.type){case"GROUP":return d.PF.interpreter(e.expr)(t);case"TERNARY":return d.PF.interpreter(e.expr)(t)?d.PF.interpreter(e.truthy)(t):d.PF.interpreter(e.falsey)(t);case"OR":return d.PF.interpreter(e.left)(t)||d.PF.interpreter(e.right)(t);case"AND":return d.PF.interpreter(e.left)(t)&&d.PF.interpreter(e.right)(t);case"LT":return d.PF.interpreter(e.left)(t)<d.PF.interpreter(e.right)(t);case"GT":return d.PF.interpreter(e.left)(t)>d.PF.interpreter(e.right)(t);case"LTE":return d.PF.interpreter(e.left)(t)<=d.PF.interpreter(e.right)(t);case"GTE":return d.PF.interpreter(e.left)(t)>=d.PF.interpreter(e.right)(t);case"EQ":return d.PF.interpreter(e.left)(t)==d.PF.interpreter(e.right)(t);case"NEQ":return d.PF.interpreter(e.left)(t)!=d.PF.interpreter(e.right)(t);case"MOD":return d.PF.interpreter(e.left)(t)%d.PF.interpreter(e.right)(t);case"VAR":return t;case"NUM":return e.val;default:throw new Error("Invalid Token found.")}}},d.PF.extractPluralExpr=function(e){e=e.replace(/^\s\s*/,"").replace(/\s\s*$/,""),/;\s*$/.test(e)||(e=e.concat(";"));var t,n=/nplurals\=(\d+);/,i=/plural\=(.*);/,o=e.match(n),s={};if(!(o.length>1))throw new Error("nplurals not found in plural_forms string: "+e);if(s.nplurals=o[1],e=e.replace(n,""),t=e.match(i),!(t&&t.length>1))throw new Error("`plural` expression not found: "+e);return t[1]},d.PF.parser=function(){var e={trace:function(){},yy:{},symbols_:{error:2,expressions:3,e:4,EOF:5,"?":6,":":7,"||":8,"&&":9,"<":10,"<=":11,">":12,">=":13,"!=":14,"==":15,"%":16,"(":17,")":18,n:19,NUMBER:20,$accept:0,$end:1},terminals_:{2:"error",5:"EOF",6:"?",7:":",8:"||",9:"&&",10:"<",11:"<=",12:">",13:">=",14:"!=",15:"==",16:"%",17:"(",18:")",19:"n",20:"NUMBER"},productions_:[0,[3,2],[4,5],[4,3],[4,3],[4,3],[4,3],[4,3],[4,3],[4,3],[4,3],[4,3],[4,3],[4,1],[4,1]],performAction:function(e,t,n,i,o,s,r){var a=s.length-1;switch(o){case 1:return{type:"GROUP",expr:s[a-1]};case 2:this.$={type:"TERNARY",expr:s[a-4],truthy:s[a-2],falsey:s[a]};break;case 3:this.$={type:"OR",left:s[a-2],right:s[a]};break;case 4:this.$={type:"AND",left:s[a-2],right:s[a]};break;case 5:this.$={type:"LT",left:s[a-2],right:s[a]};break;case 6:this.$={type:"LTE",left:s[a-2],right:s[a]};break;case 7:this.$={type:"GT",left:s[a-2],right:s[a]};break;case 8:this.$={type:"GTE",left:s[a-2],right:s[a]};break;case 9:this.$={type:"NEQ",left:s[a-2],right:s[a]};break;case 10:this.$={type:"EQ",left:s[a-2],right:s[a]};break;case 11:this.$={type:"MOD",left:s[a-2],right:s[a]};break;case 12:this.$={type:"GROUP",expr:s[a-1]};break;case 13:this.$={type:"VAR"};break;case 14:this.$={type:"NUM",val:Number(e)}}},table:[{3:1,4:2,17:[1,3],19:[1,4],20:[1,5]},{1:[3]},{5:[1,6],6:[1,7],8:[1,8],9:[1,9],10:[1,10],11:[1,11],12:[1,12],13:[1,13],14:[1,14],15:[1,15],16:[1,16]},{4:17,17:[1,3],19:[1,4],20:[1,5]},{5:[2,13],6:[2,13],7:[2,13],8:[2,13],9:[2,13],10:[2,13],11:[2,13],12:[2,13],13:[2,13],14:[2,13],15:[2,13],16:[2,13],18:[2,13]},{5:[2,14],6:[2,14],7:[2,14],8:[2,14],9:[2,14],10:[2,14],11:[2,14],12:[2,14],13:[2,14],14:[2,14],15:[2,14],16:[2,14],18:[2,14]},{1:[2,1]},{4:18,17:[1,3],19:[1,4],20:[1,5]},{4:19,17:[1,3],19:[1,4],20:[1,5]},{4:20,17:[1,3],19:[1,4],20:[1,5]},{4:21,17:[1,3],19:[1,4],20:[1,5]},{4:22,17:[1,3],19:[1,4],20:[1,5]},{4:23,17:[1,3],19:[1,4],20:[1,5]},{4:24,17:[1,3],19:[1,4],20:[1,5]},{4:25,17:[1,3],19:[1,4],20:[1,5]},{4:26,17:[1,3],19:[1,4],20:[1,5]},{4:27,17:[1,3],19:[1,4],20:[1,5]},{6:[1,7],8:[1,8],9:[1,9],10:[1,10],11:[1,11],12:[1,12],13:[1,13],14:[1,14],15:[1,15],16:[1,16],18:[1,28]},{6:[1,7],7:[1,29],8:[1,8],9:[1,9],10:[1,10],11:[1,11],12:[1,12],13:[1,13],14:[1,14],15:[1,15],16:[1,16]},{5:[2,3],6:[2,3],7:[2,3],8:[2,3],9:[1,9],10:[1,10],11:[1,11],12:[1,12],13:[1,13],14:[1,14],
15:[1,15],16:[1,16],18:[2,3]},{5:[2,4],6:[2,4],7:[2,4],8:[2,4],9:[2,4],10:[1,10],11:[1,11],12:[1,12],13:[1,13],14:[1,14],15:[1,15],16:[1,16],18:[2,4]},{5:[2,5],6:[2,5],7:[2,5],8:[2,5],9:[2,5],10:[2,5],11:[2,5],12:[2,5],13:[2,5],14:[2,5],15:[2,5],16:[1,16],18:[2,5]},{5:[2,6],6:[2,6],7:[2,6],8:[2,6],9:[2,6],10:[2,6],11:[2,6],12:[2,6],13:[2,6],14:[2,6],15:[2,6],16:[1,16],18:[2,6]},{5:[2,7],6:[2,7],7:[2,7],8:[2,7],9:[2,7],10:[2,7],11:[2,7],12:[2,7],13:[2,7],14:[2,7],15:[2,7],16:[1,16],18:[2,7]},{5:[2,8],6:[2,8],7:[2,8],8:[2,8],9:[2,8],10:[2,8],11:[2,8],12:[2,8],13:[2,8],14:[2,8],15:[2,8],16:[1,16],18:[2,8]},{5:[2,9],6:[2,9],7:[2,9],8:[2,9],9:[2,9],10:[2,9],11:[2,9],12:[2,9],13:[2,9],14:[2,9],15:[2,9],16:[1,16],18:[2,9]},{5:[2,10],6:[2,10],7:[2,10],8:[2,10],9:[2,10],10:[2,10],11:[2,10],12:[2,10],13:[2,10],14:[2,10],15:[2,10],16:[1,16],18:[2,10]},{5:[2,11],6:[2,11],7:[2,11],8:[2,11],9:[2,11],10:[2,11],11:[2,11],12:[2,11],13:[2,11],14:[2,11],15:[2,11],16:[2,11],18:[2,11]},{5:[2,12],6:[2,12],7:[2,12],8:[2,12],9:[2,12],10:[2,12],11:[2,12],12:[2,12],13:[2,12],14:[2,12],15:[2,12],16:[2,12],18:[2,12]},{4:30,17:[1,3],19:[1,4],20:[1,5]},{5:[2,2],6:[1,7],7:[2,2],8:[1,8],9:[1,9],10:[1,10],11:[1,11],12:[1,12],13:[1,13],14:[1,14],15:[1,15],16:[1,16],18:[2,2]}],defaultActions:{6:[2,1]},parseError:function(e,t){throw new Error(e)},parse:function(e){function t(e){o.length=o.length-2*e,s.length=s.length-e,r.length=r.length-e}function n(){var e;return e=i.lexer.lex()||1,"number"!=typeof e&&(e=i.symbols_[e]||e),e}var i=this,o=[0],s=[null],r=[],a=this.table,l="",c=0,u=0,d=0,h=2,p=1;this.lexer.setInput(e),this.lexer.yy=this.yy,this.yy.lexer=this.lexer,"undefined"==typeof this.lexer.yylloc&&(this.lexer.yylloc={});var _=this.lexer.yylloc;r.push(_),"function"==typeof this.yy.parseError&&(this.parseError=this.yy.parseError);for(var m,f,g,v,b,y,w,x,C,S={};;){if(g=o[o.length-1],this.defaultActions[g]?v=this.defaultActions[g]:(null==m&&(m=n()),v=a[g]&&a[g][m]),"undefined"==typeof v||!v.length||!v[0]){if(!d){C=[];for(y in a[g])this.terminals_[y]&&y>2&&C.push("'"+this.terminals_[y]+"'");var k="";k=this.lexer.showPosition?"Parse error on line "+(c+1)+":\n"+this.lexer.showPosition()+"\nExpecting "+C.join(", ")+", got '"+this.terminals_[m]+"'":"Parse error on line "+(c+1)+": Unexpected "+(1==m?"end of input":"'"+(this.terminals_[m]||m)+"'"),this.parseError(k,{text:this.lexer.match,token:this.terminals_[m]||m,line:this.lexer.yylineno,loc:_,expected:C})}if(3==d){if(m==p)throw new Error(k||"Parsing halted.");u=this.lexer.yyleng,l=this.lexer.yytext,c=this.lexer.yylineno,_=this.lexer.yylloc,m=n()}for(;;){if(h.toString()in a[g])break;if(0==g)throw new Error(k||"Parsing halted.");t(1),g=o[o.length-1]}f=m,m=h,g=o[o.length-1],v=a[g]&&a[g][h],d=3}if(v[0]instanceof Array&&v.length>1)throw new Error("Parse Error: multiple actions possible at state: "+g+", token: "+m);switch(v[0]){case 1:o.push(m),s.push(this.lexer.yytext),r.push(this.lexer.yylloc),o.push(v[1]),m=null,f?(m=f,f=null):(u=this.lexer.yyleng,l=this.lexer.yytext,c=this.lexer.yylineno,_=this.lexer.yylloc,d>0&&d--);break;case 2:if(w=this.productions_[v[1]][1],S.$=s[s.length-w],S._$={first_line:r[r.length-(w||1)].first_line,last_line:r[r.length-1].last_line,first_column:r[r.length-(w||1)].first_column,last_column:r[r.length-1].last_column},b=this.performAction.call(S,l,u,c,this.yy,v[1],s,r),"undefined"!=typeof b)return b;w&&(o=o.slice(0,-1*w*2),s=s.slice(0,-1*w),r=r.slice(0,-1*w)),o.push(this.productions_[v[1]][0]),s.push(S.$),r.push(S._$),x=a[o[o.length-2]][o[o.length-1]],o.push(x);break;case 3:return!0}}return!0}},t=function(){var e={EOF:1,parseError:function(e,t){if(!this.yy.parseError)throw new Error(e);this.yy.parseError(e,t)},setInput:function(e){return this._input=e,this._more=this._less=this.done=!1,this.yylineno=this.yyleng=0,this.yytext=this.matched=this.match="",this.conditionStack=["INITIAL"],this.yylloc={first_line:1,first_column:0,last_line:1,last_column:0},this},input:function(){var e=this._input[0];this.yytext+=e,this.yyleng++,this.match+=e,this.matched+=e;var t=e.match(/\n/);return t&&this.yylineno++,this._input=this._input.slice(1),e},unput:function(e){return this._input=e+this._input,this},more:function(){return this._more=!0,this},pastInput:function(){var e=this.matched.substr(0,this.matched.length-this.match.length);return(e.length>20?"...":"")+e.substr(-20).replace(/\n/g,"")},upcomingInput:function(){var e=this.match;return e.length<20&&(e+=this._input.substr(0,20-e.length)),(e.substr(0,20)+(e.length>20?"...":"")).replace(/\n/g,"")},showPosition:function(){var e=this.pastInput(),t=new Array(e.length+1).join("-");return e+this.upcomingInput()+"\n"+t+"^"},next:function(){if(this.done)return this.EOF;this._input||(this.done=!0);var e,t,n;this._more||(this.yytext="",this.match="");for(var i=this._currentRules(),o=0;o<i.length;o++)if(t=this._input.match(this.rules[i[o]]))return n=t[0].match(/\n.*/g),n&&(this.yylineno+=n.length),this.yylloc={first_line:this.yylloc.last_line,last_line:this.yylineno+1,first_column:this.yylloc.last_column,last_column:n?n[n.length-1].length-1:this.yylloc.last_column+t[0].length},this.yytext+=t[0],this.match+=t[0],this.matches=t,this.yyleng=this.yytext.length,this._more=!1,this._input=this._input.slice(t[0].length),this.matched+=t[0],e=this.performAction.call(this,this.yy,this,i[o],this.conditionStack[this.conditionStack.length-1]),e?e:void 0;return""===this._input?this.EOF:void this.parseError("Lexical error on line "+(this.yylineno+1)+". Unrecognized text.\n"+this.showPosition(),{text:"",token:null,line:this.yylineno})},lex:function(){var e=this.next();return"undefined"!=typeof e?e:this.lex()},begin:function(e){this.conditionStack.push(e)},popState:function(){return this.conditionStack.pop()},_currentRules:function(){return this.conditions[this.conditionStack[this.conditionStack.length-1]].rules},topState:function(){return this.conditionStack[this.conditionStack.length-2]},pushState:function(e){this.begin(e)}};return e.performAction=function(e,t,n,i){switch(n){case 0:break;case 1:return 20;case 2:return 19;case 3:return 8;case 4:return 9;case 5:return 6;case 6:return 7;case 7:return 11;case 8:return 13;case 9:return 10;case 10:return 12;case 11:return 14;case 12:return 15;case 13:return 16;case 14:return 17;case 15:return 18;case 16:return 5;case 17:return"INVALID"}},e.rules=[/^\s+/,/^[0-9]+(\.[0-9]+)?\b/,/^n\b/,/^\|\|/,/^&&/,/^\?/,/^:/,/^<=/,/^>=/,/^</,/^>/,/^!=/,/^==/,/^%/,/^\(/,/^\)/,/^$/,/^./],e.conditions={INITIAL:{rules:[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17],inclusive:!0}},e}();return e.lexer=t,e}(),"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=d),exports.Jed=d):("function"==typeof define&&define.amd&&define("jed",[],function(){return d}),e.Jed=d)}(this),define("text",["module"],function(e){"use strict";function t(e,t){return void 0===e||""===e?t:e}function n(e,n,i,o){if(n===o)return!0;if(e===i){if("http"===e)return t(n,"80")===t(o,"80");if("https"===e)return t(n,"443")===t(o,"443")}return!1}var i,o,s,r,a,l=["Msxml2.XMLHTTP","Microsoft.XMLHTTP","Msxml2.XMLHTTP.4.0"],c=/^\s*<\?xml(\s)+version=[\'\"](\d)*.(\d)*[\'\"](\s)*\?>/im,u=/<body[^>]*>\s*([\s\S]+)\s*<\/body>/im,d="undefined"!=typeof location&&location.href,h=d&&location.protocol&&location.protocol.replace(/\:/,""),p=d&&location.hostname,_=d&&(location.port||void 0),m={},f=e.config&&e.config()||{};return i={version:"2.0.15",strip:function(e){if(e){e=e.replace(c,"");var t=e.match(u);t&&(e=t[1])}else e="";return e},jsEscape:function(e){return e.replace(/(['\\])/g,"\\$1").replace(/[\f]/g,"\\f").replace(/[\b]/g,"\\b").replace(/[\n]/g,"\\n").replace(/[\t]/g,"\\t").replace(/[\r]/g,"\\r").replace(/[\u2028]/g,"\\u2028").replace(/[\u2029]/g,"\\u2029")},createXhr:f.createXhr||function(){var e,t,n;if("undefined"!=typeof XMLHttpRequest)return new XMLHttpRequest;if("undefined"!=typeof ActiveXObject)for(t=0;t<3;t+=1){n=l[t];try{e=new ActiveXObject(n)}catch(e){}if(e){l=[n];break}}return e},parseName:function(e){var t,n,i,o=!1,s=e.lastIndexOf("."),r=0===e.indexOf("./")||0===e.indexOf("../");return s!==-1&&(!r||s>1)?(t=e.substring(0,s),n=e.substring(s+1)):t=e,i=n||t,s=i.indexOf("!"),s!==-1&&(o="strip"===i.substring(s+1),i=i.substring(0,s),n?n=i:t=i),{moduleName:t,ext:n,strip:o}},xdRegExp:/^((\w+)\:)?\/\/([^\/\\]+)/,useXhr:function(e,t,o,s){var r,a,l,c=i.xdRegExp.exec(e);return!c||(r=c[2],a=c[3],a=a.split(":"),l=a[1],a=a[0],(!r||r===t)&&(!a||a.toLowerCase()===o.toLowerCase())&&(!l&&!a||n(r,l,t,s)))},finishLoad:function(e,t,n,o){n=t?i.strip(n):n,f.isBuild&&(m[e]=n),o(n)},load:function(e,t,n,o){if(o&&o.isBuild&&!o.inlineText)return void n();f.isBuild=o&&o.isBuild;var s=i.parseName(e),r=s.moduleName+(s.ext?"."+s.ext:""),a=t.toUrl(r),l=f.useXhr||i.useXhr;return 0===a.indexOf("empty:")?void n():void(!d||l(a,h,p,_)?i.get(a,function(t){i.finishLoad(e,s.strip,t,n)},function(e){n.error&&n.error(e)}):t([r],function(e){i.finishLoad(s.moduleName+"."+s.ext,s.strip,e,n)}))},write:function(e,t,n,o){if(m.hasOwnProperty(t)){var s=i.jsEscape(m[t]);n.asModule(e+"!"+t,"define(function () { return '"+s+"';});\n")}},writeFile:function(e,t,n,o,s){var r=i.parseName(t),a=r.ext?"."+r.ext:"",l=r.moduleName+a,c=n.toUrl(r.moduleName+a)+".js";i.load(l,n,function(t){var n=function(e){return o(c,e)};n.asModule=function(e,t){return o.asModule(e,c,t)},i.write(e,l,n,s)},s)}},"node"===f.env||!f.env&&"undefined"!=typeof process&&process.versions&&process.versions.node&&!process.versions["node-webkit"]&&!process.versions["atom-shell"]?(o=require.nodeRequire("fs"),i.get=function(e,t,n){try{var i=o.readFileSync(e,"utf8");"\ufeff"===i[0]&&(i=i.substring(1)),t(i)}catch(e){n&&n(e)}}):"xhr"===f.env||!f.env&&i.createXhr()?i.get=function(e,t,n,o){var s,r=i.createXhr();if(r.open("GET",e,!0),o)for(s in o)o.hasOwnProperty(s)&&r.setRequestHeader(s.toLowerCase(),o[s]);f.onXhr&&f.onXhr(r,e),r.onreadystatechange=function(i){var o,s;4===r.readyState&&(o=r.status||0,o>399&&o<600?(s=new Error(e+" HTTP status: "+o),s.xhr=r,n&&n(s)):t(r.responseText),f.onXhrComplete&&f.onXhrComplete(r,e))},r.send(null)}:"rhino"===f.env||!f.env&&"undefined"!=typeof Packages&&"undefined"!=typeof java?i.get=function(e,t){var n,i,o="utf-8",s=new java.io.File(e),r=java.lang.System.getProperty("line.separator"),a=new java.io.BufferedReader(new java.io.InputStreamReader(new java.io.FileInputStream(s),o)),l="";try{for(n=new java.lang.StringBuffer,i=a.readLine(),i&&i.length()&&65279===i.charAt(0)&&(i=i.substring(1)),null!==i&&n.append(i);null!==(i=a.readLine());)n.append(r),n.append(i);l=String(n.toString())}finally{a.close()}t(l)}:("xpconnect"===f.env||!f.env&&"undefined"!=typeof Components&&Components.classes&&Components.interfaces)&&(s=Components.classes,r=Components.interfaces,Components.utils.import("resource://gre/modules/FileUtils.jsm"),a="@mozilla.org/windows-registry-key;1"in s,i.get=function(e,t){var n,i,o,l={};a&&(e=e.replace(/\//g,"\\")),o=new FileUtils.File(e);try{n=s["@mozilla.org/network/file-input-stream;1"].createInstance(r.nsIFileInputStream),n.init(o,1,0,!1),i=s["@mozilla.org/intl/converter-input-stream;1"].createInstance(r.nsIConverterInputStream),i.init(n,"utf-8",n.available(),r.nsIConverterInputStream.DEFAULT_REPLACEMENT_CHARACTER),i.readString(n.available(),l),i.close(),n.close(),t(l.value)}catch(e){throw new Error((o&&o.path||"")+": "+e)}}),i}),define("text!ca",[],function(){return'{\n   "domain": "converse",\n   "locale_data": {\n      "converse": {\n         "": {\n            "domain": "converse",\n            "plural_forms": "nplurals=2; plural=(n != 1);",\n            "lang": "ca"\n         },\n         "Bookmark this room": [\n            null,\n            ""\n         ],\n         "The name for this bookmark:": [\n            null,\n            ""\n         ],\n         "Would you like this room to be automatically joined upon startup?": [\n            null,\n            ""\n         ],\n         "What should your nickname for this room be?": [\n            null,\n            ""\n         ],\n         "Save": [\n            null,\n            "Desa"\n         ],\n         "Cancel": [\n            null,\n            "Cancel·la"\n         ],\n         "Bookmarked Rooms": [\n            null,\n            ""\n         ],\n         "Click to open this room": [\n            null,\n            "Feu clic per obrir aquesta sala"\n         ],\n         "Show more information on this room": [\n            null,\n            "Mostra més informació d\'aquesta sala"\n         ],\n         "Remove this bookmark": [\n            null,\n            ""\n         ],\n         "Close this chat box": [\n            null,\n            "Tanca aquest quadre del xat"\n         ],\n         "Personal message": [\n            null,\n            "Missatge personal"\n         ],\n         "me": [\n            null,\n            "jo"\n         ],\n         "A very large message has been received.This might be due to an attack meant to degrade the chat performance.Output has been shortened.": [\n            null,\n            ""\n         ],\n         "Typing from another device": [\n            null,\n            ""\n         ],\n         "is typing": [\n            null,\n            "està escrivint"\n         ],\n         "Stopped typing on the other device": [\n            null,\n            ""\n         ],\n         "has stopped typing": [\n            null,\n            "ha deixat d\'escriure"\n         ],\n         "has gone away": [\n            null,\n            "ha marxat"\n         ],\n         "Show this menu": [\n            null,\n            "Mostra aquest menú"\n         ],\n         "Write in the third person": [\n            null,\n            "Escriu en tercera persona"\n         ],\n         "Remove messages": [\n            null,\n            "Elimina els missatges"\n         ],\n         "Are you sure you want to clear the messages from this chat box?": [\n            null,\n            "Segur que voleu esborrar els missatges d\'aquest quadre del xat?"\n         ],\n         "has gone offline": [\n            null,\n            "s\'ha desconnectat"\n         ],\n         "is busy": [\n            null,\n            "està ocupat"\n         ],\n         "Clear all messages": [\n            null,\n            "Esborra tots els missatges"\n         ],\n         "Insert a smiley": [\n            null,\n            "Insereix una cara somrient"\n         ],\n         "Start a call": [\n            null,\n            "Inicia una trucada"\n         ],\n         "Contacts": [\n            null,\n            "Contactes"\n         ],\n         "XMPP Username:": [\n            null,\n            "Nom d\'usuari XMPP:"\n         ],\n         "Password:": [\n            null,\n            "Contrasenya:"\n         ],\n         "Click here to log in anonymously": [\n            null,\n            "Feu clic aquí per iniciar la sessió de manera anònima"\n         ],\n         "Log In": [\n            null,\n            "Inicia la sessió"\n         ],\n         "user@server": [\n            null,\n            "usuari@servidor"\n         ],\n         "password": [\n            null,\n            "contrasenya"\n         ],\n         "Sign in": [\n            null,\n            "Inicia la sessió"\n         ],\n         "I am %1$s": [\n            null,\n            "Estic %1$s"\n         ],\n         "Click here to write a custom status message": [\n            null,\n            "Feu clic aquí per escriure un missatge d\'estat personalitzat"\n         ],\n         "Click to change your chat status": [\n            null,\n            "Feu clic per canviar l\'estat del xat"\n         ],\n         "Custom status": [\n            null,\n            "Estat personalitzat"\n         ],\n         "online": [\n            null,\n            "en línia"\n         ],\n         "busy": [\n            null,\n            "ocupat"\n         ],\n         "away for long": [\n            null,\n            "absent durant una estona"\n         ],\n         "away": [\n            null,\n            "absent"\n         ],\n         "offline": [\n            null,\n            "desconnectat"\n         ],\n         "Online": [\n            null,\n            "En línia"\n         ],\n         "Busy": [\n            null,\n            "Ocupat"\n         ],\n         "Away": [\n            null,\n            "Absent"\n         ],\n         "Offline": [\n            null,\n            "Desconnectat"\n         ],\n         "Log out": [\n            null,\n            "Tanca la sessió"\n         ],\n         "Contact name": [\n            null,\n            "Nom del contacte"\n         ],\n         "Search": [\n            null,\n            "Cerca"\n         ],\n         "Add": [\n            null,\n            "Afegeix"\n         ],\n         "Click to add new chat contacts": [\n            null,\n            "Feu clic per afegir contactes nous al xat"\n         ],\n         "Add a contact": [\n            null,\n            "Afegeix un contacte"\n         ],\n         "No users found": [\n            null,\n            "No s\'ha trobat cap usuari"\n         ],\n         "Click to add as a chat contact": [\n            null,\n            "Feu clic per afegir com a contacte del xat"\n         ],\n         "Toggle chat": [\n            null,\n            "Canvia de xat"\n         ],\n         "Click to hide these contacts": [\n            null,\n            "Feu clic per amagar aquests contactes"\n         ],\n         "The connection has dropped, attempting to reconnect.": [\n            null,\n            ""\n         ],\n         "Connecting": [\n            null,\n            "S\'està establint la connexió"\n         ],\n         "Authenticating": [\n            null,\n            "S\'està efectuant l\'autenticació"\n         ],\n         "Authentication Failed": [\n            null,\n            "Error d\'autenticació"\n         ],\n         "Sorry, there was an error while trying to add ": [\n            null,\n            "S\'ha produït un error en intentar afegir "\n         ],\n         "This client does not allow presence subscriptions": [\n            null,\n            "Aquest client no admet les subscripcions de presència"\n         ],\n         "Minimize this chat box": [\n            null,\n            "Minimitza aquest quadre del xat"\n         ],\n         "Click to restore this chat": [\n            null,\n            "Feu clic per restaurar aquest xat"\n         ],\n         "Minimized": [\n            null,\n            "Minimitzat"\n         ],\n         "This room is not anonymous": [\n            null,\n            "Aquesta sala no és anònima"\n         ],\n         "This room now shows unavailable members": [\n            null,\n            "Aquesta sala ara mostra membres no disponibles"\n         ],\n         "This room does not show unavailable members": [\n            null,\n            "Aquesta sala no mostra membres no disponibles"\n         ],\n         "Room logging is now enabled": [\n            null,\n            "El registre de la sala està habilitat"\n         ],\n         "Room logging is now disabled": [\n            null,\n            "El registre de la sala està deshabilitat"\n         ],\n         "This room is now semi-anonymous": [\n            null,\n            "Aquesta sala ara és parcialment anònima"\n         ],\n         "This room is now fully-anonymous": [\n            null,\n            "Aquesta sala ara és totalment anònima"\n         ],\n         "A new room has been created": [\n            null,\n            "S\'ha creat una sala nova"\n         ],\n         "You have been banned from this room": [\n            null,\n            "Se us ha expulsat d\'aquesta sala"\n         ],\n         "You have been kicked from this room": [\n            null,\n            "Se us ha expulsat d\'aquesta sala"\n         ],\n         "You have been removed from this room because of an affiliation change": [\n            null,\n            "Se us ha eliminat d\'aquesta sala a causa d\'un canvi d\'afiliació"\n         ],\n         "You have been removed from this room because the room has changed to members-only and you\'re not a member": [\n            null,\n            "Se us ha eliminat d\'aquesta sala perquè ara només permet membres i no en sou membre"\n         ],\n         "You have been removed from this room because the MUC (Multi-user chat) service is being shut down.": [\n            null,\n            "Se us ha eliminat d\'aquesta sala perquè s\'està tancant el servei MUC (xat multiusuari)."\n         ],\n         "Message": [\n            null,\n            "Missatge"\n         ],\n         "Hide the list of occupants": [\n            null,\n            "Amaga la llista d\'ocupants"\n         ],\n         "Error: the \\"": [\n            null,\n            "Error: el \\""\n         ],\n         "Are you sure you want to clear the messages from this room?": [\n            null,\n            "Segur que voleu esborrar els missatges d\'aquesta sala?"\n         ],\n         "Error: could not execute the command": [\n            null,\n            "Error: no s\'ha pogut executar l\'ordre"\n         ],\n         "Change user\'s affiliation to admin": [\n            null,\n            "Canvia l\'afiliació de l\'usuari a administrador"\n         ],\n         "Ban user from room": [\n            null,\n            "Expulsa l\'usuari de la sala"\n         ],\n         "Change user role to occupant": [\n            null,\n            "Canvia el rol de l\'usuari a ocupant"\n         ],\n         "Kick user from room": [\n            null,\n            "Expulsa l\'usuari de la sala"\n         ],\n         "Write in 3rd person": [\n            null,\n            "Escriu en tercera persona"\n         ],\n         "Grant membership to a user": [\n            null,\n            "Atorga una afiliació a un usuari"\n         ],\n         "Remove user\'s ability to post messages": [\n            null,\n            "Elimina la capacitat de l\'usuari de publicar missatges"\n         ],\n         "Change your nickname": [\n            null,\n            "Canvieu el vostre àlies"\n         ],\n         "Grant moderator role to user": [\n            null,\n            "Atorga el rol de moderador a l\'usuari"\n         ],\n         "Grant ownership of this room": [\n            null,\n            "Atorga la propietat d\'aquesta sala"\n         ],\n         "Revoke user\'s membership": [\n            null,\n            "Revoca l\'afiliació de l\'usuari"\n         ],\n         "Set room subject (alias for /subject)": [\n            null,\n            ""\n         ],\n         "Allow muted user to post messages": [\n            null,\n            "Permet que un usuari silenciat publiqui missatges"\n         ],\n         "The nickname you chose is reserved or currently in use, please choose a different one.": [\n            null,\n            ""\n         ],\n         "Nickname": [\n            null,\n            "Àlies"\n         ],\n         "This chatroom requires a password": [\n            null,\n            "Aquesta sala de xat requereix una contrasenya"\n         ],\n         "Password: ": [\n            null,\n            "Contrasenya:"\n         ],\n         "Submit": [\n            null,\n            "Envia"\n         ],\n         "The reason given is: \\"": [\n            null,\n            "El motiu indicat és: \\""\n         ],\n         " has left the room. \\"": [\n            null,\n            ""\n         ],\n         " has joined the room. \\"": [\n            null,\n            ""\n         ],\n         " has joined the room.": [\n            null,\n            ""\n         ],\n         "You are not on the member list of this room": [\n            null,\n            "No sou a la llista de membres d\'aquesta sala"\n         ],\n         "No nickname was specified": [\n            null,\n            "No s\'ha especificat cap àlies"\n         ],\n         "You are not allowed to create new rooms": [\n            null,\n            "No teniu permís per crear sales noves"\n         ],\n         "Your nickname doesn\'t conform to this room\'s policies": [\n            null,\n            "El vostre àlies no s\'ajusta a les polítiques d\'aquesta sala"\n         ],\n         "This room does not (yet) exist": [\n            null,\n            "Aquesta sala (encara) no existeix"\n         ],\n         "Topic set by %1$s to: %2$s": [\n            null,\n            "Tema definit per %1$s en: %2$s"\n         ],\n         "Occupants": [\n            null,\n            "Ocupants"\n         ],\n         "Hidden": [\n            null,\n            "Amagat"\n         ],\n         "Message archiving": [\n            null,\n            ""\n         ],\n         "Members only": [\n            null,\n            ""\n         ],\n         "Moderated": [\n            null,\n            "Moderada"\n         ],\n         "Non-anonymous": [\n            null,\n            "No és anònima"\n         ],\n         "Persistent": [\n            null,\n            ""\n         ],\n         "Public": [\n            null,\n            "Pública"\n         ],\n         "Semi-anonymous": [\n            null,\n            "Semianònima"\n         ],\n         "Unmoderated": [\n            null,\n            "No moderada"\n         ],\n         "Unsecured": [\n            null,\n            ""\n         ],\n         "Messages are archived on the server": [\n            null,\n            ""\n         ],\n         "All other room occupants can see your Jabber ID": [\n            null,\n            ""\n         ],\n         "This room persists even if it\'s unoccupied": [\n            null,\n            ""\n         ],\n         "Only moderators can see your Jabber ID": [\n            null,\n            ""\n         ],\n         "This room will disappear once the last person leaves": [\n            null,\n            ""\n         ],\n         "You are about to invite %1$s to the chat room \\"%2$s\\". ": [\n            null,\n            "Esteu a punt de convidar %1$s a la sala de xat \\"%2$s\\". "\n         ],\n         "You may optionally include a message, explaining the reason for the invitation.": [\n            null,\n            "Teniu l\'opció d\'incloure un missatge per explicar el motiu de la invitació."\n         ],\n         "Room name": [\n            null,\n            "Nom de la sala"\n         ],\n         "Server": [\n            null,\n            "Servidor"\n         ],\n         "Join Room": [\n            null,\n            "Uneix-me a la sala"\n         ],\n         "Show rooms": [\n            null,\n            "Mostra les sales"\n         ],\n         "Rooms": [\n            null,\n            "Sales"\n         ],\n         "No rooms on %1$s": [\n            null,\n            "No hi ha cap sala a %1$s"\n         ],\n         "Rooms on %1$s": [\n            null,\n            "Sales a %1$s"\n         ],\n         "Description:": [\n            null,\n            "Descripció:"\n         ],\n         "Occupants:": [\n            null,\n            "Ocupants:"\n         ],\n         "Features:": [\n            null,\n            "Característiques:"\n         ],\n         "Requires authentication": [\n            null,\n            "Cal autenticar-se"\n         ],\n         "Requires an invitation": [\n            null,\n            "Cal tenir una invitació"\n         ],\n         "Open room": [\n            null,\n            "Obre la sala"\n         ],\n         "Permanent room": [\n            null,\n            "Sala permanent"\n         ],\n         "Temporary room": [\n            null,\n            "Sala temporal"\n         ],\n         "%1$s has invited you to join a chat room: %2$s": [\n            null,\n            "%1$s us ha convidat a unir-vos a una sala de xat: %2$s"\n         ],\n         "%1$s has invited you to join a chat room: %2$s, and left the following reason: \\"%3$s\\"": [\n            null,\n            "%1$s us ha convidat a unir-vos a una sala de xat (%2$s) i ha deixat el següent motiu: \\"%3$s\\""\n         ],\n         "Notification from %1$s": [\n            null,\n            ""\n         ],\n         "%1$s says": [\n            null,\n            ""\n         ],\n         "wants to be your contact": [\n            null,\n            ""\n         ],\n         "Re-establishing encrypted session": [\n            null,\n            "S\'està tornant a establir la sessió xifrada"\n         ],\n         "Generating private key.": [\n            null,\n            "S\'està generant la clau privada"\n         ],\n         "Your browser might become unresponsive.": [\n            null,\n            "És possible que el navegador no respongui."\n         ],\n         "Authentication request from %1$s\\n\\nYour chat contact is attempting to verify your identity, by asking you the question below.\\n\\n%2$s": [\n            null,\n            "Sol·licitud d\'autenticació de %1$s\\n\\nEl contacte del xat està intentant verificar la vostra identitat mitjançant la pregunta següent.\\n\\n%2$s"\n         ],\n         "Could not verify this user\'s identify.": [\n            null,\n            "No s\'ha pogut verificar la identitat d\'aquest usuari."\n         ],\n         "Exchanging private key with contact.": [\n            null,\n            "S\'està intercanviant la clau privada amb el contacte."\n         ],\n         "Your messages are not encrypted anymore": [\n            null,\n            "Els vostres missatges ja no estan xifrats"\n         ],\n         "Your messages are now encrypted but your contact\'s identity has not been verified.": [\n            null,\n            "Ara, els vostres missatges estan xifrats, però no s\'ha verificat la identitat del contacte."\n         ],\n         "Your contact\'s identify has been verified.": [\n            null,\n            "S\'ha verificat la identitat del contacte."\n         ],\n         "Your contact has ended encryption on their end, you should do the same.": [\n            null,\n            "El contacte ha conclòs el xifratge; cal que feu el mateix."\n         ],\n         "Your message could not be sent": [\n            null,\n            "No s\'ha pogut enviar el missatge"\n         ],\n         "We received an unencrypted message": [\n            null,\n            "Hem rebut un missatge sense xifrar"\n         ],\n         "We received an unreadable encrypted message": [\n            null,\n            "Hem rebut un missatge xifrat il·legible"\n         ],\n         "Here are the fingerprints, please confirm them with %1$s, outside of this chat.\\n\\nFingerprint for you, %2$s: %3$s\\n\\nFingerprint for %1$s: %4$s\\n\\nIf you have confirmed that the fingerprints match, click OK, otherwise click Cancel.": [\n            null,\n            "Aquí es mostren les empremtes. Confirmeu-les amb %1$s fora d\'aquest xat.\\n\\nEmpremta de l\'usuari %2$s: %3$s\\n\\nEmpremta de %1$s: %4$s\\n\\nSi heu confirmat que les empremtes coincideixen, feu clic a D\'acord; en cas contrari, feu clic a Cancel·la."\n         ],\n         "You will be prompted to provide a security question and then an answer to that question.\\n\\nYour contact will then be prompted the same question and if they type the exact same answer (case sensitive), their identity will be verified.": [\n            null,\n            "Se us demanarà que indiqueu una pregunta de seguretat i la resposta corresponent.\\n\\nEs farà la mateixa pregunta al vostre contacte i, si escriu exactament la mateixa resposta (es distingeix majúscules de minúscules), se\'n verificarà la identitat."\n         ],\n         "What is your security question?": [\n            null,\n            "Quina és la vostra pregunta de seguretat?"\n         ],\n         "What is the answer to the security question?": [\n            null,\n            "Quina és la resposta a la pregunta de seguretat?"\n         ],\n         "Invalid authentication scheme provided": [\n            null,\n            "S\'ha indicat un esquema d\'autenticació no vàlid"\n         ],\n         "Your messages are not encrypted. Click here to enable OTR encryption.": [\n            null,\n            "Els vostres missatges no estan xifrats. Feu clic aquí per habilitar el xifratge OTR."\n         ],\n         "Your messages are encrypted, but your contact has not been verified.": [\n            null,\n            "Els vostres missatges estan xifrats, però no s\'ha verificat el contacte."\n         ],\n         "Your messages are encrypted and your contact verified.": [\n            null,\n            "Els vostres missatges estan xifrats i s\'ha verificat el contacte."\n         ],\n         "Your contact has closed their end of the private session, you should do the same": [\n            null,\n            "El vostre contacte ha tancat la seva sessió privada; cal que feu el mateix."\n         ],\n         "End encrypted conversation": [\n            null,\n            "Finalitza la conversa xifrada"\n         ],\n         "Refresh encrypted conversation": [\n            null,\n            "Actualitza la conversa xifrada"\n         ],\n         "Start encrypted conversation": [\n            null,\n            "Comença la conversa xifrada"\n         ],\n         "Verify with fingerprints": [\n            null,\n            "Verifica amb empremtes"\n         ],\n         "Verify with SMP": [\n            null,\n            "Verifica amb SMP"\n         ],\n         "What\'s this?": [\n            null,\n            "Què és això?"\n         ],\n         "unencrypted": [\n            null,\n            "sense xifrar"\n         ],\n         "unverified": [\n            null,\n            "sense verificar"\n         ],\n         "verified": [\n            null,\n            "verificat"\n         ],\n         "finished": [\n            null,\n            "acabat"\n         ],\n         " e.g. conversejs.org": [\n            null,\n            "p. ex. conversejs.org"\n         ],\n         "Your XMPP provider\'s domain name:": [\n            null,\n            "Nom de domini del vostre proveïdor XMPP:"\n         ],\n         "Fetch registration form": [\n            null,\n            "Obtingues un formulari de registre"\n         ],\n         "Tip: A list of public XMPP providers is available": [\n            null,\n            "Consell: hi ha disponible una llista de proveïdors XMPP públics"\n         ],\n         "here": [\n            null,\n            "aquí"\n         ],\n         "Register": [\n            null,\n            "Registre"\n         ],\n         "Sorry, the given provider does not support in band account registration. Please try with a different provider.": [\n            null,\n            "El proveïdor indicat no admet el registre del compte. Proveu-ho amb un altre proveïdor."\n         ],\n         "Requesting a registration form from the XMPP server": [\n            null,\n            "S\'està sol·licitant un formulari de registre del servidor XMPP"\n         ],\n         "Something went wrong while establishing a connection with \\"%1$s\\". Are you sure it exists?": [\n            null,\n            "Ha passat alguna cosa mentre s\'establia la connexió amb \\"%1$s\\". Segur que existeix?"\n         ],\n         "Now logging you in": [\n            null,\n            "S\'està iniciant la vostra sessió"\n         ],\n         "Registered successfully": [\n            null,\n            "Registre correcte"\n         ],\n         "Return": [\n            null,\n            "Torna"\n         ],\n         "The provider rejected your registration attempt. Please check the values you entered for correctness.": [\n            null,\n            "El proveïdor ha rebutjat l\'intent de registre. Comproveu que els valors que heu introduït siguin correctes."\n         ],\n         "Retry": [\n            null,\n            ""\n         ],\n         "This contact is busy": [\n            null,\n            "Aquest contacte està ocupat"\n         ],\n         "This contact is online": [\n            null,\n            "Aquest contacte està en línia"\n         ],\n         "This contact is offline": [\n            null,\n            "Aquest contacte està desconnectat"\n         ],\n         "This contact is unavailable": [\n            null,\n            "Aquest contacte no està disponible"\n         ],\n         "This contact is away for an extended period": [\n            null,\n            "Aquest contacte està absent durant un període prolongat"\n         ],\n         "This contact is away": [\n            null,\n            "Aquest contacte està absent"\n         ],\n         "Groups": [\n            null,\n            "Grups"\n         ],\n         "My contacts": [\n            null,\n            "Els meus contactes"\n         ],\n         "Pending contacts": [\n            null,\n            "Contactes pendents"\n         ],\n         "Contact requests": [\n            null,\n            "Sol·licituds de contacte"\n         ],\n         "Ungrouped": [\n            null,\n            "Sense agrupar"\n         ],\n         "Filter": [\n            null,\n            ""\n         ],\n         "State": [\n            null,\n            ""\n         ],\n         "Any": [\n            null,\n            ""\n         ],\n         "Chatty": [\n            null,\n            ""\n         ],\n         "Extended Away": [\n            null,\n            ""\n         ],\n         "Click to remove this contact": [\n            null,\n            "Feu clic per eliminar aquest contacte"\n         ],\n         "Click to accept this contact request": [\n            null,\n            "Feu clic per acceptar aquesta sol·licitud de contacte"\n         ],\n         "Click to decline this contact request": [\n            null,\n            "Feu clic per rebutjar aquesta sol·licitud de contacte"\n         ],\n         "Click to chat with this contact": [\n            null,\n            "Feu clic per conversar amb aquest contacte"\n         ],\n         "Name": [\n            null,\n            "Nom"\n         ],\n         "Are you sure you want to remove this contact?": [\n            null,\n            "Segur que voleu eliminar aquest contacte?"\n         ],\n         "Sorry, there was an error while trying to remove ": [\n            null,\n            "S\'ha produït un error en intentar eliminar "\n         ],\n         "Are you sure you want to decline this contact request?": [\n            null,\n            "Segur que voleu rebutjar aquesta sol·licitud de contacte?"\n         ]\n      }\n   }\n}';
}),function(e){"function"==typeof define&&define.amd?define("jquery.browser",["jquery"],function(t){return e(t)}):"object"==typeof module&&"object"==typeof module.exports?module.exports=e(require("jquery")):e(window.jQuery)}(function(e){"use strict";function t(e){void 0===e&&(e=window.navigator.userAgent),e=e.toLowerCase();var t=/(edge)\/([\w.]+)/.exec(e)||/(opr)[\/]([\w.]+)/.exec(e)||/(chrome)[ \/]([\w.]+)/.exec(e)||/(iemobile)[\/]([\w.]+)/.exec(e)||/(version)(applewebkit)[ \/]([\w.]+).*(safari)[ \/]([\w.]+)/.exec(e)||/(webkit)[ \/]([\w.]+).*(version)[ \/]([\w.]+).*(safari)[ \/]([\w.]+)/.exec(e)||/(webkit)[ \/]([\w.]+)/.exec(e)||/(opera)(?:.*version|)[ \/]([\w.]+)/.exec(e)||/(msie) ([\w.]+)/.exec(e)||e.indexOf("trident")>=0&&/(rv)(?::| )([\w.]+)/.exec(e)||e.indexOf("compatible")<0&&/(mozilla)(?:.*? rv:([\w.]+)|)/.exec(e)||[],n=/(ipad)/.exec(e)||/(ipod)/.exec(e)||/(windows phone)/.exec(e)||/(iphone)/.exec(e)||/(kindle)/.exec(e)||/(silk)/.exec(e)||/(android)/.exec(e)||/(win)/.exec(e)||/(mac)/.exec(e)||/(linux)/.exec(e)||/(cros)/.exec(e)||/(playbook)/.exec(e)||/(bb)/.exec(e)||/(blackberry)/.exec(e)||[],i={},o={browser:t[5]||t[3]||t[1]||"",version:t[2]||t[4]||"0",versionNumber:t[4]||t[2]||"0",platform:n[0]||""};if(o.browser&&(i[o.browser]=!0,i.version=o.version,i.versionNumber=parseInt(o.versionNumber,10)),o.platform&&(i[o.platform]=!0),(i.android||i.bb||i.blackberry||i.ipad||i.iphone||i.ipod||i.kindle||i.playbook||i.silk||i["windows phone"])&&(i.mobile=!0),(i.cros||i.mac||i.linux||i.win)&&(i.desktop=!0),(i.chrome||i.opr||i.safari)&&(i.webkit=!0),i.rv||i.iemobile){var s="msie";o.browser=s,i[s]=!0}if(i.edge){delete i.edge;var r="msedge";o.browser=r,i[r]=!0}if(i.safari&&i.blackberry){var a="blackberry";o.browser=a,i[a]=!0}if(i.safari&&i.playbook){var l="playbook";o.browser=l,i[l]=!0}if(i.bb){var c="blackberry";o.browser=c,i[c]=!0}if(i.opr){var u="opera";o.browser=u,i[u]=!0}if(i.safari&&i.android){var d="android";o.browser=d,i[d]=!0}if(i.safari&&i.kindle){var h="kindle";o.browser=h,i[h]=!0}if(i.safari&&i.silk){var p="silk";o.browser=p,i[p]=!0}return i.name=o.browser,i.platform=o.platform,i}return window.jQBrowser=t(window.navigator.userAgent),window.jQBrowser.uaMatch=t,e&&(e.browser=window.jQBrowser),window.jQBrowser}),function(e){"use strict";var t={},n="function"==typeof requirejs&&requirejs.nodeRequire,i=function(e){return e.replace(/(\/$)/,"")};define("tpl",["require","exports","module","lodash"],function(e,o){function s(e,t,n){return["define('",e,"!",t,"', ","['lodash'], ",["function(_) {","return ",n,";","}"].join(""),");\n"].join("")}function r(e){var t=a.extend({ext:".html",root:e.baseUrl,templateSettings:{}},e.lodashLoader);return t.root&&"/"!==t.root.slice(-1)&&(t.root+="/"),a.extend(a.templateSettings,t.templateSettings),t}var a=e("lodash");o.version="1.0.1",o.load=function(o,s,l,c){var u;c||(c=e.rawConfig,u=!0);var d="",h=r(c);i(c.baseUrl)===i(h.root)&&(h.root="");var p=e.toUrl(h.root+o+h.ext);if(u&&0!==p.indexOf(c.baseUrl)&&(p=i(c.baseUrl)+p),c.isBuild){var _=n("fs");try{d=String(_.readFileSync(p))}catch(e){"/"===p.slice(0,1)&&(p=p.slice(1)),d=String(_.readFileSync(p))}return t[o]=a.template(d),l()}var m=new XMLHttpRequest;m.onreadystatechange=function(){if(4===m.readyState){var e=a.clone(h.templateSettings);e.sourceURL=p,t[o]=a.template(m.responseText,e),l(t[o])}},m.open("GET",p,!0),m.send(null)},o.write=function(e,n,i){var o=t[n].source;i(s(e,n,o))},o.compile=function(e,t,n,i,o){function a(n){i.write(s(e,t,n))}r(o),i.read(t,a,i.error)}})}("object"==typeof global?global:this),define("tpl!field",["lodash"],function(_){return function(obj){function print(){__p+=__j.call(arguments,"")}obj||(obj={});var __t,__p="",__e=_.escape,__j=Array.prototype.join;with(obj)__p+='<field var="'+__e(name)+'">',_.isArray(value)?(__p+="\n    ",_.each(value,function(e){__p+="<value>"+__e(e)+"</value>"}),__p+="\n"):__p+="\n    <value>"+__e(value)+"</value>\n",__p+="</field>\n";return __p}}),define("tpl!select_option",["lodash"],function(_){return function(obj){function print(){__p+=__j.call(arguments,"")}obj||(obj={});var __t,__p="",__e=_.escape,__j=Array.prototype.join;with(obj)__p+='<option value="'+__e(value)+'" ',selected&&(__p+=' selected="selected" '),__p+=" >"+__e(label)+"</option>\n";return __p}}),define("tpl!form_select",["lodash"],function(_){return function(obj){function print(){__p+=__j.call(arguments,"")}obj||(obj={});var __t,__p="",__e=_.escape,__j=Array.prototype.join;with(obj)__p+="<label>"+__e(label)+'</label>\n<select name="'+__e(name)+'"  ',multiple&&(__p+=' multiple="multiple" '),__p+=">"+(null==(__t=options)?"":__t)+"</select>\n";return __p}}),define("tpl!form_textarea",["lodash"],function(_){return function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj)__p+='<label class="label-ta">'+__e(label)+'</label>\n<textarea name="'+__e(name)+'">'+__e(value)+"</textarea>\n";return __p}}),define("tpl!form_checkbox",["lodash"],function(_){return function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj)__p+="<label>"+__e(label)+'</label>\n<input name="'+__e(name)+'" type="'+__e(type)+'" '+__e(checked)+">\n";return __p}}),define("tpl!form_username",["lodash"],function(_){return function(obj){function print(){__p+=__j.call(arguments,"")}obj||(obj={});var __t,__p="",__e=_.escape,__j=Array.prototype.join;with(obj)label&&(__p+="\n<label>\n    "+__e(label)+"\n</label>\n"),__p+='\n<div class="input-group">\n    <input name="'+__e(name)+'" type="'+__e(type)+'"\n        ',value&&(__p+=' value="'+__e(value)+'" '),__p+="\n        ",required&&(__p+=' class="required" '),__p+=' />\n    <span title="'+__e(domain)+'">'+__e(domain)+"</span>\n</div>\n";return __p}}),define("tpl!form_input",["lodash"],function(_){return function(obj){function print(){__p+=__j.call(arguments,"")}obj||(obj={});var __t,__p="",__e=_.escape,__j=Array.prototype.join;with(obj)label&&(__p+="\n<label>\n    "+__e(label)+"\n</label>\n"),__p+='\n<input name="'+__e(name)+'" type="'+__e(type)+'" \n    ',value&&(__p+=' value="'+__e(value)+'" '),__p+="\n    ",required&&(__p+=' class="required" '),__p+=" >\n";return __p}}),define("tpl!form_captcha",["lodash"],function(_){return function(obj){function print(){__p+=__j.call(arguments,"")}obj||(obj={});var __t,__p="",__e=_.escape,__j=Array.prototype.join;with(obj)label&&(__p+="\n<label>\n    "+__e(label)+"\n</label>\n"),__p+='\n<img src="data:'+__e(type)+";base64,"+__e(data)+'">\n<input name="'+__e(name)+'" type="text" ',required&&(__p+=' class="required" '),__p+=" >\n\n\n";return __p}}),function(e,t){define("utils",["jquery-private","jquery.browser","lodash","tpl!field","tpl!select_option","tpl!form_select","tpl!form_textarea","tpl!form_checkbox","tpl!form_username","tpl!form_input","tpl!form_captcha"],t)}(this,function(e,t,n,i,o,s,r,a,l,c,u){"use strict";var d={"text-private":"password","text-single":"text",fixed:"label",boolean:"checkbox",hidden:"hidden","jid-multi":"textarea","list-single":"dropdown","list-multi":"dropdown"},h=function(e,t){e.classList.remove("visible"),n.isFunction(t)&&t()},p=function(e){var t=document.createElement("div");return t.innerHTML=e,t.innerText},_=function(t){var n=new e.Deferred,i=new Image,o=window.setTimeout(function(){n.reject(),i=null},3e3);return i.onerror=i.onabort=function(){clearTimeout(o),n.reject()},i.onload=function(){clearTimeout(o),n.resolve(i)},i.src=t,n.promise()};e.fn.hasScrollBar=function(){return!!e.contains(document,this.get(0))&&this.parent().height()<this.get(0).scrollHeight},e.fn.throttledHTML=n.throttle(e.fn.html,500),e.fn.addHyperlinks=function(){return this.length>0&&this.each(function(t,i){var o,s,r=e(i),a=r.html(),l=a.match(/\b(https?:\/\/|www\.|https?:\/\/www\.)[^\s<]{2,200}\b/g);if(l)for(t=0;t<l.length;t++)o=0===l[t].indexOf("http://")||0===l[t].indexOf("https://")?"":"http://",s=encodeURI(decodeURI(l[t])).replace(/[!'()]/g,escape).replace(/\*/g,"%2A"),a=a.replace(l[t],'<a target="_blank" rel="noopener" href="'+o+s+'">'+l[t]+"</a>");r.html(a),n.forEach(l,function(e){_(p(e)).then(function(t){var n=0===e.indexOf("http://")||0===e.indexOf("https://")?"":"http://",i=encodeURI(decodeURI(e)).replace(/[!'()]/g,escape).replace(/\*/g,"%2A"),o='<a target="_blank" rel="noopener" href="'+n+i+'">'+e+"</a>";t.className="chat-image",a=a.replace(o,t.outerHTML),r.throttledHTML(a)})})}),this},e.fn.addEmoticons=function(t){return t&&this.length>0&&this.each(function(t,n){var i=e(n).html();i=i.replace(/&gt;:\)/g,'<span class="emoticon icon-evil"></span>'),i=i.replace(/:\)/g,'<span class="emoticon icon-smiley"></span>'),i=i.replace(/:\-\)/g,'<span class="emoticon icon-smiley"></span>'),i=i.replace(/;\)/g,'<span class="emoticon icon-wink"></span>'),i=i.replace(/;\-\)/g,'<span class="emoticon icon-wink"></span>'),i=i.replace(/:D/g,'<span class="emoticon icon-grin"></span>'),i=i.replace(/:\-D/g,'<span class="emoticon icon-grin"></span>'),i=i.replace(/:P/g,'<span class="emoticon icon-tongue"></span>'),i=i.replace(/:\-P/g,'<span class="emoticon icon-tongue"></span>'),i=i.replace(/:p/g,'<span class="emoticon icon-tongue"></span>'),i=i.replace(/:\-p/g,'<span class="emoticon icon-tongue"></span>'),i=i.replace(/8\)/g,'<span class="emoticon icon-cool"></span>'),i=i.replace(/:S/g,'<span class="emoticon icon-confused"></span>'),i=i.replace(/:\\/g,'<span class="emoticon icon-wondering"></span>'),i=i.replace(/:\/ /g,'<span class="emoticon icon-wondering"></span>'),i=i.replace(/&gt;:\(/g,'<span class="emoticon icon-angry"></span>'),i=i.replace(/:\(/g,'<span class="emoticon icon-sad"></span>'),i=i.replace(/:\-\(/g,'<span class="emoticon icon-sad"></span>'),i=i.replace(/:O/g,'<span class="emoticon icon-shocked"></span>'),i=i.replace(/:\-O/g,'<span class="emoticon icon-shocked"></span>'),i=i.replace(/\=\-O/g,'<span class="emoticon icon-shocked"></span>'),i=i.replace(/\(\^.\^\)b/g,'<span class="emoticon icon-thumbs-up"></span>'),i=i.replace(/&lt;3/g,'<span class="emoticon icon-heart"></span>'),e(n).html(i)}),this};var m={__:function(e){if("undefined"==typeof Jed||n.isUndefined(this.i18n)||"en"===this.i18n)return e;"string"==typeof this.i18n&&(this.i18n=window.JSON.parse(this.i18n)),"undefined"==typeof this.jed&&(this.jed=new Jed(this.i18n));var t=this.jed.translate(e);return arguments.length>1?t.fetch.apply(t,[].slice.call(arguments,1)):t.fetch()},___:function(e){return e},isLocaleAvailable:function(e,t){if(t(e))return e;var n=e.split("-")[0];return n!==e&&t(n)?n:void 0},detectLocale:function(e){var t,n;if(window.navigator.userLanguage&&(t=m.isLocaleAvailable(window.navigator.userLanguage,e)),window.navigator.languages&&!t)for(n=0;n<window.navigator.languages.length&&!t;n++)t=m.isLocaleAvailable(window.navigator.languages[n],e);return window.navigator.browserLanguage&&!t&&(t=m.isLocaleAvailable(window.navigator.browserLanguage,e)),window.navigator.language&&!t&&(t=m.isLocaleAvailable(window.navigator.language,e)),window.navigator.systemLanguage&&!t&&(t=m.isLocaleAvailable(window.navigator.systemLanguage,e)),t||"en"},fadeIn:function(t,i){return e.fx.off?(t.classList.remove("hidden"),void(n.isFunction(i)&&i())):void(n.includes(t.classList,"hidden")?(setTimeout(n.partial(h,t,i),351),t.classList.add("visible"),t.classList.remove("hidden")):h(t,i))},isOTRMessage:function(e){var t=e.querySelector("body"),i=n.isNull(t)?void 0:t.textNode;return i&&!!i.match(/^\?OTR/)},isHeadlineMessage:function(e){var t=e.getAttribute("from");return"headline"===e.getAttribute("type")||"error"!==e.getAttribute("type")&&!n.isNil(t)&&!n.includes(t,"@")},merge:function e(t,i){for(var o in i)n.isObject(t[o])?e(t[o],i[o]):t[o]=i[o]},applyUserSettings:function e(t,i,o){for(var s in i)n.isUndefined(o[s])||(n.isObject(i[s])&&!n.isArray(i[s])?e(t[s],i[s],o[s]):t[s]=o[s])},refreshWebkit:function(){e.browser.webkit&&window.requestAnimationFrame&&window.requestAnimationFrame(function(){var e=document.getElementById("conversejs");e.style.display="none";e.offsetHeight;e.style.display="block"})},webForm2xForm:function(t){var n,o=e(t);if(o.is("[type=checkbox]"))n=o.is(":checked")&&1||0;else if(o.is("textarea")){n=[];for(var s=o.val().split("\n"),r=0;r<s.length;r++){var a=e.trim(s[r]);""!==a&&n.push(a)}}else n=o.val();return e(i({name:o.attr("name"),value:n}))[0]},contains:function(e,t){return function(i){if("object"==typeof e){var o=!1;return n.forEach(e,function(e){o=o||n.includes(i.get(e).toLowerCase(),t.toLowerCase())}),o}if("string"==typeof e)return n.includes(i.get(e).toLowerCase(),t.toLowerCase());throw new TypeError("contains: wrong attribute type. Must be string or array.")}},xForm2webForm:function(t,i){var h,p,_,m,f,g=[];if("list-single"===t.attr("type")||"list-multi"===t.attr("type")){for(f=[],_=t.children("value"),h=0;h<_.length;h++)f.push(e(_[h]).text());for(p=t.children("option"),h=0;h<p.length;h++)m=e(p[h]).find("value").text(),g.push(o({value:m,label:e(p[h]).attr("label"),selected:n.startsWith(f,m),required:t.find("required").length}));return s({name:t.attr("var"),label:t.attr("label"),options:g.join(""),multiple:"list-multi"===t.attr("type"),required:t.find("required").length})}return"fixed"===t.attr("type")?e('<p class="form-help">').text(t.find("value").text()):"jid-multi"===t.attr("type")?r({name:t.attr("var"),label:t.attr("label")||"",value:t.find("value").text(),required:t.find("required").length}):"boolean"===t.attr("type")?a({name:t.attr("var"),type:d[t.attr("type")],label:t.attr("label")||"",checked:"1"===t.find("value").text()&&'checked="1"'||"",required:t.find("required").length}):t.attr("type")&&"username"===t.attr("var")?l({domain:" @"+this.domain,name:t.attr("var"),type:d[t.attr("type")],label:t.attr("label")||"",value:t.find("value").text(),required:t.find("required").length}):t.attr("type")?c({name:t.attr("var"),type:d[t.attr("type")],label:t.attr("label")||"",value:t.find("value").text(),required:t.find("required").length}):"ocr"===t.attr("var")?n.reduce(n.map(t.find("uri"),e.proxy(function(e){return u({label:this.$field.attr("label"),name:this.$field.attr("var"),data:this.$stanza.find('data[cid="'+e.textContent.replace(/^cid:/,"")+'"]').text(),type:e.getAttribute("type"),required:this.$field.find("required").length})},{$stanza:i,$field:t})),function(e,t){return e+t},""):void 0}};return m.contains.not=function(e,t){return function(n){return!m.contains(e,t)(n)}},m.createElementsFromString=function(e,t){var n,i=document.createDocumentFragment(),o=document.createElement("body");for(o.innerHTML=t;n=o.firstChild;)i.appendChild(n);e.appendChild(i),i=o=null},m}),function(e,t){if("function"==typeof define&&define.amd)define("pluggable",["exports","lodash"],t);else if("undefined"!=typeof exports)t(exports,require("lodash"));else{var n={exports:{}};t(n.exports,e._),e.pluggable=n.exports}}(this,function(e,t){"use strict";function n(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}function i(e,t){this.name=t,this.plugged=e,"undefined"==typeof this.plugged.__super__?this.plugged.__super__={}:"string"==typeof this.plugged.__super__&&(this.plugged.__super__={__string__:this.plugged.__super__}),this.plugged.__super__[t]=this.plugged,this.plugins={},this.initialized_plugins=[]}function o(e,t,n){"undefined"==typeof n&&(n="pluginSocket"),"undefined"==typeof t&&(t="plugged");var o={};return o[n]=new i(e,t),s.extend(e,o)}Object.defineProperty(e,"__esModule",{value:!0}),e.enable=void 0;var s=n(t),r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};s.extend(i.prototype,{wrappedOverride:function(e,t,n){return"function"==typeof n&&("undefined"==typeof this.__super__&&(this.__super__={}),this.__super__[e]=n.bind(this)),t.apply(this,s.drop(arguments,3))},_overrideAttribute:function(e,t){var n=t.overrides[e];if("function"==typeof n){var i=s.partial(this.wrappedOverride,e,n,this.plugged[e]);this.plugged[e]=i}else this.plugged[e]=n},_extendObject:function(e,t){e.prototype.__super__||(e.prototype.__super__={},e.prototype.__super__[this.name]=this.plugged);var n=this;s.each(t,function(t,i){if("events"===i)e.prototype[i]=s.extend(t,e.prototype[i]);else if("function"==typeof t){var o=s.partial(n.wrappedOverride,i,t,e.prototype[i]);e.prototype[i]=o}else e.prototype[i]=t})},loadOptionalDependencies:function(e){var t=this;s.each(e.optional_dependencies,function(n){var i=t.plugins[n];if(i){if(s.includes(i.optional_dependencies,e.__name__))throw'Found a circular dependency between the plugins "'+e.__name__+'" and "'+n+'"';t.initializePlugin(i)}else t.throwUndefinedDependencyError('Could not find optional dependency "'+n+'" for the plugin "'+e.__name__+"\". If it's needed, make sure it's loaded by require.js")})},throwUndefinedDependencyError:function(e){if(this.plugged.strict_plugin_dependencies)throw e;return void console.log(e)},applyOverrides:function(e){var t=this;s.each(Object.keys(e.overrides||{}),function(n){var i=e.overrides[n];"object"===("undefined"==typeof i?"undefined":r(i))?"undefined"==typeof t.plugged[n]?t.throwUndefinedDependencyError('Error: Plugin "'+e.__name__+'" tried to override '+n+" but it's not found."):t._extendObject(t.plugged[n],i):t._overrideAttribute(n,e)})},initializePlugin:function(e){s.includes(s.keys(this.allowed_plugins),e.__name__)&&(s.includes(this.initialized_plugins,e.__name__)||(s.extend(e,this.properties),e.optional_dependencies&&this.loadOptionalDependencies(e),this.applyOverrides(e),"function"==typeof e.initialize&&e.initialize.bind(e)(this),this.initialized_plugins.push(e.__name__)))},registerPlugin:function(e,t){if(e in this.plugins)throw new Error("Error: Plugin name "+e+" is already taken");t.__name__=e,this.plugins[e]=t},initializePlugins:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[];s.size(this.plugins)&&(this.properties=e,this.allowed_plugins=s.pickBy(this.plugins,function(e,i){return(!t.length||t.length&&s.includes(t,i))&&!s.includes(n,i)}),s.each(s.values(this.allowed_plugins),this.initializePlugin.bind(this)))}}),e.enable=o,e.default={enable:o}}),function(e,t){define("converse-core",["sizzle","jquery-private","lodash","polyfill","locales","utils","moment_with_locales","strophe","pluggable","strophe.disco","backbone.browserStorage","backbone.overview"],t)}(this,function(e,t,n,i,o,s,r,a,l){var c=a.$build,u=a.$iq,d=a.$msg,h=a.$pres,p=a.SHA1.b64_sha1;a=a.Strophe,n.templateSettings={evaluate:/\{\[([\s\S]+?)\]\}/g,interpolate:/\{\{([\s\S]+?)\}\}/g};var _={};_.templates={},n.extend(_,Backbone.Events),_.promises={cachedRoster:new t.Deferred,chatBoxesFetched:new t.Deferred,connected:new t.Deferred,pluginsInitialized:new t.Deferred,roster:new t.Deferred,rosterContactsFetched:new t.Deferred,rosterGroupsFetched:new t.Deferred,rosterInitialized:new t.Deferred,statusInitialized:new t.Deferred},_.emit=function(e){_.trigger.apply(this,arguments);var t=_.promises[e];n.isUndefined(t)||t.resolve()},_.core_plugins=["converse-bookmarks","converse-chatview","converse-controlbox","converse-core","converse-dragresize","converse-headline","converse-mam","converse-minimize","converse-muc","converse-notification","converse-otr","converse-ping","converse-register","converse-rosterview","converse-vcard"],l.enable(_,"_converse","pluggable"),_.STATUS_WEIGHTS={offline:6,unavailable:5,xa:4,away:3,dnd:2,chat:1,online:1},_.PRETTY_CHAT_STATUS={offline:"Offline",unavailable:"Unavailable",xa:"Extended Away",away:"Away",dnd:"Do not disturb",chat:"Chattty",online:"Online"},_.ANONYMOUS="anonymous",_.CLOSED="closed",_.EXTERNAL="external",_.LOGIN="login",_.LOGOUT="logout",_.OPENED="opened",_.PREBIND="prebind";var m={0:"ERROR",1:"CONNECTING",2:"CONNFAIL",3:"AUTHENTICATING",4:"AUTHFAIL",5:"CONNECTED",6:"DISCONNECTED",7:"DISCONNECTING",8:"ATTACHED",9:"REDIRECT"},f="image/png",g="iVBORw0KGgoAAAANSUhEUgAAAGAAAABgCAIAAABt+uBvAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH3gwHCy455JBsggAABkJJREFUeNrtnM1PE1sUwHvvTD8otWLHST/Gimi1CEgr6M6FEWuIBo2pujDVsNDEP8GN/4MbN7oxrlipG2OCgZgYlxAbkRYw1KqkIDRCSkM7nXvvW8x7vjyNeQ9m7p1p3z1LQk/v/Dhz7vkEXL161cHl9wI5Ag6IA+KAOCAOiAPigDggLhwQB2S+iNZ+PcYY/SWEEP2HAAAIoSAIoihCCP+ngDDGtVotGAz29/cfOXJEUZSOjg6n06lp2sbGRqlUWlhYyGazS0tLbrdbEASrzgksyeYJId3d3el0uqenRxRFAAAA4KdfIIRgjD9+/Pj8+fOpqSndslofEIQwHA6Pjo4mEon//qmFhYXHjx8vLi4ihBgDEnp7e9l8E0Jo165dQ0NDd+/eDYVC2/qsJElDQ0OEkKWlpa2tLZamxAhQo9EIBoOjo6MXL17csZLe3l5FUT59+lQul5l5JRaAVFWNRqN37tw5ceKEQVWRSOTw4cOFQuHbt2+iKLYCIISQLMu3b99OJpOmKAwEAgcPHszn8+vr6wzsiG6UQQhxuVyXLl0aGBgwUW0sFstkMl6v90fo1KyAMMYDAwPnzp0zXfPg4GAqlWo0Gk0MiBAiy/L58+edTqf5Aa4onj59OhaLYYybFRCEMBaL0fNxBw4cSCQStN0QRUBut3t4eJjq6U+dOiVJElVPRBFQIBDo6+ujCqirqyscDlONGykC2lYyYSR6pBoQQapHZwAoHo/TuARYAOrs7GQASFEUqn6aIiBJkhgA6ujooFpUo6iaTa7koFwnaoWadLNe81tbWwzoaJrWrICWl5cZAFpbW6OabVAEtLi4yABQsVjUNK0pAWWzWQaAcrlcswKanZ1VVZUqHYRQEwOq1Wpv3ryhCmh6erpcLjdrNl+v1ycnJ+l5UELI27dvv3//3qxxEADgy5cvExMT9Mznw4cPtFtAdAPFarU6Pj5eKpVM17yxsfHy5cvV1VXazXu62gVBKBQKT58+rdVqJqrFGL948eLdu3dU8/g/H4FBUaJYLAqC0NPTY9brMD4+PjY25mDSracOCABACJmZmXE6nUePHjWu8NWrV48ePSKEsGlAs7Agfd5nenq6Wq0mk0kjDzY2NvbkyRMIIbP2PLvhBUEQ8vl8NpuNx+M+n29bzhVjvLKycv/+/YmJCcazQuwA6YzW1tYmJyf1SY+2trZ/rRk1Go1SqfT69esHDx4UCgVmNaa/zZ/9ABUhRFXVYDB48uTJeDweiUQkSfL7/T9MA2NcqVTK5fLy8vL8/PzU1FSxWHS5XJaM4wGr9sUwxqqqer3eUCgkSZJuUBBCfTRvc3OzXC6vrKxUKhWn02nhCJ5lM4oQQo/HgxD6+vXr58+fHf8sDOp+HQDg8XgclorFU676dKLlo6yWRdItIBwQB8QBcUCtfosRQjRNQwhhjPUC4w46WXryBSHU1zgEQWBz99EFhDGu1+t+v//48ePxeFxRlD179ng8nh0Efgiher2+vr6ur3HMzMysrq7uTJVdACGEurq6Ll++nEgkPB7Pj9jPoDHqOxyqqubz+WfPnuVyuV9XPeyeagAAAoHArVu3BgcHab8CuVzu4cOHpVKJUnfA5GweY+xyuc6cOXPv3r1IJMLAR8iyPDw8XK/Xi8Wiqqqmm5KZgBBC7e3tN27cuHbtGuPVpf7+/lAoNDs7W61WzfVKpgHSSzw3b95MpVKW3MfRaDQSiczNzVUqFRMZmQOIEOL1eq9fv3727FlL1t50URRFluX5+flqtWpWEGAOIFEUU6nUlStXLKSjy759+xwOx9zcnKZpphzGHMzhcDiTydgk9r1w4YIp7RPTAAmCkMlk2FeLf/tIEKbTab/fbwtAhJBoNGrutpNx6e7uPnTokC1eMU3T0um0DZPMkZER6wERQnw+n/FFSxpy7Nix3bt3WwwIIcRgIWnHkkwmjecfRgGx7DtuV/r6+iwGhDHev3+/bQF1dnYaH6E2CkiWZdsC2rt3r8WAHA5HW1ubbQGZcjajgOwTH/4qNko1Wlg4IA6IA+KAOKBWBUQIsfNojyliKIoRRfH9+/dut9umf3wzpoUNNQ4BAJubmwz+ic+OxefzWWlBhJD29nbug7iT5sIBcUAcEAfEAXFAHBAHxOVn+QMrmWpuPZx12gAAAABJRU5ErkJggg==";return _.log=function(e,t){var i;i=n.isUndefined(console)||n.isUndefined(console.log)?{log:n.noop,error:n.noop}:console,_.debug&&("error"===t?i.log("ERROR: "+e):i.log(e))},_.initialize=function(i,l){"use strict";i=n.isUndefined(i)?{}:i;var d=new t.Deferred;n.isUndefined(_.chatboxes)||(_.connection.reset(),_.off(),_.stopListening(),_._tearDown());var v;"onpagehide"in window?v="pagehide":"onbeforeunload"in window?v="beforeunload":"onunload"in window&&(v="unload"),a.log=function(e,t){_.log(e+" "+t,e)},a.error=function(e){_.log(e,"error")},a.addNamespace("CARBONS","urn:xmpp:carbons:2"),a.addNamespace("CHATSTATES","http://jabber.org/protocol/chatstates"),a.addNamespace("CSI","urn:xmpp:csi:0"),a.addNamespace("DELAY","urn:xmpp:delay"),a.addNamespace("HINTS","urn:xmpp:hints"),a.addNamespace("NICK","http://jabber.org/protocol/nick"),a.addNamespace("PUBSUB","http://jabber.org/protocol/pubsub"),a.addNamespace("ROSTERX","http://jabber.org/protocol/rosterx"),a.addNamespace("XFORM","jabber:x:data"),this.TIMEOUTS={PAUSED:1e4,INACTIVE:9e4},this.INACTIVE="inactive",this.ACTIVE="active",this.COMPOSING="composing",this.PAUSED="paused",this.GONE="gone",o=n.isUndefined(o)?{}:o,this.isConverseLocale=function(e){return!n.isUndefined(o[e])},this.isMomentLocale=function(e){return r.locale()!==r.locale(e)},r.locale||(r.locale=r.lang),r.locale(s.detectLocale(this.isMomentLocale)),n.includes(n.keys(o),i.i18n)&&(i.i18n=o[i.i18n]),this.i18n=i.i18n?i.i18n:o[s.detectLocale(this.isConverseLocale)]||{};var b=_.__=s.__.bind(_);_.___=s.___;var y=b("Click to hide these contacts");if(this.default_settings={allow_contact_requests:!0,allow_non_roster_messaging:!1,animate:!0,authentication:"login",auto_away:0,auto_login:!1,auto_reconnect:!1,auto_subscribe:!1,auto_xa:0,blacklisted_plugins:[],bosh_service_url:void 0,connection_options:{},credentials_url:null,csi_waiting_time:0,debug:!1,default_state:"online",expose_rid_and_sid:!1,filter_by_resource:!1,forward_messages:!1,hide_offline_users:!1,include_offline_state:!1,jid:void 0,keepalive:!0,locked_domain:void 0,message_carbons:!0,message_storage:"session",password:void 0,prebind_url:null,priority:0,registration_domain:"",rid:void 0,roster_groups:!0,show_only_online_users:!1,sid:void 0,storage:"session",strict_plugin_dependencies:!1,synchronize_availability:!0,websocket_url:void 0,whitelisted_plugins:[],xhr_custom_status:!1,xhr_custom_status_url:"",show_send_button:!1},n.assignIn(this,this.default_settings),n.assignIn(this,n.pick(i,n.keys(this.default_settings))),this.authentication===_.ANONYMOUS&&this.auto_login&&!this.jid)throw new Error("Config Error: you need to provide the server's domain via the 'jid' option when using anonymous authentication with auto_login.");t.fx.off=!this.animate,this.callback=l||n.noop,this.send_initial_presence=!0,this.msg_counter=0,this.user_settings=i,this.getViewForChatBox=function(e){if(e)return _.chatboxviews.get(e.get("id"))},this.generateResource=function(){return"/converse.js-"+Math.floor(139749825*Math.random()).toString()},this.sendCSI=function(e){_.connection.send(c(e,{xmlns:a.NS.CSI})),_.inactive=e===_.INACTIVE},this.onUserActivity=function(){_.idle_seconds>0&&(_.idle_seconds=0),_.connection.authenticated&&(_.inactive&&_.sendCSI(_.ACTIVE),_.auto_changed_status===!0&&(_.auto_changed_status=!1,_.xmppstatus.setStatus(_.default_state)))},this.onEverySecond=function(){if(_.connection.authenticated){var e=_.xmppstatus.getStatus();_.idle_seconds++,_.csi_waiting_time>0&&_.idle_seconds>_.csi_waiting_time&&!_.inactive&&_.sendCSI(_.INACTIVE),_.auto_away>0&&_.idle_seconds>_.auto_away&&"away"!==e&&"xa"!==e&&"dnd"!==e?(_.auto_changed_status=!0,_.xmppstatus.setStatus("away")):_.auto_xa>0&&_.idle_seconds>_.auto_xa&&"xa"!==e&&"dnd"!==e&&(_.auto_changed_status=!0,_.xmppstatus.setStatus("xa"))}},this.registerIntervalHandler=function(){_.auto_away<1&&_.auto_xa<1&&_.csi_waiting_time<1||(_.idle_seconds=0,_.auto_changed_status=!1,t(window).on("click mousemove keypress focus"+v,_.onUserActivity),_.everySecondTrigger=window.setInterval(_.onEverySecond,1e3))},this.giveFeedback=function(e,n,i){t(".conn-feedback").each(function(t,i){i.classList.add("conn-feedback"),i.textContent=e,n?i.classList.add(n):i.classList.remove("error")}),_.emit("feedback",{klass:n,message:i,subject:e})},this.rejectPresenceSubscription=function(e,t){var n=h({to:e,type:"unsubscribed"});t&&""!==t&&n.c("status").t(t),_.connection.send(n)},this.reconnect=n.debounce(function(){_.log("RECONNECTING"),_.log("The connection has dropped, attempting to reconnect."),_.giveFeedback(b("Reconnecting"),"warn",b("The connection has dropped, attempting to reconnect.")),_.connection.reconnecting=!0,_._tearDown(),_.logIn(null,!0)},3e3,{leading:!0}),this.disconnect=function(){_.log("DISCONNECTED"),delete _.connection.reconnecting,_.connection.reset(),_._tearDown(),_.chatboxviews.closeAllChatBoxes(),_.emit("disconnected")},this.onDisconnected=function(){return _.disconnection_cause===a.Status.AUTHFAIL?_.credentials_url&&_.auto_reconnect?(_.emit("will-reconnect"),_.reconnect()):_.disconnect():_.disconnection_cause!==_.LOGOUT&&"host-unknown"!==_.disconnection_reason&&_.auto_reconnect?(_.emit("will-reconnect"),void _.reconnect()):_.disconnect()},this.setDisconnectionCause=function(e,t,i){n.isUndefined(e)?(delete _.disconnection_cause,delete _.disconnection_reason):(n.isUndefined(_.disconnection_cause)||i)&&(_.disconnection_cause=e,_.disconnection_reason=t)},this.onConnectStatusChanged=function(e,t){_.log("Status changed to: "+m[e]),e===a.Status.CONNECTED||e===a.Status.ATTACHED?(_.send_initial_presence=!0,_.setDisconnectionCause(),_.connection.reconnecting?(_.log(e===a.Status.CONNECTED?"Reconnected":"Reattached"),_.onConnected(!0)):(_.log(e===a.Status.CONNECTED?"Connected":"Attached"),_.connection.restored&&(_.send_initial_presence=!1),_.onConnected())):e===a.Status.DISCONNECTED?(_.setDisconnectionCause(e,t),_.onDisconnected()):e===a.Status.ERROR?_.giveFeedback(b("Connection error"),"error",b("An error occurred while connecting to the chat server.")):e===a.Status.CONNECTING?_.giveFeedback(b("Connecting")):e===a.Status.AUTHENTICATING?_.giveFeedback(b("Authenticating")):e===a.Status.AUTHFAIL?(_.giveFeedback(b("Authentication Failed"),"error"),_.setDisconnectionCause(e,t,!0),_.onDisconnected()):e===a.Status.CONNFAIL?(_.giveFeedback(b("Connection failed"),"error",b("An error occurred while connecting to the chat server: "+t)),_.setDisconnectionCause(e,t)):e===a.Status.DISCONNECTING&&_.setDisconnectionCause(e,t)},this.updateMsgCounter=function(){this.msg_counter>0?document.title.search(/^Messages \(\d+\) /)===-1?document.title="Messages ("+this.msg_counter+") "+document.title:document.title=document.title.replace(/^Messages \(\d+\) /,"Messages ("+this.msg_counter+") "):document.title.search(/^Messages \(\d+\) /)!==-1&&(document.title=document.title.replace(/^Messages \(\d+\) /,""))},this.incrementMsgCounter=function(){this.msg_counter+=1,this.updateMsgCounter()},this.clearMsgCounter=function(){this.msg_counter=0,this.updateMsgCounter()},this.initStatus=function(){var e=new t.Deferred;this.xmppstatus=new this.XMPPStatus;var n=p("converse.xmppstatus-"+_.bare_jid);return this.xmppstatus.id=n,this.xmppstatus.browserStorage=new Backbone.BrowserStorage[_.storage](n),this.xmppstatus.fetch({success:e.resolve,error:e.resolve}),_.emit("statusInitialized"),e.promise()},this.initSession=function(){this.session=new this.Session;var e=p("converse.bosh-session");this.session.id=e,this.session.browserStorage=new Backbone.BrowserStorage[_.storage](e),this.session.fetch()},this.clearSession=function(){n.isUndefined(this.roster)||this.roster.browserStorage._clear(),this.session.browserStorage._clear()},this.logOut=function(){_.setDisconnectionCause(_.LOGOUT,void 0,!0),n.isUndefined(_.connection)||_.connection.disconnect(),_.chatboxviews.closeAllChatBoxes(),_.clearSession(),_._tearDown(),_.emit("logout")},this.saveWindowState=function(e,t){var n,i="visible",o="hidden",s={focus:i,focusin:i,pageshow:i,blur:o,focusout:o,pagehide:o};e=e||document.createEvent("Events"),n=e.type in s?s[e.type]:document[t]?"hidden":"visible","visible"===n&&_.clearMsgCounter(),_.windowState=n},this.registerGlobalEventHandlers=function(){var e="hidden";e in document?document.addEventListener("visibilitychange",n.partial(_.saveWindowState,n,e)):(e="mozHidden")in document?document.addEventListener("mozvisibilitychange",n.partial(_.saveWindowState,n,e)):(e="webkitHidden")in document?document.addEventListener("webkitvisibilitychange",n.partial(_.saveWindowState,n,e)):(e="msHidden")in document?document.addEventListener("msvisibilitychange",n.partial(_.saveWindowState,n,e)):"onfocusin"in document?document.onfocusin=document.onfocusout=n.partial(_.saveWindowState,n,e):window.onpageshow=window.onpagehide=window.onfocus=window.onblur=n.partial(_.saveWindowState,n,e),void 0!==document[e]&&n.partial(_.saveWindowState,n,e)({type:document[e]?"blur":"focus"})},this.enableCarbons=function(){if(this.message_carbons&&!this.session.get("carbons_enabled")){var e=new a.Builder("iq",{from:this.connection.jid,id:"enablecarbons",type:"set"}).c("enable",{xmlns:a.NS.CARBONS});this.connection.addHandler(function(e){e.querySelectorAll("error").length>0?_.log("ERROR: An error occured while trying to enable message carbons."):(this.session.save({carbons_enabled:!0}),_.log("Message carbons have been enabled."))}.bind(this),null,"iq",null,"enablecarbons"),this.connection.send(e)}},this.initRoster=function(){_.roster=new _.RosterContacts,_.roster.browserStorage=new Backbone.BrowserStorage.session(p("converse.contacts-"+_.bare_jid)),_.rostergroups=new _.RosterGroups,_.rostergroups.browserStorage=new Backbone.BrowserStorage.session(p("converse.roster.groups"+_.bare_jid)),_.emit("rosterInitialized")},this.populateRoster=function(){
_.rostergroups.fetchRosterGroups().then(function(){_.emit("rosterGroupsFetched"),_.roster.fetchRosterContacts().then(function(){_.emit("rosterContactsFetched"),_.sendInitialPresence()})})},this.unregisterPresenceHandler=function(){n.isUndefined(_.presence_ref)||(_.connection.deleteHandler(_.presence_ref),delete _.presence_ref)},this.registerPresenceHandler=function(){_.unregisterPresenceHandler(),_.presence_ref=_.connection.addHandler(function(e){return _.roster.presenceHandler(e),!0},null,"presence",null)},this.sendInitialPresence=function(){_.send_initial_presence&&_.xmppstatus.sendPresence()},this.onStatusInitialized=function(e){e?_.emit("rosterReadyAfterReconnection"):(_.registerIntervalHandler(),_.initRoster()),_.chatboxes.onConnected(),_.populateRoster(),_.registerPresenceHandler(),_.giveFeedback(b("Contacts")),e?_.xmppstatus.sendPresence():(d.resolve(),_.emit("initialized"))},this.setUserJid=function(){_.jid=_.connection.jid,_.bare_jid=a.getBareJidFromJid(_.connection.jid),_.resource=a.getResourceFromJid(_.connection.jid),_.domain=a.getDomainFromJid(_.connection.jid)},this.onConnected=function(e){_.connection.flush(),_.setUserJid(),_.enableCarbons(),e=!n.isUndefined(_.xmppstatus)&&e,e?(_.onStatusInitialized(!0),_.emit("reconnected")):(_.chatboxviews.closeAllChatBoxes(),_.features=new _.Features,_.initStatus().done(n.partial(_.onStatusInitialized,!1)),_.emit("connected"))},this.RosterContact=Backbone.Model.extend({initialize:function(e){var t=e.jid,i=a.getBareJidFromJid(t).toLowerCase(),o=a.getResourceFromJid(t);e.jid=i,this.set(n.assignIn({id:i,jid:i,fullname:i,chat_status:"offline",user_id:a.getNodeFromJid(t),resources:o?{resource:0}:{},groups:[],image_type:f,image:g,status:""},e)),this.on("destroy",function(){this.removeFromRoster()}.bind(this)),this.on("change:chat_status",function(e){_.emit("contactStatusChanged",e.attributes)})},subscribe:function(e){this.save("ask","subscribe");var t=h({to:this.get("jid"),type:"subscribe"});e&&""!==e&&t.c("status").t(e).up();var n=_.xmppstatus.get("fullname");return n&&""!==n&&t.c("nick",{xmlns:a.NS.NICK}).t(n).up(),_.connection.send(t),this},ackSubscribe:function(){_.connection.send(h({type:"subscribe",to:this.get("jid")}))},ackUnsubscribe:function(){_.connection.send(h({type:"unsubscribe",to:this.get("jid")})),this.destroy()},unauthorize:function(e){return _.rejectPresenceSubscription(this.get("jid"),e),this},authorize:function(e){var t=h({to:this.get("jid"),type:"subscribed"});return e&&""!==e&&t.c("status").t(e),_.connection.send(t),this},addResource:function(e){var t=e.getAttribute("from"),i=n.propertyOf(e.querySelector("show"))("textContent")||"online",o=a.getResourceFromJid(t),s=n.propertyOf(e.querySelector("priority"))("textContent")||0,l=e.querySelector('delay[xmlns="'+a.NS.DELAY+'"]'),c=n.isNull(l)?r().format():r(l.getAttribute("stamp")).format();s=n.isNaN(parseInt(s,10))?0:parseInt(s,10);var u=n.isObject(this.get("resources"))?this.get("resources"):{};u[o]={priority:s,status:i,timestamp:c};var d={resources:u},h=this.getHighestPriorityResource();return s==h.priority&&c==h.timestamp&&(d.chat_status=i),this.save(d),u},removeResource:function(e){var t=this.get("resources");n.isObject(t)?delete t[e]:t={},this.save({resources:t,chat_status:n.propertyOf(this.getHighestPriorityResource())("status")||"offline"})},getHighestPriorityResource:function(){var e=this.get("resources");if(n.isObject(e)&&n.size(e)){var t=n.flow(n.values,n.partial(n.sortBy,n,["priority","timestamp"]),n.reverse)(e)[0];if(!n.isUndefined(t))return t}},removeFromRoster:function(e){var t=u({type:"set"}).c("query",{xmlns:a.NS.ROSTER}).c("item",{jid:this.get("jid"),subscription:"remove"});return _.connection.sendIQ(t,e,e),this}}),this.RosterContacts=Backbone.Collection.extend({model:_.RosterContact,comparator:function(e,t){var n,i,o=e.get("chat_status")||"offline",s=t.get("chat_status")||"offline";return _.STATUS_WEIGHTS[o]===_.STATUS_WEIGHTS[s]?(n=e.get("fullname").toLowerCase(),i=t.get("fullname").toLowerCase(),n<i?-1:n>i?1:0):_.STATUS_WEIGHTS[o]<_.STATUS_WEIGHTS[s]?-1:1},fetchRosterContacts:function(){var e=new t.Deferred;return this.fetch({add:!0,success:function(t){0===t.length?(_.send_initial_presence=!0,_.roster.fetchFromServer(e.resolve)):(_.emit("cachedRoster",t),e.resolve())}}),e.promise()},subscribeToSuggestedItems:function(e){return n.each(e.querySelectorAll("item"),function(e){"add"===e.getAttribute("action")&&_.roster.addAndSubscribe(e.getAttribute("jid"),null,_.xmppstatus.get("fullname"))}),!0},isSelf:function(e){return a.getBareJidFromJid(e)===a.getBareJidFromJid(_.connection.jid)},addAndSubscribe:function(e,t,n,i,o){this.addContact(e,t,n,o).done(function(e){e instanceof _.RosterContact&&e.subscribe(i)})},sendContactAddIQ:function(e,t,i,o,s){t=n.isEmpty(t)?e:t;var r=u({type:"set"}).c("query",{xmlns:a.NS.ROSTER}).c("item",{jid:e,name:t});n.each(i,function(e){r.c("group").t(e).up()}),_.connection.sendIQ(r,o,s)},addContact:function(e,i,o,s){var r=new t.Deferred;return o=o||[],i=n.isEmpty(i)?e:i,this.sendContactAddIQ(e,i,o,function(){var t=this.create(n.assignIn({ask:void 0,fullname:i,groups:o,jid:e,requesting:!1,subscription:"none"},s),{sort:!1});r.resolve(t)}.bind(this),function(e){alert(b("Sorry, there was an error while trying to add "+i+" as a contact.")),_.log(e),r.resolve(e)}),r.promise()},subscribeBack:function(e){var t=this.get(e);t instanceof _.RosterContact?t.authorize().subscribe():this.addContact(e,"",[],{subscription:"from"}).done(function(e){e instanceof _.RosterContact&&e.authorize().subscribe()})},getNumOnlineContacts:function(){var e,t=0,i=["offline","unavailable"],o=this.models,s=o.length;for(_.show_only_online_users&&(i=n.union(i,["dnd","xa","away"])),e=0;e<s;e++)n.includes(i,o[e].get("chat_status"))||t++;return t},onRosterPush:function(t){var i=t.getAttribute("id"),o=t.getAttribute("from");if(o&&""!==o&&a.getBareJidFromJid(o)!==_.bare_jid)return _.connection.send(u({type:"error",id:i,from:_.connection.jid}).c("error",{type:"cancel"}).c("service-unavailable",{xmlns:a.NS.ROSTER})),!0;_.connection.send(u({type:"result",id:i,from:_.connection.jid}));var s=e('query[xmlns="'+a.NS.ROSTER+'"] item',t);return n.each(s,this.updateContact.bind(this)),_.emit("rosterPush",t),!0},fetchFromServer:function(e){var t=u({type:"get",id:_.connection.getUniqueId("roster")}).c("query",{xmlns:a.NS.ROSTER});return _.connection.sendIQ(t,function(){this.onReceivedFromServer.apply(this,arguments),e.apply(this,arguments)}.bind(this))},onReceivedFromServer:function(t){var i=e('query[xmlns="'+a.NS.ROSTER+'"] item',t);n.each(i,this.updateContact.bind(this)),_.emit("roster",t)},updateContact:function(e){var t=e.getAttribute("jid");if(!this.isSelf(t)){var i=n.map(e.getElementsByTagName("group"),a.getText),o=this.get(t),s=e.getAttribute("ask"),r=e.getAttribute("subscription");if(o){if("remove"===r)return o.destroy();o.save({subscription:r,ask:s,requesting:null,groups:i})}else{if("none"===r&&null===s||"remove"===r)return;this.create({ask:s,fullname:e.getAttribute("name")||t,groups:i,jid:t,subscription:r},{sort:!1})}}},createRequestingContact:function(e){var t=a.getBareJidFromJid(e.getAttribute("from")),n=e.querySelector('nick[xmlns="'+a.NS.NICK+'"]'),i={jid:t,subscription:"none",ask:null,requesting:!0,fullname:n&&n.textContent||t};this.create(i),_.emit("contactRequest",i)},handleIncomingSubscription:function(e){var t=e.getAttribute("from"),n=a.getBareJidFromJid(t),i=this.get(n);_.allow_contact_requests||_.rejectPresenceSubscription(t,b("This client does not allow presence subscriptions")),_.auto_subscribe?i&&"to"===i.get("subscription")?i.authorize():this.subscribeBack(n):i?"none"!==i.get("subscription")?i.authorize():"subscribe"===i.get("ask")&&i.authorize():i||this.createRequestingContact(e)},presenceHandler:function(t){var i=t.getAttribute("type");if("error"===i)return!0;var o=t.getAttribute("from"),s=a.getBareJidFromJid(o),r=a.getResourceFromJid(o),l=n.propertyOf(t.querySelector("show"))("textContent")||"online",c=n.propertyOf(t.querySelector("status"))("textContent"),u=this.get(s);if(this.isSelf(s))return void(_.connection.jid===o||"unavailable"===i||_.synchronize_availability!==!0&&_.synchronize_availability!==r||(_.xmppstatus.save({status:l}),c&&_.xmppstatus.save({status_message:c})));if(!e('query[xmlns="'+a.NS.MUC+'"]',t).length)if(u&&c!==u.get("status")&&u.save({status:c}),"subscribed"===i&&u)u.ackSubscribe();else if("unsubscribed"===i&&u)u.ackUnsubscribe();else{if("unsubscribe"===i)return;"subscribe"===i?this.handleIncomingSubscription(t):"unavailable"===i&&u?u.removeResource(r):u&&u.addResource(t)}}}),this.RosterGroup=Backbone.Model.extend({initialize:function(e){this.set(n.assignIn({description:y,state:_.OPENED},e)),this.contacts=new _.RosterContacts}}),this.RosterGroups=Backbone.Collection.extend({model:_.RosterGroup,fetchRosterGroups:function(){var e=new t.Deferred;return this.fetch({silent:!0,success:e.resolve}),e.promise()}}),this.Message=Backbone.Model.extend({defaults:function(){return{msgid:_.connection.getUniqueId()}}}),this.Messages=Backbone.Collection.extend({model:_.Message,comparator:"time"}),this.ChatBox=Backbone.Model.extend({initialize:function(){this.messages=new _.Messages,this.messages.browserStorage=new Backbone.BrowserStorage[_.message_storage](p("converse.messages"+this.get("jid")+_.bare_jid)),this.save({box_id:p(this.get("jid")),chat_state:void 0,num_unread:this.get("num_unread")||0,time_opened:this.get("time_opened")||r().valueOf(),url:"",user_id:a.getNodeFromJid(this.get("jid"))})},getMessageAttributes:function(e,t,i){t=t||e.querySelector("delay");var o,s,l,c,u,d,h=e.getAttribute("type");o="error"===h?n.propertyOf(e.querySelector("error text"))("textContent"):n.propertyOf(e.querySelector("body"))("textContent");var p=!n.isNull(t),m="groupchat"===h,f=e.getElementsByTagName(_.COMPOSING).length&&_.COMPOSING||e.getElementsByTagName(_.PAUSED).length&&_.PAUSED||e.getElementsByTagName(_.INACTIVE).length&&_.INACTIVE||e.getElementsByTagName(_.ACTIVE).length&&_.ACTIVE||e.getElementsByTagName(_.GONE).length&&_.GONE;return u=m?a.unescapeNode(a.getResourceFromJid(e.getAttribute("from"))):a.getBareJidFromJid(e.getAttribute("from")),p?(s=t.getAttribute("stamp"),l=s):l=r().format(),m&&u===this.get("nick")||!m&&u===_.bare_jid?(c="me",d=_.xmppstatus.get("fullname")||u):(c="them",d=this.get("fullname")||u),{type:h,chat_state:f,delayed:p,fullname:d,message:o||void 0,msgid:e.getAttribute("id"),sender:c,time:l}},createMessage:function(e,t,n){return this.messages.create(this.getMessageAttributes.apply(this,arguments))}}),this.ChatBoxes=Backbone.Collection.extend({model:_.ChatBox,comparator:"time_opened",registerMessageHandler:function(){_.connection.addHandler(this.onMessage.bind(this),null,"message","chat"),_.connection.addHandler(this.onErrorMessage.bind(this),null,"message","error")},chatBoxMayBeShown:function(e){return!0},onChatBoxesFetched:function(e){var t=this;e.each(function(e){t.chatBoxMayBeShown(e)&&e.trigger("show")}),_.emit("chatBoxesFetched")},onConnected:function(){this.browserStorage=new Backbone.BrowserStorage[_.storage](p("converse.chatboxes-"+_.bare_jid)),this.registerMessageHandler(),this.fetch({add:!0,success:this.onChatBoxesFetched.bind(this)})},onErrorMessage:function(e){var t=a.getBareJidFromJid(e.getAttribute("from"));if(t===_.bare_jid)return!0;var n=this.getChatBox(t);return!n||(n.createMessage(e,null,e),!0)},onMessage:function(e){var t,i,o,r,l,c,u,d,h,p=e,m=e.getAttribute("from"),f=e.getAttribute("to"),g=a.getResourceFromJid(f),v=!n.isNull(e.querySelector('received[xmlns="'+a.NS.CARBONS+'"]'));if(_.filter_by_resource&&g&&g!==_.resource)return _.log("onMessage: Ignoring incoming message intended for a different resource: "+f,"info"),!0;if(s.isHeadlineMessage(e))return _.log("onMessage: Ignoring incoming headline message sent with type 'chat' from JID: "+m,"info"),!0;if(i=e.querySelector("forwarded"),!n.isNull(i)){var b=i.querySelector("message"),y=b.getAttribute("from");if(v&&a.getBareJidFromJid(y)!==m)return!0;e=b,o=i.querySelector("delay"),m=e.getAttribute("from"),f=e.getAttribute("to")}return r=a.getBareJidFromJid(m),l=a.getResourceFromJid(m),c=r===_.bare_jid,u=e.getAttribute("id"),c?(t=a.getBareJidFromJid(f),h=a.getResourceFromJid(f)):(t=r,h=l),_.emit("message",p),!(d=this.getChatBox(t,!n.isNull(e.querySelector("body"))))||(!(!u||!d.messages.findWhere({msgid:u}))||(d.createMessage(e,o,p),!0))},getChatBox:function(e,t,i){e=e.toLowerCase();var o=a.getBareJidFromJid(e),s=this.get(o);if(!s&&t){var r={},l=_.roster.get(o);if(n.isUndefined(l)){if(!_.allow_non_roster_messaging)return void _.log("Could not get roster item for JID "+o+" and allow_non_roster_messaging is set to false","error")}else r={fullname:n.isEmpty(l.get("fullname"))?e:l.get("fullname"),image_type:l.get("image_type"),image:l.get("image"),url:l.get("url")};s=this.create(n.assignIn({id:o,jid:o,fullname:e,image_type:f,image:g,url:""},r,i||{}))}return s}}),this.ChatBoxViews=Backbone.Overview.extend({initialize:function(){this.model.on("add",this.onChatBoxAdded,this),this.model.on("destroy",this.removeChat,this)},_ensureElement:function(){if(this.el)this.setElement(n.result(this,"el"),!1);else{var e=t("#conversejs");e.length||(e=t('<div id="conversejs">'),t("body").append(e)),e.html(""),this.setElement(e,!1)}},onChatBoxAdded:function(e){return this.get(e.get("id"))},removeChat:function(e){this.remove(e.get("id"))},closeAllChatBoxes:function(){return this.each(function(e){e.close()}),this},chatBoxMayBeShown:function(e){return this.model.chatBoxMayBeShown(e)},getChatBox:function(e,t){var n=this.model.get(e.jid);return!n&&t&&(n=this.model.create(e,{error:function(e,t){_.log(t.responseText)}})),n},showChat:function(e){var t=this.getChatBox(e,!0);return this.chatBoxMayBeShown(t)&&t.trigger("show",!0),t}}),this.XMPPStatus=Backbone.Model.extend({initialize:function(){this.set({status:this.getStatus()}),this.on("change",function(e){n.has(e.changed,"status")&&_.emit("statusChanged",this.get("status")),n.has(e.changed,"status_message")&&_.emit("statusMessageChanged",this.get("status_message"))}.bind(this))},constructPresence:function(e,t){var i;return e=n.isString(e)?e:this.get("status")||_.default_state,t=n.isString(t)?t:void 0,i="unavailable"===e||"probe"===e||"error"===e||"unsubscribe"===e||"unsubscribed"===e||"subscribe"===e||"subscribed"===e?h({type:e}):"offline"===e?h({type:"unavailable"}):"online"===e?h():h().c("show").t(e).up(),t&&i.c("status").t(t).up(),i.c("priority").t(n.isNaN(Number(_.priority))?0:_.priority),i},sendPresence:function(e,t){_.connection.send(this.constructPresence(e,t))},setStatus:function(e){this.sendPresence(e),this.save({status:e})},getStatus:function(){return this.get("status")||_.default_state},setStatusMessage:function(e){this.sendPresence(this.getStatus(),e);var n=this.get("status_message");this.save({status_message:e}),this.xhr_custom_status&&t.ajax({url:this.xhr_custom_status_url,type:"POST",data:{msg:e}}),n===e&&this.trigger("update-status-ui",this)}}),this.Session=Backbone.Model,this.Feature=Backbone.Model,this.Features=Backbone.Collection.extend({model:_.Feature,initialize:function(){this.addClientIdentities().addClientFeatures(),this.browserStorage=new Backbone.BrowserStorage[_.storage](p("converse.features"+_.bare_jid)),this.on("add",this.onFeatureAdded,this),0===this.browserStorage.records.length?(_.connection.disco.info(_.domain,null,this.onInfo.bind(this)),_.connection.disco.items(_.domain,null,this.onItems.bind(this))):this.fetch({add:!0})},onFeatureAdded:function(e){_.emit("serviceDiscovered",e)},addClientIdentities:function(){return _.connection.disco.addIdentity("client","web","Converse.js"),this},addClientFeatures:function(){return _.connection.disco.addFeature(a.NS.BOSH),_.connection.disco.addFeature(a.NS.CHATSTATES),_.connection.disco.addFeature(a.NS.DISCO_INFO),_.connection.disco.addFeature(a.NS.ROSTERX),_.message_carbons&&_.connection.disco.addFeature(a.NS.CARBONS),this},onItems:function(e){var t=this;n.each(e.querySelectorAll("query item"),function(e){_.connection.disco.info(e.getAttribute("jid"),null,t.onInfo.bind(t))})},onInfo:function(e){var n=t(e);0===n.find("identity[category=server][type=im]").length&&0===n.find("identity[category=conference][type=text]").length||n.find("feature").each(function(t,n){var i=n.getAttribute("var");this[i]=!0,this.create({var:i,from:e.getAttribute("from")})}.bind(this))}}),this.setUpXMLLogging=function(){a.log=function(e,t){_.log(t,e)},this.debug&&(this.connection.xmlInput=function(e){_.log(e.outerHTML)},this.connection.xmlOutput=function(e){_.log(e.outerHTML)})},this.fetchLoginCredentials=function(){var e=new t.Deferred;return t.ajax({url:_.credentials_url,type:"GET",dataType:"json",success:function(t){e.resolve({jid:t.jid,password:t.password})},error:function(t){delete _.connection,_.emit("noResumeableSession"),e.reject(t)}}),e.promise()},this.startNewBOSHSession=function(){var e=this;t.ajax({url:this.prebind_url,type:"GET",dataType:"json",success:function(t){e.connection.attach(t.jid,t.sid,t.rid,e.onConnectStatusChanged)},error:function(t){delete e.connection,e.emit("noResumeableSession")}})},this.attemptPreboundSession=function(e){if(!e&&this.keepalive){if(!this.jid)throw new Error("attemptPreboundSession: when using 'keepalive' with 'prebind, you must supply the JID of the current user.");try{return this.connection.restore(this.jid,this.onConnectStatusChanged)}catch(e){this.log("Could not restore session for jid: "+this.jid+" Error message: "+e.message),this.clearSession()}}if(!e&&this.jid&&this.sid&&this.rid)return this.connection.attach(this.jid,this.sid,this.rid,this.onConnectStatusChanged);if(this.prebind_url)return this.startNewBOSHSession();throw new Error("attemptPreboundSession: If you use prebind and not keepalive, then you MUST supply JID, RID and SID values or a prebind_url.")},this.autoLogin=function(e){if(e&&(this.jid=e.jid,this.password=e.password),this.authentication===_.ANONYMOUS){if(!this.jid)throw new Error("Config Error: when using anonymous login you need to provide the server's domain via the 'jid' option. Either when calling converse.initialize, or when calling _converse.api.user.login.");this.connection.reset(),this.connection.connect(this.jid.toLowerCase(),null,this.onConnectStatusChanged)}else if(this.authentication===_.LOGIN){var t=_.connection.pass||this.password;if(!t){if(this.auto_login&&!this.password)throw new Error("initConnection: If you use auto_login and authentication='login' then you also need to provide a password.");return _.setDisconnectionCause(a.Status.AUTHFAIL,void 0,!0),void _.disconnect()}var n=a.getResourceFromJid(this.jid);n?this.jid=a.getBareJidFromJid(this.jid).toLowerCase()+"/"+n:this.jid=this.jid.toLowerCase()+_.generateResource(),this.connection.reset(),this.connection.connect(this.jid,t,this.onConnectStatusChanged)}},this.attemptNonPreboundSession=function(e,t){if(this.keepalive&&!t)try{return this.connection.restore(this.jid,this.onConnectStatusChanged)}catch(e){this.log("Could not restore session. Error message: "+e.message),this.clearSession()}if(this.auto_login)if(e)this.autoLogin(e);else if(this.credentials_url)this.fetchLoginCredentials().done(this.autoLogin.bind(this));else{if(!this.jid)throw new Error("initConnection: If you use auto_login, you also needto give either a jid value (and if applicable a password) or you need to pass in a URL from where the username and password can be fetched (via credentials_url).");this.autoLogin()}else t&&this.autoLogin()},this.logIn=function(e,t){this.authentication===_.PREBIND?this.attemptPreboundSession(t):this.attemptNonPreboundSession(e,t)},this.initConnection=function(){if(!this.connection){if(!this.bosh_service_url&&!this.websocket_url)throw new Error("initConnection: you must supply a value for either the bosh_service_url or websocket_url or both.");if(("WebSocket"in window||"MozWebSocket"in window)&&this.websocket_url)this.connection=new a.Connection(this.websocket_url,this.connection_options);else{if(!this.bosh_service_url)throw new Error("initConnection: this browser does not support websockets and bosh_service_url wasn't specified.");this.connection=new a.Connection(this.bosh_service_url,n.assignIn(this.connection_options,{keepalive:this.keepalive}))}}},this._tearDown=function(){return this.unregisterPresenceHandler(),this.roster&&this.roster.off().reset(),this.chatboxes.remove(),delete this.chatboxes.browserStorage,this.features&&this.features.reset(),t(window).off("click mousemove keypress focus"+v,_.onUserActivity),window.clearInterval(_.everySecondTrigger),this},this.initChatBoxes=function(){this.chatboxes=new this.ChatBoxes,this.chatboxviews=new this.ChatBoxViews({model:this.chatboxes})};var w=function(e){s.merge(_.default_settings,e),s.merge(_,e),s.applyUserSettings(_,e,_.user_settings)};return this.initPlugins=function(){_.pluggable.initialized_plugins=[];var e=_.core_plugins.concat(_.whitelisted_plugins);_.pluggable.initializePlugins({updateSettings:w,_converse:_},e,_.blacklisted_plugins),_.emit("pluginsInitialized")},i.connection&&(this.connection=i.connection),_.initPlugins(),_.initChatBoxes(),_.initSession(),_.initConnection(),_.setUpXMLLogging(),_.logIn(),_.registerGlobalEventHandlers(),n.isUndefined(_.connection)||"jasmine tests"!==_.connection.service?d.promise():_},_.api={connection:{connected:function(){return _.connection&&_.connection.connected||!1},disconnect:function(){_.connection.disconnect()}},user:{jid:function(){return _.connection.jid},login:function(e){_.initConnection(),_.logIn(e)},logout:function(){_.logOut()},status:{get:function(){return _.xmppstatus.get("status")},set:function(e,t){var i={status:e};if(!n.includes(n.keys(_.STATUS_WEIGHTS),e))throw new Error("Invalid availability value. See https://xmpp.org/rfcs/rfc3921.html#rfc.section.2.2.2.1");n.isString(t)&&(i.status_message=t),_.xmppstatus.sendPresence(e),_.xmppstatus.save(i)},message:{get:function(){return _.xmppstatus.get("status_message")},set:function(e){_.xmppstatus.save({status_message:e})}}}},settings:{get:function(e){if(n.includes(n.keys(_.default_settings),e))return _[e]},set:function(e,t){var i={};n.isObject(e)?n.assignIn(_,n.pick(e,n.keys(_.default_settings))):n.isString("string")&&(i[e]=t,n.assignIn(_,n.pick(i,n.keys(_.default_settings))))}},contacts:{get:function(e){var t=function(e){var t=_.roster.get(a.getBareJidFromJid(e));return t?t.attributes:null};if(n.isUndefined(e))e=_.roster.pluck("jid");else if(n.isString(e))return t(e);return n.map(e,t)},add:function(e,t){if(!n.isString(e)||!n.includes(e,"@"))throw new TypeError("contacts.add: invalid jid");_.roster.addAndSubscribe(e,n.isEmpty(t)?e:t)}},chats:{open:function(e,t){var i;return n.isUndefined(e)?(_.log("chats.open: You need to provide at least one JID","error"),null):n.isString(e)?i=_.getViewForChatBox(_.chatboxes.getChatBox(e,!0,t).trigger("show")):n.map(e,function(e){return i=_.getViewForChatBox(_.chatboxes.getChatBox(e,!0,t).trigger("show"))})},get:function(e){if(n.isUndefined(e)){var t=[];return _.chatboxes.each(function(e){"chatroom"!==e.get("type")&&t.push(_.getViewForChatBox(e))}),t}return n.isString(e)?_.getViewForChatBox(_.chatboxes.getChatBox(e)):n.map(e,n.partial(n.flow(_.chatboxes.getChatBox.bind(_.chatboxes),_.getViewForChatBox.bind(_)),n,!0))}},tokens:{get:function(e){return!_.expose_rid_and_sid||n.isUndefined(_.connection)?null:"rid"===e.toLowerCase()?_.connection.rid||_.connection._proto.rid:"sid"===e.toLowerCase()?_.connection.sid||_.connection._proto.sid:void 0}},listen:{once:_.once.bind(_),on:_.on.bind(_),not:_.off.bind(_),stanza:function(e,t,i){n.isFunction(t)?(i=t,t={}):t=t||{},_.connection.addHandler(i,t.ns,e,t.type,t.id,t.from,t)}},waitUntil:function(e){var t=_.promises[e];return n.isUndefined(t)?null:_.promises[e].promise()},send:function(e){_.connection.send(e)}},{initialize:function(e,t){return _.initialize(e,t)},plugins:{add:function(e,t){if(t.__name__=e,!n.isUndefined(_.pluggable.plugins[e]))throw new TypeError('Error: plugin with name "'+e+'" has already been registered!');_.pluggable.plugins[e]=t}},env:{$build:c,$iq:u,$msg:d,$pres:h,Strophe:a,b64_sha1:p,_:n,jQuery:t,sizzle:e,moment:r,utils:s}}}),define("tpl!chatbox",["lodash"],function(_){return function(obj){function print(){__p+=__j.call(arguments,"")}obj||(obj={});var __t,__p="",__e=_.escape,__j=Array.prototype.join;with(obj)__p+='<div class="flyout box-flyout">\n    <div class="dragresize dragresize-top"></div>\n    <div class="dragresize dragresize-topleft"></div>\n    <div class="dragresize dragresize-left"></div>\n    <div class="chat-head chat-head-chatbox">\n        <a class="chatbox-btn close-chatbox-button icon-close" title="'+__e(info_close)+'"></a>\n        <div class="chat-title">\n            ',url&&(__p+='\n                <a href="'+__e(url)+'" target="_blank" rel="noopener" class="user">\n            '),__p+="\n                    "+__e(title)+"\n            ",url&&(__p+="\n                </a>\n            "),__p+='\n            <p class="user-custom-message"><p/>\n        </div>\n    </div>\n    <div class="chat-body">\n        <div class="chat-content ',show_send_button&&(__p+="chat-content-sendbutton"),__p+='"></div>\n        <div class="new-msgs-indicator hidden">▼ '+__e(unread_msgs)+" ▼</div>\n        ",show_textarea&&(__p+='\n        <form class="sendXMPPMessage" action="" method="post">\n            ',show_toolbar&&(__p+='\n                <ul class="chat-toolbar no-text-select"></ul>\n            '),__p+='\n        <textarea\n            type="text"\n            class="chat-textarea ',show_send_button&&(__p+="chat-textarea-send-button"),__p+='"\n            placeholder="'+__e(label_personal_message)+'"/>\n\n        ',show_send_button&&(__p+='\n            <button type="button" class="pure-button send-button">Send</button>\n        '),__p+="\n        </form>\n        "),__p+="\n    </div>\n</div>\n";return __p}}),define("tpl!new_day",["lodash"],function(_){return function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj)__p+='<time class="chat-info chat-date" data-isodate="'+__e(isodate)+'">'+__e(datestring)+"</time>\n";return __p}}),define("tpl!action",["lodash"],function(_){return function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj)__p+='<div class="chat-message '+__e(extra_classes)+'" data-isodate="'+__e(isodate)+'">\n    <span class="chat-msg-author chat-msg-'+__e(sender)+'">'+__e(time)+" **"+__e(username)+'&nbsp;</span>\n    <span class="chat-msg-content chat-action"><!-- message gets added here via renderMessage --></span>\n</div>\n';return __p}}),define("tpl!message",["lodash"],function(_){return function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj)__p+='<div class="chat-message '+__e(extra_classes)+'" data-isodate="'+__e(isodate)+'" data-msgid="'+__e(msgid)+'">\n    <span class="chat-msg-author chat-msg-'+__e(sender)+'">'+__e(time)+" "+__e(username)+':&nbsp;</span>\n    <span class="chat-msg-content"><!-- message gets added here via renderMessage --></span>\n</div>\n';return __p}}),define("tpl!toolbar",["lodash"],function(_){return function(obj){function print(){__p+=__j.call(arguments,"")}obj||(obj={});var __t,__p="",__e=_.escape,__j=Array.prototype.join;with(obj)show_emoticons&&(__p+='\n    <li class="toggle-smiley icon-happy" title="'+__e(label_insert_smiley)+'">\n        <ul>\n            <li><a class="icon-smiley" href="#" data-emoticon=":)"></a></li>\n            <li><a class="icon-wink" href="#" data-emoticon=";)"></a></li>\n            <li><a class="icon-grin" href="#" data-emoticon=":D"></a></li>\n            <li><a class="icon-tongue" href="#" data-emoticon=":P"></a></li>\n            <li><a class="icon-cool" href="#" data-emoticon="8)"></a></li>\n            <li><a class="icon-evil" href="#" data-emoticon=">:)"></a></li>\n            <li><a class="icon-confused" href="#" data-emoticon=":S"></a></li>\n            <li><a class="icon-wondering" href="#" data-emoticon=":\\"></a></li>\n            <li><a class="icon-angry" href="#" data-emoticon=">:("></a></li>\n            <li><a class="icon-sad" href="#" data-emoticon=":("></a></li>\n            <li><a class="icon-shocked" href="#" data-emoticon=":O"></a></li>\n            <li><a class="icon-thumbs-up" href="#" data-emoticon="(^.^)b"></a></li>\n            <li><a class="icon-heart" href="#" data-emoticon="<3"></a></li>\n        </ul>\n    </li>\n'),__p+="\n",show_call_button&&(__p+='\n<li class="toggle-call"><a class="icon-phone" title="'+__e(label_start_call)+'"></a></li>\n'),__p+="\n",show_clear_button&&(__p+='\n<li class="toggle-clear"><a class="icon-remove" title="'+__e(label_clear)+'"></a></li>\n'),__p+="\n";return __p}}),define("tpl!avatar",["lodash"],function(_){return function(obj){obj||(obj={});var __t,__p="";with(obj)__p+='<canvas height="32px" width="32px" class="avatar"></canvas>\n';return __p}}),function(e,t){define("converse-chatview",["converse-core","tpl!chatbox","tpl!new_day","tpl!action","tpl!message","tpl!toolbar","tpl!avatar"],t)}(this,function(e,t,n,i,o,s,r){"use strict";var a=e.env.jQuery,l=e.env.utils,c=e.env.Strophe,u=e.env.$msg,d=e.env._,h=e.env.moment,p={ENTER:13,FORWARD_SLASH:47};return e.plugins.add("converse-chatview",{overrides:{ChatBoxViews:{onChatBoxAdded:function(e){var t=this.__super__._converse,n=this.get(e.get("id"));return n?this.__super__.onChatBoxAdded.apply(this,arguments):(n=new t.ChatBoxView({model:e}),this.add(e.get("id"),n),n)}}},initialize:function(){var e=this._converse,_=e.__;this.updateSettings({chatview_avatar_height:32,chatview_avatar_width:32,show_toolbar:!0,time_format:"HH:mm",visible_toolbar_buttons:{emoticons:!0,call:!1,clear:!0}}),e.ChatBoxView=Backbone.View.extend({length:200,tagName:"div",className:"chatbox hidden",is_chatroom:!1,events:{"click .close-chatbox-button":"close","keypress .chat-textarea":"keyPressed","click .send-button":"onSendButtonClicked","click .toggle-smiley":"toggleEmoticonMenu","click .toggle-smiley ul li":"insertEmoticon","click .toggle-clear":"clearMessages","click .toggle-call":"toggleCall","click .new-msgs-indicator":"viewUnreadMessages"},initialize:function(){this.model.messages.on("add",this.onMessageAdded,this),this.model.on("show",this.show,this),this.model.on("destroy",this.hide,this),this.model.on("change:chat_state",this.sendChatState,this),this.model.on("change:chat_status",this.onChatStatusChanged,this),this.model.on("change:image",this.renderAvatar,this),this.model.on("change:status",this.onStatusChanged,this),this.model.on("showHelpMessages",this.showHelpMessages,this),this.model.on("sendMessage",this.sendMessage,this),this.render().fetchMessages(),e.emit("chatBoxInitialized",this)},render:function(){return this.$el.attr("id",this.model.get("box_id")).html(t(d.extend(this.model.toJSON(),{show_toolbar:e.show_toolbar,show_textarea:!0,show_send_button:e.show_send_button,title:this.model.get("fullname"),unread_msgs:_("You have unread messages"),info_close:_("Close this chat box"),label_personal_message:_("Personal message")}))),this.$content=this.$el.find(".chat-content"),this.renderToolbar().renderAvatar(),e.emit("chatBoxOpened",this),l.refreshWebkit(),this.showStatusMessage()},afterMessagesFetched:function(){this.insertIntoDOM(),this.scrollDown(),this.$content.on("scroll",this.markScrolled.bind(this))},fetchMessages:function(){return this.model.messages.fetch({add:!0,success:this.afterMessagesFetched.bind(this),error:this.afterMessagesFetched.bind(this)}),this},insertIntoDOM:function(){var e=document.querySelector("#conversejs");return this.el.parentNode!==e&&e.insertBefore(this.el,e.firstChild),this},clearStatusNotification:function(){this.$content.find("div.chat-event").remove()},showStatusNotification:function(e,t,n){t||this.clearStatusNotification();var i=a('<div class="chat-info"></div>').text(e);n||i.addClass("chat-event"),this.$content.append(i),this.scrollDown()},addSpinner:function(){d.isNull(this.el.querySelector(".spinner"))&&this.$content.prepend('<span class="spinner"/>')},clearSpinner:function(){this.$content.children(":first").is("span.spinner")&&this.$content.children(":first").remove();
},insertDayIndicator:function(e,t){var i=h(e).startOf("day"),o=t?this.$content.prepend:this.$content.append;o.call(this.$content,n({isodate:i.format(),datestring:i.format("dddd MMM Do YYYY")}))},insertMessage:function(e,t){var n=this,i=t?this.$content.prepend:this.$content.append;d.flow(function(e){return i.call(n.$content,e),e},this.scrollDown.bind(this))(this.renderMessage(e))},showMessage:function(e){var t,n,i=this.$content.find(".chat-message:first"),o=i.data("isodate"),s=h(e.time)||h,r=this.$content.find(".chat-message:last").data("isodate");return o?s.isAfter(r)||s.isSame(r)?(s.isAfter(r,"day")&&this.insertDayIndicator(s),void this.insertMessage(e)):s.isBefore(o)||s.isSame(o)?(this.insertMessage(e,"prepend"),void(s.isBefore(o,"day")&&this.insertDayIndicator(s,"prepend"))):(s=s.format(),t=d.map(this.$content.find(".chat-message"),function(e){return a(e).data("isodate")}),t.push(s),t.sort(),n=t.indexOf(s)-1,void d.flow(function(e){return e.insertAfter(this.$content.find('.chat-message[data-isodate="'+t[n]+'"]')),e}.bind(this),this.scrollDown.bind(this))(this.renderMessage(e))):(this.insertDayIndicator(s),void this.insertMessage(e))},getExtraMessageTemplateAttributes:function(){return{}},getExtraMessageClasses:function(e){return e.delayed&&"delayed"||""},renderMessage:function(t){var n,s,r=h(t.time)||h,l=t.message,c=l.match(/^\/(.*?)(?: (.*))?$/),u=this.model.get("fullname")||t.fullname;c&&"me"===c[1]?(l=l.replace(/^\/me/,""),n=i,"me"===t.sender?(u=e.xmppstatus.get("fullname")||t.fullname,s=d.isNil(u)?e.bare_jid:u):s=t.fullname):(n=o,s="me"===t.sender&&_("me")||u),this.$content.find("div.chat-event").remove(),l.length>8e3&&(l=l.substring(0,10)+"...",this.showStatusNotification(_("A very large message has been received.This might be due to an attack meant to degrade the chat performance.Output has been shortened."),!0,!0));var p=a(n(d.extend(this.getExtraMessageTemplateAttributes(t),{msgid:t.msgid,sender:t.sender,time:r.format(e.time_format),isodate:r.format(),username:s,extra_classes:this.getExtraMessageClasses(t)})));return p.find(".chat-msg-content").first().text(l).addHyperlinks().addEmoticons(e.visible_toolbar_buttons.emoticons),p},showHelpMessages:function(e,t,n){var i,o=e.length;for(i=0;i<o;i++)this.$content.append(a('<div class="chat-'+(t||"info")+'">'+e[i]+"</div>"));return n===!0?this.$content.append('<span class="spinner"/>'):n===!1&&this.$content.find("span.spinner").remove(),this.scrollDown()},handleChatStateMessage:function(t){t.get("chat_state")===e.COMPOSING?("me"===t.get("sender")?this.showStatusNotification(_("Typing from another device")):this.showStatusNotification(t.get("fullname")+" "+_("is typing")),this.clear_status_timeout=window.setTimeout(this.clearStatusNotification.bind(this),3e4)):t.get("chat_state")===e.PAUSED?"me"===t.get("sender")?this.showStatusNotification(_("Stopped typing on the other device")):this.showStatusNotification(t.get("fullname")+" "+_("has stopped typing")):d.includes([e.INACTIVE,e.ACTIVE],t.get("chat_state"))?this.$content.find("div.chat-event").remove():t.get("chat_state")===e.GONE&&this.showStatusNotification(t.get("fullname")+" "+_("has gone away"))},shouldShowOnTextMessage:function(){return!this.$el.is(":visible")},updateNewMessageIndicators:function(t){t.get("archive_id")||(this.model.get("scrolled",!0)&&this.$el.find(".new-msgs-indicator").removeClass("hidden"),("hidden"===e.windowState||this.model.get("scrolled",!0))&&e.incrementMsgCounter())},handleTextMessage:function(e){this.showMessage(d.clone(e.attributes)),"me"!==e.get("sender")?this.updateNewMessageIndicators(e):this.model.set("scrolled",!1),this.shouldShowOnTextMessage()?this.show():this.scrollDown()},handleErrorMessage:function(e){var t=a("[data-msgid="+e.get("msgid")+"]");t.length&&(t.after(a('<div class="chat-info chat-error"></div>').text(e.get("message"))),this.scrollDown())},onMessageAdded:function(e){d.isUndefined(this.clear_status_timeout)||(window.clearTimeout(this.clear_status_timeout),delete this.clear_status_timeout),"error"===e.get("type")?this.handleErrorMessage(e):e.get("message")?this.handleTextMessage(e):this.handleChatStateMessage(e)},createMessageStanza:function(t){return u({from:e.connection.jid,to:this.model.get("jid"),type:"chat",id:t.get("msgid")}).c("body").t(t.get("message")).up().c(e.ACTIVE,{xmlns:c.NS.CHATSTATES}).up()},sendMessage:function(t){var n=this.createMessageStanza(t);e.connection.send(n),e.forward_messages&&e.connection.send(u({to:e.bare_jid,type:"chat",id:t.get("msgid")}).c("forwarded",{xmlns:"urn:xmpp:forward:0"}).c("delay",{xmns:"urn:xmpp:delay",stamp:(new Date).getTime()}).up().cnode(n.tree()))},onMessageSubmitted:function(t){if(!e.connection.authenticated)return this.showHelpMessages(["Sorry, the connection has been lost, and your message could not be sent"],"error");var n,i=t.replace(/^\s*/,"").match(/^\/(.*)\s*$/);if(i){if("clear"===i[1])return this.clearMessages();if("help"===i[1])return n=["<strong>/help</strong>:"+_("Show this menu"),"<strong>/me</strong>:"+_("Write in the third person"),"<strong>/clear</strong>:"+_("Remove messages")],void this.showHelpMessages(n)}var o=e.xmppstatus.get("fullname");o=d.isEmpty(o)?e.bare_jid:o;var s=this.model.messages.create({fullname:o,sender:"me",time:h().format(),message:t});this.sendMessage(s)},sendChatState:function(){e.connection.send(u({to:this.model.get("jid"),type:"chat"}).c(this.model.get("chat_state"),{xmlns:c.NS.CHATSTATES}).up().c("no-store",{xmlns:c.NS.HINTS}).up().c("no-permanent-store",{xmlns:c.NS.HINTS}))},setChatState:function(t,n){return d.isUndefined(this.chat_state_timeout)||(window.clearTimeout(this.chat_state_timeout),delete this.chat_state_timeout),t===e.COMPOSING?this.chat_state_timeout=window.setTimeout(this.setChatState.bind(this),e.TIMEOUTS.PAUSED,e.PAUSED):t===e.PAUSED&&(this.chat_state_timeout=window.setTimeout(this.setChatState.bind(this),e.TIMEOUTS.INACTIVE,e.INACTIVE)),n||this.model.get("chat_state")===t||this.model.set("chat_state",t),this},keyPressed:function(t){var n,i=t.target;t.keyCode===p.ENTER?(t.preventDefault(),n=i.value,i.value="",i.focus(),""!==n&&(this.onMessageSubmitted(n),e.emit("messageSend",n)),this.setChatState(e.ACTIVE)):this.setChatState(e.COMPOSING,t.keyCode===p.FORWARD_SLASH)},onSendButtonClicked:function(t){t.preventDefault();var n=this.el.querySelector(".chat-textarea"),i=n.value;n.value="",n.focus(),""!==i&&(this.onMessageSubmitted(i),e.emit("messageSend",i)),this.setChatState(e.ACTIVE)},clearMessages:function(e){e&&e.preventDefault&&e.preventDefault();var t=confirm(_("Are you sure you want to clear the messages from this chat box?"));return t===!0&&(this.$content.empty(),this.model.messages.reset(),this.model.messages.browserStorage._clear()),this},insertIntoTextArea:function(e){var t=this.$el.find("textarea.chat-textarea"),n=t.val();n&&" "!==n[n.length-1]&&(n+=" "),t.focus().val(n+e+" ")},insertEmoticon:function(e){e.stopPropagation(),this.$el.find(".toggle-smiley ul").slideToggle(200);var t=a(e.target);t=t.is("a")?t:t.children("a"),this.insertIntoTextArea(t.data("emoticon"))},toggleEmoticonMenu:function(e){e.stopPropagation(),this.$el.find(".toggle-smiley ul").slideToggle(200)},toggleCall:function(t){t.stopPropagation(),e.emit("callButtonClicked",{connection:e.connection,model:this.model})},onChatStatusChanged:function(e){var t=e.get("chat_status"),n=e.get("fullname");n=d.isEmpty(n)?e.get("jid"):n,this.$el.is(":visible")&&("offline"===t?this.showStatusNotification(n+" "+_("has gone offline")):"away"===t?this.showStatusNotification(n+" "+_("has gone away")):"dnd"===t?this.showStatusNotification(n+" "+_("is busy")):"online"===t&&this.$el.find("div.chat-event").remove())},onStatusChanged:function(t){this.showStatusMessage(),e.emit("contactStatusMessageChanged",{contact:t.attributes,message:t.get("status")})},showStatusMessage:function(e){return e=e||this.model.get("status"),d.isString(e)&&this.$el.find("p.user-custom-message").text(e).attr("title",e),this},close:function(t){return t&&t.preventDefault&&t.preventDefault(),e.connection.connected&&(this.model.set("chat_state",e.INACTIVE),this.sendChatState()),this.model.destroy(),this.remove(),e.emit("chatBoxClosed",this),this},getToolbarOptions:function(t){return d.extend(t||{},{label_clear:_("Clear all messages"),label_insert_smiley:_("Insert a smiley"),label_start_call:_("Start a call"),show_call_button:e.visible_toolbar_buttons.call,show_clear_button:e.visible_toolbar_buttons.clear,show_emoticons:e.visible_toolbar_buttons.emoticons})},renderToolbar:function(t,n){if(e.show_toolbar)return t=t||s,n=d.extend(this.model.toJSON(),this.getToolbarOptions(n||{})),this.$el.find(".chat-toolbar").html(t(n)),this},renderAvatar:function(){if(this.model.get("image")){var t=e.chatview_avatar_width,n=e.chatview_avatar_height,i="data:"+this.model.get("image_type")+";base64,"+this.model.get("image"),o=a(r({width:t,height:n})).get(0);if(!o.getContext||!o.getContext("2d"))return this;var s=o.getContext("2d"),l=new Image;return l.onload=function(){var e=l.width/l.height;e<1?s.drawImage(l,0,0,t,n*(1/e)):s.drawImage(l,0,0,t,n*e)},l.src=i,this.$el.find(".chat-title").before(o),this}},focus:function(){return this.$el.find(".chat-textarea").focus(),e.emit("chatBoxFocused",this),this},hide:function(){return this.el.classList.add("hidden"),l.refreshWebkit(),this},afterShown:function(t){e.connection.connected&&this.model.save(),this.setChatState(e.ACTIVE),this.scrollDown(),t&&this.focus()},_show:function(e){return this.$el.is(":visible")&&"1"===this.$el.css("opacity")?void(e&&this.focus()):void l.fadeIn(this.el,d.bind(this.afterShown,this,e))},show:function(e){return d.isUndefined(this.debouncedShow)&&(this.debouncedShow=d.debounce(this._show,250,{leading:!0})),this.debouncedShow.apply(this,arguments),this},hideNewMessagesIndicator:function(){var e=this.el.querySelector(".new-msgs-indicator");d.isNull(e)||e.classList.add("hidden")},markScrolled:d.debounce(function(e){if(e&&e.preventDefault&&e.preventDefault(),this.model.get("auto_scrolled"))return void this.model.set({scrolled:!1,auto_scrolled:!1});var t=this.$content.scrollTop()+this.$content.innerHeight()>=this.$content[0].scrollHeight-10;t?(this.hideNewMessagesIndicator(),this.model.save("scrolled",!1)):this.model.save("scrolled",!0)},150),viewUnreadMessages:function(){this.model.save("scrolled",!1),this.scrollDown()},_scrollDown:function(){this.$content.is(":visible")&&!this.model.get("scrolled")&&(this.$content.scrollTop(this.$content[0].scrollHeight),this.hideNewMessagesIndicator(),this.model.save({auto_scrolled:!0}))},scrollDown:function(){return d.isUndefined(this.debouncedScrollDown)&&(this.debouncedScrollDown=d.debounce(this._scrollDown,250)),this.debouncedScrollDown.apply(this,arguments),this}})}}),e}),define("tpl!add_contact_dropdown",["lodash"],function(_){return function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj)__p+='<dl class="add-converse-contact dropdown">\n    <dt id="xmpp-contact-search" class="fancy-dropdown">\n        <a class="toggle-xmpp-contact-form icon-plus" href="#" title="'+__e(label_click_to_chat)+'"> '+__e(label_add_contact)+'</a>\n    </dt>\n    <dd class="search-xmpp"><ul></ul></dd>\n</dl>\n';return __p}}),define("tpl!add_contact_form",["lodash"],function(_){return function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj)__p+='<li>\n    <form class="pure-form add-xmpp-contact">\n        <input type="text"\n            name="identifier"\n            class="username"\n            placeholder="'+__e(label_contact_username)+'"/>\n        <button class="pure-button button-primary" type="submit">'+__e(label_add)+"</button>\n    </form>\n</li>\n";return __p}}),define("tpl!change_status_message",["lodash"],function(_){return function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj)__p+='<form id="set-custom-xmpp-status" class="pure-form">\n<fieldset>\n    <span class="input-button-group">\n        <input type="text" class="custom-xmpp-status" value="'+__e(status_message)+'" placeholder="'+__e(label_custom_status)+'"/>\n        <input type="submit" class="pure-button button-primary" value="'+__e(label_save)+'"/>\n    </span>\n</fieldset>\n</form>\n';return __p}}),define("tpl!chat_status",["lodash"],function(_){return function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj)__p+='<div class="xmpp-status">\n    <a class="choose-xmpp-status '+__e(chat_status)+" icon-"+__e(chat_status)+'" data-value="'+__e(status_message)+'" href="#" title="'+__e(desc_change_status)+'">\n        '+__e(status_message)+'\n    </a>\n    <a class="change-xmpp-status-message icon-pencil" href="#" title="'+__e(desc_custom_status)+'"></a>\n</div>\n';return __p}}),define("tpl!choose_status",["lodash"],function(_){return function(obj){obj||(obj={});var __t,__p="";with(obj)__p+='<dl id="target" class="dropdown">\n    <dt id="fancy-xmpp-status-select" class="fancy-dropdown"></dt>\n    <dd><ul class="xmpp-status-menu"></ul></dd>\n</dl>\n';return __p}}),define("tpl!contacts_panel",["lodash"],function(_){return function(obj){function print(){__p+=__j.call(arguments,"")}obj||(obj={});var __t,__p="",__e=_.escape,__j=Array.prototype.join;with(obj)__p+='<form class="pure-form set-xmpp-status" action="" method="post">\n    <span id="xmpp-status-holder">\n        <select id="select-xmpp-status" style="display:none">\n            <option value="online">'+__e(label_online)+'</option>\n            <option value="dnd">'+__e(label_busy)+'</option>\n            <option value="away">'+__e(label_away)+"</option>\n            ",include_offline_state&&(__p+='\n            <option value="offline">'+__e(label_offline)+"</option>\n            "),__p+="\n            ",allow_logout&&(__p+='\n            <option value="logout">'+__e(label_logout)+"</option>\n            "),__p+="\n        </select>\n    </span>\n</form>\n";return __p}}),define("tpl!contacts_tab",["lodash"],function(_){return function(obj){function print(){__p+=__j.call(arguments,"")}obj||(obj={});var __t,__p="",__e=_.escape,__j=Array.prototype.join;with(obj)__p+='<li><a class="s ',is_current&&(__p+=" current "),__p+='"\n       data-id="users" href="#users">\n    '+__e(label_contacts)+"\n</a></li>\n";return __p}}),define("tpl!controlbox",["lodash"],function(_){return function(obj){function print(){__p+=__j.call(arguments,"")}obj||(obj={});var __t,__p="",__j=Array.prototype.join;with(obj)__p+='<div class="flyout box-flyout">\n    <div class="dragresize dragresize-top"></div>\n    <div class="dragresize dragresize-topleft"></div>\n    <div class="dragresize dragresize-left"></div>\n    <div class="chat-head controlbox-head">\n        <ul id="controlbox-tabs"></ul>\n        ',sticky_controlbox||(__p+='\n            <a class="chatbox-btn close-chatbox-button icon-close"></a>\n        '),__p+='\n    </div>\n    <div class="controlbox-panes"></div>\n</div>\n';return __p}}),define("tpl!controlbox_toggle",["lodash"],function(_){return function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj)__p+='<span class="conn-feedback">'+__e(label_toggle)+"</span>\n";return __p}}),define("tpl!login_panel",["lodash"],function(_){return function(obj){function print(){__p+=__j.call(arguments,"")}obj||(obj={});var __t,__p="",__e=_.escape,__j=Array.prototype.join;with(obj)__p+='<form class="pure-form pure-form-stacked converse-form" id="converse-login" method="post">\n    ',auto_login&&(__p+='\n        <span class="spinner login-submit"/>\n    '),__p+="\n    ",auto_login||(__p+="\n        ",authentication!=LOGIN&&authentication!=EXTERNAL||(__p+="\n            <label>"+__e(label_username)+'</label>\n            <input type="text" name="jid" placeholder="'+__e(placeholder_username)+'">\n            ',authentication!==EXTERNAL&&(__p+="\n                <label>"+__e(label_password)+'</label>\n                <input type="password" name="password" placeholder="'+__e(placeholder_password)+'">\n            '),__p+='\n            <input class="pure-button button-primary" type="submit" value="'+__e(label_login)+'">\n            <span class="conn-feedback"></span>\n        '),__p+="\n        ",authentication==ANONYMOUS&&(__p+='\n            <input class="pure-button button-primary login-anon" type="submit" value="'+__e(label_anon_login)+'"/>\n        '),__p+="\n        ",authentication==PREBIND&&(__p+="\n            <p>Disconnected.</p>\n        "),__p+="\n    "),__p+="\n</form>\n";return __p}}),define("tpl!login_tab",["lodash"],function(_){return function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj)__p+='<li><a class="current" data-id="login" href="#login-dialog">'+__e(label_sign_in)+"</a></li>\n";return __p}}),define("tpl!search_contact",["lodash"],function(_){return function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj)__p+='<li>\n    <form class="search-xmpp-contact">\n        <input type="text"\n            name="identifier"\n            class="username"\n            placeholder="'+__e(label_contact_name)+'"/>\n        <button type="submit">'+__e(label_search)+"</button>\n    </form>\n</li>\n";return __p}}),define("tpl!status_option",["lodash"],function(_){return function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj)__p+='<li>\n    <a href="#" class="'+__e(value)+'" data-value="'+__e(value)+'">\n        <span class="icon-'+__e(value)+'"></span>\n        '+__e(text)+"\n    </a>\n</li>\n";return __p}}),define("tpl!group_header",["lodash"],function(_){return function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj)__p+='<a href="#" class="group-toggle icon-'+__e(toggle_state)+'" title="'+__e(desc_group_toggle)+'">'+__e(label_group)+"</a>\n";return __p}}),define("tpl!pending_contact",["lodash"],function(_){return function(obj){function print(){__p+=__j.call(arguments,"")}obj||(obj={});var __t,__p="",__e=_.escape,__j=Array.prototype.join;with(obj)allow_chat_pending_contacts&&(__p+='\n<a class="open-chat"href="#">\n'),__p+='\n<span class="pending-contact-name" title="Name: '+__e(fullname)+"\nJID: "+__e(jid)+'">'+__e(fullname)+"</span> \n",allow_chat_pending_contacts&&(__p+="\n</a>\n"),__p+='\n<a class="remove-xmpp-contact icon-remove" title="'+__e(desc_remove)+'" href="#"></a>\n';return __p}}),define("tpl!requesting_contact",["lodash"],function(_){return function(obj){function print(){__p+=__j.call(arguments,"")}obj||(obj={});var __t,__p="",__e=_.escape,__j=Array.prototype.join;with(obj)allow_chat_pending_contacts&&(__p+='\n<a class="open-chat"href="#">\n'),__p+='\n<span class="req-contact-name" title="Name: '+__e(fullname)+"\nJID: "+__e(jid)+'">'+__e(fullname)+"</span>\n",allow_chat_pending_contacts&&(__p+="\n</a>\n"),__p+='\n<span class="request-actions">\n    <a class="accept-xmpp-request icon-checkmark" aria-label="'+__e(desc_accept)+'" title="'+__e(desc_accept)+'" href="#"></a>\n    <a class="decline-xmpp-request icon-close" aria-label="'+__e(desc_decline)+'" title="'+__e(desc_decline)+'" href="#"></a>\n</span>\n';return __p}}),define("tpl!roster",["lodash"],function(_){return function(obj){obj||(obj={});var __t,__p="";with(obj)__p+='<dl class="roster-contacts" style="display: none;"></dl>\n';return __p}}),define("tpl!roster_filter",["lodash"],function(_){return function(obj){function print(){__p+=__j.call(arguments,"")}obj||(obj={});var __t,__p="",__j=Array.prototype.join;with(obj)__p+='<form class="pure-form roster-filter-form input-button-group">\n    <input value="'+(null==(__t=filter_text)?"":__t)+'" class="roster-filter"\n           placeholder="'+(null==(__t=placeholder)?"":__t)+'"\n           ',"state"===filter_type&&(__p+='  style="display: none" '),__p+=' >\n    <select class="state-type" ',"state"!==filter_type&&(__p+='  style="display: none" '),__p+=' >\n        <option value="">'+(null==(__t=label_any)?"":__t)+"</option>\n        <option ","online"===chat_state&&(__p+=' selected="selected" '),__p+='\n            value="online">'+(null==(__t=label_online)?"":__t)+"</option>\n        <option ","chat"===chat_state&&(__p+=' selected="selected" '),__p+='\n            value="chat">'+(null==(__t=label_chatty)?"":__t)+"</option>\n        <option ","dnd"===chat_state&&(__p+=' selected="selected" '),__p+='\n            value="dnd">'+(null==(__t=label_busy)?"":__t)+"</option>\n        <option ","away"===chat_state&&(__p+=' selected="selected" '),__p+='\n            value="away">'+(null==(__t=label_away)?"":__t)+"</option>\n        <option ","xa"===chat_state&&(__p+=' selected="selected" '),__p+='\n            value="xa">'+(null==(__t=label_xa)?"":__t)+"</option>\n        <option ","offline"===chat_state&&(__p+=' selected="selected" '),__p+='\n            value="offline">'+(null==(__t=label_offline)?"":__t)+'</option>\n    </select>\n    <select class="filter-type">\n        <option ',"contacts"===filter_type&&(__p+=' selected="selected" '),__p+='\n                value="contacts">'+(null==(__t=label_contacts)?"":__t)+"</option>\n        <option ","groups"===filter_type&&(__p+=' selected="selected" '),__p+='\n                value="groups">'+(null==(__t=label_groups)?"":__t)+"</option>\n        <option ","state"===filter_type&&(__p+=' selected="selected" '),__p+='\n                value="state">'+(null==(__t=label_state)?"":__t)+"</option>\n    </select>\n</form>\n";return __p}}),define("tpl!roster_item",["lodash"],function(_){return function(obj){function print(){__p+=__j.call(arguments,"")}obj||(obj={});var __t,__p="",__e=_.escape,__j=Array.prototype.join;with(obj)__p+='<a class="open-chat" title="'+__e(title_fullname)+": "+__e(fullname)+"\nJID: "+__e(jid)+"\n"+__e(desc_chat)+'" href="#"><span class="icon-'+__e(chat_status)+'" title="'+__e(desc_status)+'"></span>'+__e(fullname)+"</a>\n",allow_contact_removal&&(__p+='\n<a class="remove-xmpp-contact icon-remove" title="'+__e(desc_remove)+'" href="#"></a>\n'),__p+="\n";return __p}}),function(e,t){define("converse-rosterview",["converse-core","tpl!group_header","tpl!pending_contact","tpl!requesting_contact","tpl!roster","tpl!roster_filter","tpl!roster_item"],t)}(this,function(e,t,n,i,o,s,r){"use strict";var a=e.env.jQuery,l=e.env.utils,c=e.env.Strophe,u=e.env.$iq,d=e.env.b64_sha1,h=e.env._;e.plugins.add("converse-rosterview",{overrides:{afterReconnected:function(){this.rosterview.registerRosterXHandler(),this.__super__.afterReconnected.apply(this,arguments)},_tearDown:function(){this.__super__._tearDown.apply(this,arguments),h.isUndefined(this.rosterview)||this.rosterview.remove()},RosterGroups:{comparator:function(){var e=this.__super__._converse;return e.RosterGroupsComparator.apply(this,arguments)}}},initialize:function(){var e=this._converse,p=e.__;this.updateSettings({allow_chat_pending_contacts:!0,allow_contact_removal:!0,show_toolbar:!0});var _={dnd:p("This contact is busy"),online:p("This contact is online"),offline:p("This contact is offline"),unavailable:p("This contact is unavailable"),xa:p("This contact is away for an extended period"),away:p("This contact is away")},m=p("Contacts"),f=p("Groups"),g=p("My contacts"),v=p("Pending contacts"),b=p("Contact requests"),y=p("Ungrouped"),w={};w[b]=0,w[g]=1,w[y]=2,w[v]=3,e.RosterGroupsComparator=function(e,t){e=e.get("name"),t=t.get("name");var n=h.keys(w),i=h.includes(n,e),o=h.includes(n,t);return i||o?i&&o?w[e]<w[t]?-1:w[e]>w[t]?1:0:!i&&o?t===b?1:-1:i&&!o?e===b?-1:1:void 0:e.toLowerCase()<t.toLowerCase()?-1:e.toLowerCase()>t.toLowerCase()?1:0},e.RosterFilter=Backbone.Model.extend({initialize:function(){this.set({filter_text:"",filter_type:"contacts",chat_state:""})}}),e.RosterFilterView=Backbone.View.extend({tagName:"span",events:{"keydown .roster-filter":"liveFilter","submit form.roster-filter-form":"submitFilter","click .onX":"clearFilter","mousemove .x":"toggleX","change .filter-type":"changeTypeFilter","change .state-type":"changeChatStateFilter"},initialize:function(){this.model.on("change:filter_type",this.render,this),this.model.on("change:filter_text",this.render,this)},render:function(){return this.el.innerHTML=s(h.extend(this.model.toJSON(),{placeholder:p("Filter"),label_contacts:m,label_groups:f,label_state:p("State"),label_any:p("Any"),label_online:p("Online"),label_chatty:p("Chatty"),label_busy:p("Busy"),label_away:p("Away"),label_xa:p("Extended Away"),label_offline:p("Offline")})),this.renderClearButton(),this.$el},renderClearButton:function(){var e=this.$(".roster-filter");e[this.tog(e.val())]("x")},tog:function(e){return e?"addClass":"removeClass"},toggleX:function(e){e&&e.preventDefault&&e.preventDefault();var t=e.target;a(t)[this.tog(t.offsetWidth-18<e.clientX-t.getBoundingClientRect().left)]("onX")},changeChatStateFilter:function(e){e&&e.preventDefault&&e.preventDefault(),this.model.save({chat_state:this.el.querySelector(".state-type").value})},changeTypeFilter:function(e){e&&e.preventDefault&&e.preventDefault();var t=e.target.value;"state"===t?this.model.save({filter_type:t,chat_state:this.el.querySelector(".state-type").value}):this.model.save({filter_type:t,filter_text:this.el.querySelector(".roster-filter").value})},liveFilter:h.debounce(function(e){this.model.save({filter_type:this.el.querySelector(".filter-type").value,filter_text:this.el.querySelector(".roster-filter").value})},250),submitFilter:function(e){e&&e.preventDefault&&e.preventDefault(),this.liveFilter(),this.render()},isActive:function(){return!("state"!==this.model.get("filter_type")&&!this.model.get("filter_text"))},show:function(){return this.$el.is(":visible")?this:(this.$el.show(),this)},hide:function(){if(!this.$el.is(":visible"))return this;if(!(this.el.querySelector(".roster-filter").value.length>0))return this.model.save({filter_text:"",chat_state:""}),this.$el.hide(),this},clearFilter:function(e){e&&e.preventDefault&&(e.preventDefault(),a(e.target).removeClass("x onX").val("")),this.model.save({filter_text:""})}}),e.RosterView=Backbone.Overview.extend({tagName:"div",id:"converse-roster",initialize:function(){this.roster_handler_ref=this.registerRosterHandler(),this.rosterx_handler_ref=this.registerRosterXHandler(),e.roster.on("add",this.onContactAdd,this),e.roster.on("change",this.onContactChange,this),e.roster.on("destroy",this.update,this),e.roster.on("remove",this.update,this),this.model.on("add",this.onGroupAdd,this),this.model.on("reset",this.reset,this),e.on("rosterGroupsFetched",this.positionFetchedGroups,this),e.on("rosterContactsFetched",this.update,this),this.createRosterFilter()},render:function(){return this.renderRoster(),this.$el.html(this.filter_view.render()),e.allow_contact_requests||this.el.classList.add("no-contact-requests"),this},renderRoster:function(){this.$roster=a(o()),this.roster=this.$roster[0]},createRosterFilter:function(){var t=new e.RosterFilter;t.id=d("_converse.rosterfilter"+e.bare_jid),t.browserStorage=new Backbone.BrowserStorage.local(this.filter.id),this.filter_view=new e.RosterFilterView({model:t}),this.filter_view.model.on("change",this.updateFilter,this),this.filter_view.model.fetch()},updateFilter:h.debounce(function(){var e=this.filter_view.model.get("filter_type");"state"===e?this.filter(this.filter_view.model.get("chat_state"),e):this.filter(this.filter_view.model.get("filter_text"),e)},100),unregisterHandlers:function(){e.connection.deleteHandler(this.roster_handler_ref),delete this.roster_handler_ref,e.connection.deleteHandler(this.rosterx_handler_ref),delete this.rosterx_handler_ref},update:h.debounce(function(){return h.isNull(this.roster.parentElement)&&this.$el.append(this.$roster.show()),this.showHideFilter()},e.animate?100:0),showHideFilter:function(){if(this.$el.is(":visible"))return this.$roster.hasScrollBar()?this.filter_view.show():this.filter_view.isActive()||this.filter_view.hide(),this},filter:function(e,t){h.each(this.getAll(),function(e){e.model.contacts.length>0&&e.show().filter("")}),e=e.toLowerCase(),"groups"===t?h.each(this.getAll(),function(t,n){h.includes(t.model.get("name").toLowerCase(),e.toLowerCase())?t.model.contacts.length>0&&t.show():t.hide()}):h.each(this.getAll(),function(n){n.filter(e,t)})},reset:function(){return e.roster.reset(),this.removeAll(),this.renderRoster(),this.render().update(),this},registerRosterHandler:function(){e.connection.addHandler(e.roster.onRosterPush.bind(e.roster),c.NS.ROSTER,"iq","set")},registerRosterXHandler:function(){var t=0;e.connection.addHandler(function(n){return window.setTimeout(function(){e.connection.flush(),e.roster.subscribeToSuggestedItems.bind(e.roster)(n)},t),t+=250*a(n).find("item").length,!0},c.NS.ROSTERX,"message",null)},onGroupAdd:function(t){var n=new e.RosterGroupView({model:t});this.add(t.get("name"),n.render()),this.positionGroup(n)},onContactAdd:function(e){this.addRosterContact(e).update(),this.updateFilter()},onContactChange:function(e){this.updateChatBox(e).update(),h.has(e.changed,"subscription")&&("from"===e.changed.subscription?this.addContactToGroup(e,v):h.includes(["both","to"],e.get("subscription"))&&this.addExistingContact(e)),h.has(e.changed,"ask")&&"subscribe"===e.changed.ask&&this.addContactToGroup(e,v),h.has(e.changed,"subscription")&&"true"===e.changed.requesting&&this.addContactToGroup(e,b),this.updateFilter()},updateChatBox:function(t){var n=e.chatboxes.get(t.get("jid")),i={};return n?(h.has(t.changed,"chat_status")&&(i.chat_status=t.get("chat_status")),h.has(t.changed,"status")&&(i.status=t.get("status")),n.save(i),this):this},positionFetchedGroups:function(){var t=this;this.model.sort(),this.model.each(function(n,i){var o=t.get(n.get("name"));o||(o=new e.RosterGroupView({model:n}),t.add(n.get("name"),o.render())),0===i?t.$roster.append(o.$el):t.appendGroup(o)})},positionGroup:function(e){var t=this.$roster.find(".roster-group"),n=t.length?this.model.indexOf(e.model):0;return 0===n?this.$roster.prepend(e.$el):n===this.model.length-1?this.appendGroup(e):a(t.eq(n)).before(e.$el),this},appendGroup:function(e){var t=this.$roster.find(".roster-group").last(),n=t.siblings("dd");return n.length>0?n.last().after(e.$el):t.after(e.$el),this},getGroup:function(e){var t=this.get(e);return t?t.model:this.model.create({name:e,id:d(e)})},addContactToGroup:function(e,t){this.getGroup(t).contacts.add(e)},addExistingContact:function(t){var n;e.roster_groups?(n=t.get("groups"),0===n.length&&(n=[y])):n=[g],h.each(n,h.bind(this.addContactToGroup,this,t))},addRosterContact:function(e){return"both"===e.get("subscription")||"to"===e.get("subscription")?this.addExistingContact(e):"subscribe"===e.get("ask")||"from"===e.get("subscription")?this.addContactToGroup(e,v):e.get("requesting")===!0&&this.addContactToGroup(e,b),this}}),e.RosterContactView=Backbone.View.extend({tagName:"dd",events:{"click .accept-xmpp-request":"acceptRequest","click .decline-xmpp-request":"declineRequest","click .open-chat":"openChat","click .remove-xmpp-contact":"removeContact"},initialize:function(){this.model.on("change",this.render,this),this.model.on("remove",this.remove,this),this.model.on("destroy",this.remove,this),this.model.on("open",this.openChat,this)},render:function(){var t=this;if(!this.mayBeShown())return this.$el.hide(),this;var o=this.model,s=o.get("ask"),a=o.get("chat_status"),l=o.get("requesting"),c=o.get("subscription"),u=["current-xmpp-contact","pending-xmpp-contact","requesting-xmpp-contact"].concat(h.keys(_));return h.each(u,function(e){h.includes(t.el.className,e)&&t.el.classList.remove(e)}),this.$el.addClass(a).data("status",a),"subscribe"===s||"from"===c?(this.el.classList.add("pending-xmpp-contact"),this.$el.html(n(h.extend(o.toJSON(),{desc_remove:p("Click to remove this contact"),allow_chat_pending_contacts:e.allow_chat_pending_contacts})))):l===!0?(this.el.classList.add("requesting-xmpp-contact"),this.$el.html(i(h.extend(o.toJSON(),{desc_accept:p("Click to accept this contact request"),desc_decline:p("Click to decline this contact request"),allow_chat_pending_contacts:e.allow_chat_pending_contacts})))):"both"!==c&&"to"!==c||(this.el.classList.add("current-xmpp-contact"),this.$el.removeClass(h.without(["both","to"],c)[0]).addClass(c),this.$el.html(r(h.extend(o.toJSON(),{desc_status:_[a||"offline"],desc_chat:p("Click to chat with this contact"),desc_remove:p("Click to remove this contact"),
title_fullname:p("Name"),allow_contact_removal:e.allow_contact_removal})))),this},isGroupCollapsed:function(){var t=this.$el.prevAll("dt:first").data("group"),n=e.rosterview.model.where({name:t})[0];return n.get("state")===e.CLOSED},mayBeShown:function(){var t=this.model.get("chat_status");return!(e.show_only_online_users&&"online"!==t||e.hide_offline_users&&"offline"===t)||("subscribe"===this.model.get("ask")||"from"===this.model.get("subscription")||this.model.get("requesting")===!0)},openChat:function(t){return t&&t.preventDefault&&t.preventDefault(),e.chatboxviews.showChat(this.model.attributes)},removeContact:function(t){if(t&&t.preventDefault&&t.preventDefault(),e.allow_contact_removal){var n=confirm(p("Are you sure you want to remove this contact?"));if(n===!0){var i=u({type:"set"}).c("query",{xmlns:c.NS.ROSTER}).c("item",{jid:this.model.get("jid"),subscription:"remove"});e.connection.sendIQ(i,function(e){this.model.destroy(),this.remove()}.bind(this),function(t){alert(p("Sorry, there was an error while trying to remove "+name+" as a contact.")),e.log(t)})}}},acceptRequest:function(t){t&&t.preventDefault&&t.preventDefault(),e.roster.sendContactAddIQ(this.model.get("jid"),this.model.get("fullname"),[],function(){this.model.authorize().subscribe()}.bind(this))},declineRequest:function(e){e&&e.preventDefault&&e.preventDefault();var t=confirm(p("Are you sure you want to decline this contact request?"));return t===!0&&this.model.unauthorize().destroy(),this}}),e.RosterGroupView=Backbone.Overview.extend({tagName:"dt",className:"roster-group",events:{"click a.group-toggle":"toggle"},initialize:function(){this.model.contacts.on("add",this.addContact,this),this.model.contacts.on("change:subscription",this.onContactSubscriptionChange,this),this.model.contacts.on("change:requesting",this.onContactRequestChange,this),this.model.contacts.on("change:chat_status",function(e){this.model.contacts.sort(),this.positionContact(e).render()},this),this.model.contacts.on("destroy",this.onRemove,this),this.model.contacts.on("remove",this.onRemove,this),e.roster.on("change:groups",this.onContactGroupChange,this)},render:function(){return this.el.setAttribute("data-group",this.model.get("name")),this.$el.html(a(t({label_group:this.model.get("name"),desc_group_toggle:this.model.get("description"),toggle_state:this.model.get("state")}))),this},addContact:function(t){var n=new e.RosterContactView({model:t});this.add(t.get("id"),n),n=this.positionContact(t).render(),n.mayBeShown()&&(this.model.get("state")===e.CLOSED?("none"!==n.$el[0].style.display&&n.$el.hide(),this.$el.is(":visible")||this.$el.show()):"block"!==this.$el[0].style.display&&this.show())},positionContact:function(e){var t=this.get(e.get("id")),n=this.model.contacts.indexOf(e);return t.$el.detach(),0===n?this.$el.after(t.$el):n===this.model.contacts.length-1?this.$el.nextUntil("dt").last().after(t.$el):this.$el.nextUntil("dt").eq(n).before(t.$el),t},show:function(){return this.$el.show(),h.each(this.getAll(),function(e){e.mayBeShown()&&!e.isGroupCollapsed()&&e.$el.show()}),this},hide:function(){this.$el.nextUntil("dt").addBack().hide()},filter:function(t,n){var i;0===t.length?(this.model.get("state")===e.OPENED&&this.model.contacts.each(function(e){var t=this.get(e.get("id"));t.mayBeShown()&&!t.isGroupCollapsed()&&t.$el.show()}.bind(this)),this.showIfNecessary()):(t=t.toLowerCase(),i="state"===n?this.model.get("name")===b?this.model.contacts.filter(function(e){return l.contains.not("chat_status",t)(e)&&!e.get("requesting")}):this.model.contacts.filter(l.contains.not("chat_status",t)):this.model.contacts.filter(l.contains.not("fullname",t)),i.length===this.model.contacts.length?this.hide():(h.each(i,function(e){this.get(e.get("id")).$el.hide()}.bind(this)),h.each(this.model.contacts.reject(l.contains.not("fullname",t)),function(e){this.get(e.get("id")).$el.show()}.bind(this)),this.showIfNecessary()))},showIfNecessary:function(){!this.$el.is(":visible")&&this.model.contacts.length>0&&this.$el.show()},toggle:function(t){t&&t.preventDefault&&t.preventDefault();var n=a(t.target);n.hasClass("icon-opened")?(this.$el.nextUntil("dt").slideUp(),this.model.save({state:e.CLOSED}),n.removeClass("icon-opened").addClass("icon-closed")):(n.removeClass("icon-closed").addClass("icon-opened"),this.model.save({state:e.OPENED}),this.filter(e.rosterview.$(".roster-filter").val()||"",e.rosterview.$(".filter-type").val()))},onContactGroupChange:function(e){var t=h.includes(e.get("groups"),this.model.get("name")),n=e.get("id"),i=!this.get(n);t&&!i?this.model.contacts.remove(n):!t&&i&&this.addContact(e)},onContactSubscriptionChange:function(e){this.model.get("name")===v&&"from"!==e.get("subscription")&&this.model.contacts.remove(e.get("id"))},onContactRequestChange:function(e){this.model.get("name")!==b||e.get("requesting")||(this.model.contacts.remove(e.get("id"),{silent:!0}),this.get(e.get("id")).remove(),this.onRemove(e))},onRemove:function(e){this.remove(e.get("id")),0===this.model.contacts.length&&this.$el.hide()}});var x=function(){e.rosterview=new e.RosterView({model:e.rostergroups}),e.rosterview.render()};e.on("rosterInitialized",x),e.on("rosterReadyAfterReconnection",x)}})}),function(e,t){define("converse-controlbox",["converse-core","tpl!add_contact_dropdown","tpl!add_contact_form","tpl!change_status_message","tpl!chat_status","tpl!choose_status","tpl!contacts_panel","tpl!contacts_tab","tpl!controlbox","tpl!controlbox_toggle","tpl!login_panel","tpl!login_tab","tpl!search_contact","tpl!status_option","converse-chatview","converse-rosterview"],t)}(this,function(e,t,n,i,o,s,r,a,l,c,u,d,h,p){"use strict";var _="users",m=e.env.Strophe,f=e.env.utils,g=e.env.jQuery,v=e.env._,b=e.env.moment;e.plugins.add("converse-controlbox",{overrides:{initSession:function(){this.controlboxtoggle=new this.ControlBoxToggle,this.__super__.initSession.apply(this,arguments)},initConnection:function(){this.__super__.initConnection.apply(this,arguments),this.connection&&this.addControlBox()},_tearDown:function(){this.__super__._tearDown.apply(this,arguments),this.rosterview&&(this.rosterview.unregisterHandlers(),this.rosterview.model.off().reset(),this.rosterview.each(function(e){e.removeAll(),e.remove()}),this.rosterview.removeAll().remove())},clearSession:function(){this.__super__.clearSession.apply(this,arguments),v.isUndefined(this.connection)&&this.connection.connected&&this.chatboxes.get("controlbox").save({connected:!1})},ChatBoxes:{chatBoxMayBeShown:function(e){return this.__super__.chatBoxMayBeShown.apply(this,arguments)&&"controlbox"!==e.get("id")},onChatBoxesFetched:function(e,t){var n=this.__super__._converse;this.__super__.onChatBoxesFetched.apply(this,arguments),v.includes(v.map(e,"id"),"controlbox")||n.addControlBox(),this.get("controlbox").save({connected:!0})}},ChatBoxViews:{onChatBoxAdded:function(e){var t=this.__super__._converse;if("controlbox"===e.get("box_id")){var n=this.get(e.get("id"));return n?(n.model=e,n.initialize(),n):(n=new t.ControlBoxView({model:e}),this.add(e.get("id"),n))}return this.__super__.onChatBoxAdded.apply(this,arguments)},closeAllChatBoxes:function(){var e=this.__super__._converse;return this.each(function(t){("controlbox"!==t.model.get("id")||e.disconnection_cause===e.LOGOUT&&!e.show_controlbox_by_default)&&t.close()}),this},getChatBoxWidth:function(e){var t=this.__super__._converse,n=this.get("controlbox");return"controlbox"===e.model.get("id")?n&&n.$el.is(":visible")?n.$el.outerWidth(!0):t.controlboxtoggle.$el.outerWidth(!0):this.__super__.getChatBoxWidth.apply(this,arguments)}},ChatBox:{initialize:function(){"controlbox"===this.get("id")?this.set({time_opened:b(0).valueOf(),num_unread:0}):this.__super__.initialize.apply(this,arguments)}},ChatBoxView:{insertIntoDOM:function(){var e=this.__super__._converse;return this.$el.insertAfter(e.chatboxviews.get("controlbox").$el),this}}},initialize:function(){var e=this._converse,b=e.__;this.updateSettings({allow_logout:!0,default_domain:void 0,show_controlbox_by_default:!1,sticky_controlbox:!1,xhr_user_search:!1,xhr_user_search_url:""});var y=b("Contacts");e.addControlBox=function(){return e.chatboxes.add({id:"controlbox",box_id:"controlbox",closed:!e.show_controlbox_by_default})},e.ControlBoxView=e.ChatBoxView.extend({tagName:"div",className:"chatbox",id:"controlbox",events:{"click a.close-chatbox-button":"close","click ul#controlbox-tabs li a":"switchTab"},initialize:function(){this.$el.insertAfter(e.controlboxtoggle.$el),this.model.on("change:connected",this.onConnected,this),this.model.on("destroy",this.hide,this),this.model.on("hide",this.hide,this),this.model.on("show",this.show,this),this.model.on("change:closed",this.ensureClosedState,this),this.render(),this.model.get("connected")&&this.insertRoster()},render:function(){return this.model.get("connected")&&v.isUndefined(this.model.get("closed"))&&this.model.set("closed",!e.show_controlbox_by_default),this.model.get("closed")?this.hide():this.show(),this.$el.html(l(v.extend(this.model.toJSON(),{sticky_controlbox:e.sticky_controlbox}))),e.connection.connected&&e.connection.authenticated&&!e.connection.disconnecting?this.contactspanel&&this.contactspanel.$el.is(":visible")||this.renderContactsPanel():this.renderLoginPanel(),this},onConnected:function(){this.model.get("connected")&&(this.render().insertRoster(),this.model.save())},insertRoster:function(){return this.contactspanel.$el.append(e.rosterview.$el),this},renderLoginPanel:function(){return this.loginpanel=new e.LoginPanel({$parent:this.$el.find(".controlbox-panes"),model:this}),this.loginpanel.render(),this},renderContactsPanel:function(){v.isUndefined(this.model.get("active-panel"))&&this.model.save({"active-panel":_}),this.contactspanel=new e.ContactsPanel({$parent:this.$el.find(".controlbox-panes")}),this.contactspanel.render(),e.xmppstatusview=new e.XMPPStatusView({model:e.xmppstatus}),e.xmppstatusview.render()},close:function(t){return t&&t.preventDefault&&t.preventDefault(),e.connection.connected&&!e.connection.disconnecting?this.model.save({closed:!0}):this.model.trigger("hide"),e.emit("controlBoxClosed",this),this},ensureClosedState:function(){this.model.get("closed")?this.hide():this.show()},hide:function(t){return this.$el.addClass("hidden"),f.refreshWebkit(),e.emit("chatBoxClosed",this),e.connection.connected||e.controlboxtoggle.render(),e.controlboxtoggle.show(t),this},onControlBoxToggleHidden:function(){var t=this;f.fadeIn(this.el,function(){e.controlboxtoggle.updateOnlineCount(),f.refreshWebkit(),t.model.set("closed",!1),e.emit("controlBoxOpened",t)})},show:function(){return e.controlboxtoggle.hide(this.onControlBoxToggleHidden.bind(this)),this},switchTab:function(t){t&&t.preventDefault&&t.preventDefault();var n=g(t.target),i=n.parent().siblings("li").children("a"),o=g(n.attr("href"));return g(i.attr("href")).addClass("hidden"),i.removeClass("current"),n.addClass("current"),o.removeClass("hidden"),v.isUndefined(e.chatboxes.browserStorage)||this.model.save({"active-panel":n.data("id")}),this},showHelpMessages:function(){}}),e.LoginPanel=Backbone.View.extend({tagName:"div",id:"login-dialog",className:"controlbox-pane",events:{"submit form#converse-login":"authenticate"},initialize:function(t){t.$parent.html(this.$el.html(u({ANONYMOUS:e.ANONYMOUS,EXTERNAL:e.EXTERNAL,LOGIN:e.LOGIN,PREBIND:e.PREBIND,auto_login:e.auto_login,authentication:e.authentication,label_username:b("XMPP Username:"),label_password:b("Password:"),label_anon_login:b("Click here to log in anonymously"),label_login:b("Log In"),placeholder_username:(e.locked_domain||e.default_domain)&&b("Username")||b("user@server"),placeholder_password:b("password")}))),this.$tabs=t.$parent.parent().find("#controlbox-tabs")},render:function(){return this.$tabs.append(d({label_sign_in:b("Sign in")})),this.$el.find("input#jid").focus(),this.$el.is(":visible")||this.$el.show(),this},authenticate:function(t){t&&t.preventDefault&&t.preventDefault();var n=g(t.target);if(e.authentication===e.ANONYMOUS)return void this.connect(n,e.jid,null);var i=n.find("input[name=jid]"),o=i.val(),s=n.find("input[name=password]"),r=s.val(),a=!1;return o||(a=!0,i.addClass("error")),r||e.authentication===e.EXTERNAL||(a=!0,s.addClass("error")),a?void 0:(e.locked_domain?o=m.escapeNode(o)+"@"+e.locked_domain:e.default_domain&&!v.includes(o,"@")&&(o=o+"@"+e.default_domain),this.connect(n,o,r),!1)},connect:function(t,n,i){var o;t&&t.find("input[type=submit]").hide().after('<span class="spinner login-submit"/>'),n&&(o=m.getResourceFromJid(n),n=o?m.getBareJidFromJid(n).toLowerCase()+"/"+o:n.toLowerCase()+e.generateResource()),e.connection.reset(),e.connection.connect(n,i,e.onConnectStatusChanged)},remove:function(){this.$tabs.empty(),this.$el.parent().empty()}}),e.XMPPStatusView=Backbone.View.extend({el:"span#xmpp-status-holder",events:{"click a.choose-xmpp-status":"toggleOptions","click #fancy-xmpp-status-select a.change-xmpp-status-message":"renderStatusChangeForm","submit #set-custom-xmpp-status":"setStatusMessage","click .dropdown dd ul li a":"setStatus"},initialize:function(){this.model.on("change:status",this.updateStatusUI,this),this.model.on("change:status_message",this.updateStatusUI,this),this.model.on("update-status-ui",this.updateStatusUI,this)},render:function(){var e,t=this.$el.find("select#select-xmpp-status"),n=this.model.get("status")||"offline",i=g("option",t),r=[];return this.$el.html(s()),this.$el.find("#fancy-xmpp-status-select").html(o({status_message:this.model.get("status_message")||b("I am %1$s",this.getPrettyStatus(n)),chat_status:n,desc_custom_status:b("Click here to write a custom status message"),desc_change_status:b("Click to change your chat status")})),i.each(function(){r.push(p({value:g(this).val(),text:this.text}))}),e=this.$el.find("#target dd ul").hide(),e.append(r.join("")),t.remove(),this},toggleOptions:function(e){e.preventDefault(),g(e.target).parent().parent().siblings("dd").find("ul").toggle("fast")},renderStatusChangeForm:function(t){t.preventDefault();var n=e.xmppstatus.get("status_message")||"",o=i({status_message:n,label_custom_status:b("Custom status"),label_save:b("Save")}),s=this.$el.find(".xmpp-status");s.parent().addClass("no-border"),s.replaceWith(o),this.$el.find(".custom-xmpp-status").focus().focus()},setStatusMessage:function(e){e.preventDefault(),this.model.setStatusMessage(g(e.target).find("input").val())},setStatus:function(t){t.preventDefault();var n=g(t.currentTarget),i=n.attr("data-value");"logout"===i?(this.$el.find(".dropdown dd ul").hide(),e.logOut()):(this.model.setStatus(i),this.$el.find(".dropdown dd ul").hide())},getPrettyStatus:function(e){return"chat"===e?b("online"):"dnd"===e?b("busy"):"xa"===e?b("away for long"):"away"===e?b("away"):"offline"===e?b("offline"):b(e)||b("online")},updateStatusUI:function(e){var t=e.get("status"),n=e.get("status_message")||b("I am %1$s",this.getPrettyStatus(t));this.$el.find("#fancy-xmpp-status-select").removeClass("no-border").html(o({chat_status:t,status_message:n,desc_custom_status:b("Click here to write a custom status message"),desc_change_status:b("Click to change your chat status")}))}}),e.ContactsPanel=Backbone.View.extend({tagName:"div",className:"controlbox-pane",id:"users",events:{"click a.toggle-xmpp-contact-form":"toggleContactForm","submit form.add-xmpp-contact":"addContactFromForm","submit form.search-xmpp-contact":"searchContacts","click a.subscribe-to-user":"addContactFromList"},initialize:function(e){e.$parent.append(this.$el),this.$tabs=e.$parent.parent().find("#controlbox-tabs")},render:function(){var i,o=r({label_online:b("Online"),label_busy:b("Busy"),label_away:b("Away"),label_offline:b("Offline"),label_logout:b("Log out"),include_offline_state:e.include_offline_state,allow_logout:e.allow_logout}),s=e.chatboxes.get("controlbox");return this.$tabs.append(a({label_contacts:y,is_current:s.get("active-panel")===_})),i=e.xhr_user_search?h({label_contact_name:b("Contact name"),label_search:b("Search")}):n({label_contact_username:b("e.g. user@example.org"),label_add:b("Add")}),e.allow_contact_requests&&(o+=t({label_click_to_chat:b("Click to add new chat contacts"),label_add_contact:b("Add a contact")})),this.$el.html(o),this.$el.find(".search-xmpp ul").append(i),s.get("active-panel")!==_&&this.$el.addClass("hidden"),this},toggleContactForm:function(e){e.preventDefault(),this.$el.find(".search-xmpp").toggle("fast",function(){g(this).is(":visible")&&g(this).find("input.username").focus()})},searchContacts:function(t){t.preventDefault(),g.getJSON(e.xhr_user_search_url+"?q="+g(t.target).find("input.username").val(),function(e){var t=g(".search-xmpp ul");t.find("li.found-user").remove(),t.find("li.chat-info").remove(),e.length||t.append('<li class="chat-info">'+b("No users found")+"</li>"),g(e).each(function(e,n){t.append(g('<li class="found-user"></li>').append(g('<a class="subscribe-to-user" href="#" title="'+b("Click to add as a chat contact")+'"></a>').attr("data-recipient",m.getNodeFromJid(n.id)+"@"+m.getDomainFromJid(n.id)).text(n.fullname)))})})},addContactFromForm:function(t){t.preventDefault();var n=g(t.target).find("input"),i=n.val();return i?(e.roster.addAndSubscribe(i),void g(".search-xmpp").hide()):void n.addClass("error")},addContactFromList:function(t){t.preventDefault();var n=g(t.target),i=n.attr("data-recipient"),o=n.text();e.roster.addAndSubscribe(i,o),n.parent().remove(),g(".search-xmpp").hide()}}),e.ControlBoxToggle=Backbone.View.extend({tagName:"a",className:"toggle-controlbox hidden",id:"toggle-controlbox",events:{click:"onClick"},attributes:{href:"#"},initialize:function(){e.chatboxviews.$el.prepend(this.render()),this.updateOnlineCount();var t=this;e.on("initialized",function(){e.roster.on("add",t.updateOnlineCount,t),e.roster.on("change",t.updateOnlineCount,t),e.roster.on("destroy",t.updateOnlineCount,t),e.roster.on("remove",t.updateOnlineCount,t)})},render:function(){return this.$el.html(c({label_toggle:b("Toggle chat")}))},updateOnlineCount:v.debounce(function(){if(!v.isUndefined(e.roster)){var t=this.$("#online-count");t.text("("+e.roster.getNumOnlineContacts()+")"),t.is(":visible")||t.show()}},e.animate?100:0),hide:function(e){this.el.classList.add("hidden"),e()},show:function(e){f.fadeIn(this.el,e)},showControlBox:function(){var t=e.chatboxes.get("controlbox");t||(t=e.addControlBox()),e.connection.connected?t.save({closed:!1}):t.trigger("show")},onClick:function(t){if(t.preventDefault(),g("div#controlbox").is(":visible")){var n=e.chatboxes.get("controlbox");e.connection.connected?n.save({closed:!0}):n.trigger("hide")}else this.showControlBox()}});var w=function(){var t=e.chatboxviews.get("controlbox");t.model.set({connected:!1}),t.$("#controlbox-tabs").empty(),t.renderLoginPanel()};e.on("disconnected",w);var x=function(){var t=e.chatboxviews.get("controlbox");t.model.get("connected")?e.chatboxviews.get("controlbox").onConnected():t.model.set({connected:!0})};e.on("reconnected",x)}})}),define("tpl!chatarea",["lodash"],function(_){return function(obj){function print(){__p+=__j.call(arguments,"")}obj||(obj={});var __t,__p="",__e=_.escape,__j=Array.prototype.join;with(obj)__p+='<div class="chat-area">\n    <div class="chat-content ',show_send_button&&(__p+="chat-content-sendbutton"),__p+='"></div>\n    <div class="new-msgs-indicator hidden">▼ '+__e(unread_msgs)+' ▼</div>\n    <form class="sendXMPPMessage" action="" method="post">\n        ',show_toolbar&&(__p+='\n            <ul class="chat-toolbar no-text-select"></ul>\n        '),__p+='\n        <textarea type="text" class="chat-textarea ',show_send_button&&(__p+="chat-textarea-send-button"),__p+='"\n            placeholder="'+__e(label_message)+'"/>\n    ',show_send_button&&(__p+='\n        <button type="button" class="pure-button send-button">Send</button>\n    '),__p+="\n    </form>\n</div>\n";return __p}}),define("tpl!chatroom",["lodash"],function(_){return function(obj){obj||(obj={});var __t,__p="";with(obj)__p+='<div class="flyout box-flyout">\n    <div class="chat-head chat-head-chatroom"></div>\n    <div class="chat-body chatroom-body"><span class="spinner centered"/></div>\n</div>\n';return __p}}),define("tpl!chatroom_features",["lodash"],function(_){return function(obj){function print(){__p+=__j.call(arguments,"")}obj||(obj={});var __t,__p="",__e=_.escape,__j=Array.prototype.join;with(obj)has_features&&(__p+='\n<p class="occupants-heading">'+__e(label_features)+"</p>\n"),__p+='\n<ul class="features-list">\n',passwordprotected&&(__p+='\n<li class="feature" title="'+__e(tt_passwordprotected)+'"><span class="icon-lock-2"></span>'+__e(label_passwordprotected)+"</li>\n"),__p+="\n",unsecured&&(__p+='\n<li class="feature" title="'+__e(tt_unsecured)+'"><span class="icon-unlocked"></span>'+__e(label_unsecured)+"</li>\n"),__p+="\n",hidden&&(__p+='\n<li class="feature" title="'+__e(tt_hidden)+'"><span class="icon-eye-blocked"></span>'+__e(label_hidden)+"</li>\n"),__p+="\n",public&&(__p+='\n<li class="feature" title="'+__e(tt_public)+'"><span class="icon-eye"></span>'+__e(label_public)+"</li>\n"),__p+="\n",membersonly&&(__p+='\n<li class="feature" title="'+__e(tt_membersonly)+'"><span class="icon-address-book"></span>'+__e(label_membersonly)+"</li>\n"),__p+="\n",open&&(__p+='\n<li class="feature" title="'+__e(tt_open)+'"><span class="icon-globe"></span>'+__e(label_open)+"</li>\n"),__p+="\n",persistent&&(__p+='\n<li class="feature" title="'+__e(tt_persistent)+'"><span class="icon-save"></span>'+__e(label_persistent)+"</li>\n"),__p+="\n",temporary&&(__p+='\n<li class="feature" title="'+__e(tt_temporary)+'"><span class="icon-snowflake"></span>'+__e(label_temporary)+"</li>\n"),__p+="\n",nonanonymous&&(__p+='\n<li class="feature" title="'+__e(tt_nonanonymous)+'"><span class="icon-idcard-dark"></span>'+__e(label_nonanonymous)+"</li>\n"),__p+="\n",semianonymous&&(__p+='\n<li class="feature" title="'+__e(tt_semianonymous)+'"><span class="icon-info"></span>'+__e(label_semianonymous)+"</li>\n"),__p+="\n",moderated&&(__p+='\n<li class="feature" title="'+__e(tt_moderated)+'"><span class="icon-legal"></span>'+__e(label_moderated)+"</li>\n"),__p+="\n",unmoderated&&(__p+='\n<li class="feature" title="'+__e(tt_unmoderated)+'"><span class="icon-info"></span>'+__e(label_unmoderated)+"</li>\n"),__p+="\n",mam_enabled&&(__p+='\n<li class="feature" title="'+__e(tt_mam_enabled)+'"><span class="icon-database"></span>'+__e(label_mam_enabled)+"</li>\n"),__p+="\n</ul>\n";return __p}}),define("tpl!chatroom_form",["lodash"],function(_){return function(obj){obj||(obj={});var __t,__p="";with(obj)__p+='<div class="chatroom-form-container">\n    <form class="pure-form pure-form-stacked converse-form chatroom-form">\n        <fieldset>\n            <span class="spinner centered"/>\n        </fieldset>\n    </form>\n</div>\n';return __p}}),define("tpl!chatroom_head",["lodash"],function(_){return function(obj){function print(){__p+=__j.call(arguments,"")}obj||(obj={});var __t,__p="",__e=_.escape,__j=Array.prototype.join;with(obj)__p+='<a class="chatbox-btn close-chatbox-button icon-close" title="'+__e(info_close)+'"></a>\n',"owner"==affiliation&&(__p+='\n    <a class="chatbox-btn configure-chatroom-button icon-wrench" title="'+__e(info_configure)+' "></a>\n'),__p+='\n<div class="chat-title" title="'+__e(jid)+'">\n    '+__e(name)+'\n    <p class="chatroom-description">'+__e(description)+"<p/>\n</div>\n";return __p}}),define("tpl!chatroom_invite",["lodash"],function(_){return function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj)__p+='<form class="pure-form room-invite">\n    <input class="invited-contact" placeholder="'+__e(label_invitation)+'" type="text"/>\n</form>\n';return __p}}),define("tpl!chatroom_nickname_form",["lodash"],function(_){return function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj)__p+='<div class="chatroom-form-container">\n    <form class="pure-form converse-form chatroom-form converse-centered-form">\n        <fieldset>\n            <label>'+__e(heading)+'</label>\n            <p class="validation-message">'+__e(validation_message)+'</p>\n            <input type="text" required="required" name="nick" class="new-chatroom-nick" placeholder="'+__e(label_nickname)+'"/>\n        </fieldset>\n        <fieldset>\n            <input type="submit" class="pure-button button-primary" name="join" value="'+__e(label_join)+'"/>\n        </fieldset>\n    </form>\n</div>\n';return __p}}),define("tpl!chatroom_password_form",["lodash"],function(_){return function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj)__p+='<div class="chatroom-form-container">\n    <form class="pure-form converse-form chatroom-form">\n        <fieldset>\n            <legend>'+__e(heading)+"</legend>\n            <label>"+__e(label_password)+'</label>\n            <input type="password" name="password"/>\n        </fieldset>\n        <fieldset>\n            <input class="pure-button button-primary" type="submit" value="'+__e(label_submit)+'"/>\n        </fieldset>\n    </form>\n</div>\n';return __p}}),define("tpl!chatroom_sidebar",["lodash"],function(_){return function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj)__p+='<!-- <div class="occupants"> -->\n<p class="occupants-heading">'+__e(label_occupants)+'</p>\n<ul class="occupant-list"></ul>\n<div class="chatroom-features"></div>\n<!-- </div> -->\n';return __p}}),define("tpl!chatroom_toolbar",["lodash"],function(_){return function(obj){function print(){__p+=__j.call(arguments,"")}obj||(obj={});var __t,__p="",__e=_.escape,__j=Array.prototype.join;with(obj)show_emoticons&&(__p+='\n    <li class="toggle-smiley icon-happy" title="'+__e(label_insert_smiley)+'">\n        <ul>\n            <li><a class="icon-smiley" href="#" data-emoticon=":)"></a></li>\n            <li><a class="icon-wink" href="#" data-emoticon=";)"></a></li>\n            <li><a class="icon-grin" href="#" data-emoticon=":D"></a></li>\n            <li><a class="icon-tongue" href="#" data-emoticon=":P"></a></li>\n            <li><a class="icon-cool" href="#" data-emoticon="8)"></a></li>\n            <li><a class="icon-evil" href="#" data-emoticon=">:)"></a></li>\n            <li><a class="icon-confused" href="#" data-emoticon=":S"></a></li>\n            <li><a class="icon-wondering" href="#" data-emoticon=":\\"></a></li>\n            <li><a class="icon-angry" href="#" data-emoticon=">:("></a></li>\n            <li><a class="icon-sad" href="#" data-emoticon=":("></a></li>\n            <li><a class="icon-shocked" href="#" data-emoticon=":O"></a></li>\n            <li><a class="icon-thumbs-up" href="#" data-emoticon="(^.^)b"></a></li>\n            <li><a class="icon-heart" href="#" data-emoticon="<3"></a></li>\n        </ul>\n    </li>\n'),__p+="\n",show_call_button&&(__p+='\n<li class="toggle-call"><a class="icon-phone" title="'+__e(label_start_call)+'"></a></li>\n'),__p+="\n",show_occupants_toggle&&(__p+='\n<li class="toggle-occupants"><a class="icon-hide-users" title="'+__e(label_hide_occupants)+'"></a></li>\n'),__p+="\n",show_clear_button&&(__p+='\n<li class="toggle-clear"><a class="icon-remove" title="'+__e(label_clear)+'"></a></li>\n'),__p+="\n\n";return __p}}),define("tpl!chatrooms_tab",["lodash"],function(_){return function(obj){function print(){__p+=__j.call(arguments,"")}obj||(obj={});var __t,__p="",__j=Array.prototype.join;with(obj)__p+='<li><a class="s ',is_current&&(__p+=" current "),__p+='"\n       data-id="chatrooms" href="#chatrooms">\n    '+(null==(__t=label_rooms)?"":__t)+"\n</a></li>\n";return __p}}),define("tpl!info",["lodash"],function(_){return function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj)__p+='<div class="chat-info">'+__e(message)+"</div>\n";return __p}}),define("tpl!occupant",["lodash"],function(_){return function(obj){function print(){__p+=__j.call(arguments,"")}obj||(obj={});var __t,__p="",__e=_.escape,__j=Array.prototype.join;with(obj)__p+='<li class="'+__e(role)+' occupant" id="'+__e(id)+'"\n    ',"moderator"===role&&(__p+='\n       title="'+__e(jid)+" "+__e(desc_moderator)+" "+__e(hint_occupant)+'"\n    '),__p+="\n    ","occupant"===role&&(__p+='\n       title="'+__e(jid)+" "+__e(desc_occupant)+" "+__e(hint_occupant)+'"\n    '),__p+="\n    ","visitor"===role&&(__p+='\n       title="'+__e(jid)+" "+__e(desc_visitor)+" "+__e(hint_occupant)+'"\n    '),__p+="\n    ",_.includes(["visitor","occupant","moderator"],role)||(__p+='\n       title="'+__e(jid)+" "+__e(hint_occupant)+'"\n       '),__p+='><div class="occupant-status occupant-'+__e(show)+' circle" title="'+__e(hint_show)+'"></div>'+__e(nick)+"</li>\n";return __p}}),define("tpl!room_description",["lodash"],function(_){return function(obj){function print(){__p+=__j.call(arguments,"")}obj||(obj={});var __t,__p="",__e=_.escape,__j=Array.prototype.join;with(obj)__p+='<!-- FIXME: check markup in mockup -->\n<div class="room-info">\n<p class="room-info"><strong>'+__e(label_desc)+"</strong> "+__e(desc)+'</p>\n<p class="room-info"><strong>'+__e(label_occ)+"</strong> "+__e(occ)+'</p>\n<p class="room-info"><strong>'+__e(label_features)+"</strong>\n    <ul>\n        ",passwordprotected&&(__p+='\n        <li class="room-info locked">'+__e(label_requires_auth)+"</li>\n        "),__p+="\n        ",hidden&&(__p+='\n        <li class="room-info">'+__e(label_hidden)+"</li>\n        "),__p+="\n        ",membersonly&&(__p+='\n        <li class="room-info">'+__e(label_requires_invite)+"</li>\n        "),__p+="\n        ",moderated&&(__p+='\n        <li class="room-info">'+__e(label_moderated)+"</li>\n        "),__p+="\n        ",nonanonymous&&(__p+='\n        <li class="room-info">'+__e(label_non_anon)+"</li>\n        "),__p+="\n        ",open&&(__p+='\n        <li class="room-info">'+__e(label_open_room)+"</li>\n        "),__p+="\n        ",persistent&&(__p+='\n        <li class="room-info">'+__e(label_permanent_room)+"</li>\n        "),__p+="\n        ",publicroom&&(__p+='\n        <li class="room-info">'+__e(label_public)+"</li>\n        "),__p+="\n        ",semianonymous&&(__p+='\n        <li class="room-info">'+__e(label_semi_anon)+"</li>\n        "),__p+="\n        ",temporary&&(__p+='\n        <li class="room-info">'+__e(label_temp_room)+"</li>\n        "),__p+="\n        ",unmoderated&&(__p+='\n        <li class="room-info">'+__e(label_unmoderated)+"</li>\n        "),__p+="\n    </ul>\n</p>\n</div>\n";return __p}}),define("tpl!room_item",["lodash"],function(_){return function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj)__p+='<dd class="available-chatroom">\n<a class="open-room" data-room-jid="'+__e(jid)+'"\n   title="'+__e(open_title)+'" href="#">'+__e(_.escape(name))+'</a>\n<a class="room-info icon-room-info" data-room-jid="'+__e(jid)+'"\n   title="'+__e(info_title)+'" href="#">&nbsp;</a>\n</dd>\n';return __p}}),define("tpl!room_panel",["lodash"],function(_){return function(obj){function print(){__p+=__j.call(arguments,"")}obj||(obj={});var __t,__p="",__j=Array.prototype.join;with(obj)__p+='<form class="pure-form pure-form-stacked converse-form add-chatroom" action="" method="post">\n    <fieldset>\n        <label>'+(null==(__t=label_room_name)?"":__t)+'</label>\n        <input type="text" name="chatroom" class="new-chatroom-name" placeholder="'+(null==(__t=label_room_name)?"":__t)+'"/>\n        ',"hidden"!=server_input_type&&(__p+="\n            <label"+(null==(__t=server_label_global_attr)?"":__t)+">"+(null==(__t=label_server)?"":__t)+"</label>\n        "),__p+='\n        <input type="'+(null==(__t=server_input_type)?"":__t)+'" name="server" class="new-chatroom-server" placeholder="'+(null==(__t=label_server)?"":__t)+'"/>\n        <input type="submit" class="pure-button button-primary" name="join" value="'+(null==(__t=label_join)?"":__t)+'"/>\n        <input type="button" class="pure-button button-secondary" name="show" id="show-rooms" value="'+(null==(__t=label_show_rooms)?"":__t)+'"/>\n    </fieldset>\n</form>\n<dl id="available-chatrooms" class="rooms-list"></dl>\n';return __p}}),function(e,t){define("converse-muc",["converse-core","tpl!chatarea","tpl!chatroom","tpl!chatroom_features","tpl!chatroom_form","tpl!chatroom_head","tpl!chatroom_invite","tpl!chatroom_nickname_form","tpl!chatroom_password_form","tpl!chatroom_sidebar","tpl!chatroom_toolbar","tpl!chatrooms_tab","tpl!info","tpl!occupant","tpl!room_description","tpl!room_item","tpl!room_panel","awesomplete","converse-chatview"],t);
}(this,function(e,t,n,i,o,s,r,a,l,c,u,d,h,p,_,m,f,g){"use strict";var v="chatrooms",b=e.env.Strophe,y=e.env.$iq,w=e.env.$build,x=e.env.$msg,C=e.env.$pres,S=e.env.b64_sha1,k=e.env.sizzle,j=e.env.utils,N=e.env.jQuery,A=e.env._,E=e.env.moment;b.addNamespace("MUC_ADMIN",b.NS.MUC+"#admin"),b.addNamespace("MUC_OWNER",b.NS.MUC+"#owner"),b.addNamespace("MUC_REGISTER","jabber:iq:register"),b.addNamespace("MUC_ROOMCONF",b.NS.MUC+"#roomconfig"),b.addNamespace("MUC_USER",b.NS.MUC+"#user");var R=["passwordprotected","unsecured","hidden","public","membersonly","open","persistent","temporary","nonanonymous","semianonymous","moderated","unmoderated","mam_enabled"],T={passwordprotected:"unsecured",unsecured:"passwordprotected",hidden:"public",public:"hidden",membersonly:"open",open:"membersonly",persistent:"temporary",temporary:"persistent",nonanonymous:"semianonymous",semianonymous:"nonanonymous",moderated:"unmoderated",unmoderated:"moderated"},M={CONNECTED:0,CONNECTING:1,NICKNAME_REQUIRED:2,PASSWORD_REQUIRED:3,DISCONNECTED:4,ENTERED:5};e.plugins.add("converse-muc",{optional_dependencies:["converse-controlbox"],overrides:{Features:{addClientFeatures:function(){var e=this.__super__._converse;this.__super__.addClientFeatures.apply(this,arguments),e.allow_muc_invitations&&e.connection.disco.addFeature("jabber:x:conference"),e.allow_muc&&e.connection.disco.addFeature(b.NS.MUC)}},ControlBoxView:{renderContactsPanel:function(){var e=this.__super__._converse;this.__super__.renderContactsPanel.apply(this,arguments),e.allow_muc&&(this.roomspanel=new e.RoomsPanel({$parent:this.$el.find(".controlbox-panes"),model:new(Backbone.Model.extend({id:S("converse.roomspanel"+e.bare_jid),browserStorage:new Backbone.BrowserStorage[e.storage](S("converse.roomspanel"+e.bare_jid))}))}),this.roomspanel.render().model.fetch(),this.roomspanel.model.get("nick")||this.roomspanel.model.save({nick:b.getNodeFromJid(e.bare_jid)}))},onConnected:function(){var e=this.__super__._converse;if(this.__super__.onConnected.apply(this,arguments),this.model.get("connected"))if(A.isUndefined(e.muc_domain)){e.features.off("add",this.featureAdded,this),e.features.on("add",this.featureAdded,this);var t=e.features.findWhere({var:b.NS.MUC});t&&this.featureAdded(t)}else this.setMUCDomain(e.muc_domain)},setMUCDomain:function(e){this.roomspanel.model.save({muc_domain:e});var t=this.$el.find("input.new-chatroom-server");t.is(":focus")||t.val(this.roomspanel.model.get("muc_domain"))},featureAdded:function(e){var t=this.__super__._converse;e.get("var")===b.NS.MUC&&t.allow_muc&&this.setMUCDomain(e.get("from"))}},ChatBoxViews:{onChatBoxAdded:function(e){var t=this.__super__._converse,n=this.get(e.get("id"));return n||"chatroom"!==e.get("type")?this.__super__.onChatBoxAdded.apply(this,arguments):(n=new t.ChatRoomView({model:e}),this.add(e.get("id"),n))}}},initialize:function(){var e=this._converse,D=e.__,F=e.___;if(e.muc={info_messages:{100:D("This room is not anonymous"),102:D("This room now shows unavailable members"),103:D("This room does not show unavailable members"),104:D("The room configuration has changed"),170:D("Room logging is now enabled"),171:D("Room logging is now disabled"),172:D("This room is now no longer anonymous"),173:D("This room is now semi-anonymous"),174:D("This room is now fully-anonymous"),201:D("A new room has been created")},disconnect_messages:{301:D("You have been banned from this room"),307:D("You have been kicked from this room"),321:D("You have been removed from this room because of an affiliation change"),322:D("You have been removed from this room because the room has changed to members-only and you're not a member"),332:D("You have been removed from this room because the MUC (Multi-user chat) service is being shut down.")},action_info_messages:{301:F("%1$s has been banned"),303:F("%1$s's nickname has changed"),307:F("%1$s has been kicked out"),321:F("%1$s has been removed because of an affiliation change"),322:F("%1$s has been removed for not being a member")},new_nickname_messages:{210:F("Your nickname has been automatically set to: %1$s"),303:F("Your nickname has been changed to: %1$s")}},this.updateSettings({allow_muc:!0,allow_muc_invitations:!0,auto_join_on_invite:!1,auto_join_rooms:[],auto_list_rooms:!1,hide_muc_server:!1,muc_disable_moderator_commands:!1,muc_domain:void 0,muc_history_max_stanzas:void 0,muc_instant_rooms:!0,muc_nickname_from_jid:!1,muc_show_join_leave:!0,visible_toolbar_buttons:{toggle_occupants:!0}}),e.createChatRoom=function(t){return t=A.extend(A.zipObject(R,A.map(R,A.stubFalse)),t),e.chatboxviews.showChat(A.extend({affiliation:null,connection_status:M.DISCONNECTED,description:"",features_fetched:!1,roomconfig:{},type:"chatroom"},t))},e.ChatRoomView=e.ChatBoxView.extend({length:300,tagName:"div",className:"chatbox chatroom hidden",is_chatroom:!0,events:{"click .close-chatbox-button":"close","click .configure-chatroom-button":"configureChatRoom","click .toggle-smiley":"toggleEmoticonMenu","click .toggle-smiley ul li":"insertEmoticon","click .toggle-clear":"clearChatRoomMessages","click .toggle-call":"toggleCall","click .toggle-occupants a":"toggleOccupants","click .new-msgs-indicator":"viewUnreadMessages","click .occupant":"onOccupantClicked","keypress .chat-textarea":"keyPressed","click .send-button":"onSendButtonClicked"},initialize:function(){var t=this;this.model.messages.on("add",this.onMessageAdded,this),this.model.on("show",this.show,this),this.model.on("destroy",this.hide,this),this.model.on("change:connection_status",this.afterConnected,this),this.model.on("change:affiliation",this.renderHeading,this),this.model.on("change:chat_state",this.sendChatState,this),this.model.on("change:description",this.renderHeading,this),this.model.on("change:name",this.renderHeading,this),this.createOccupantsView(),this.render().insertIntoDOM(),this.registerHandlers(),this.model.get("connection_status")!==M.ENTERED?this.getRoomFeatures().always(function(){t.join(),t.fetchMessages(),e.emit("chatRoomOpened",t)}):(this.fetchMessages(),e.emit("chatRoomOpened",t))},render:function(){return this.el.setAttribute("id",this.model.get("box_id")),this.el.innerHTML=n(),this.renderHeading(),this.renderChatArea(),this.model.get("connection_status")!==M.ENTERED&&this.showSpinner(),j.refreshWebkit(),this},renderHeading:function(){this.el.querySelector(".chat-head-chatroom").innerHTML=this.generateHeadingHTML()},renderChatArea:function(){return this.$(".chat-area").length||(this.$(".chatroom-body").empty().append(t({unread_msgs:D("You have unread messages"),show_toolbar:e.show_toolbar,label_message:D("Message"),show_send_button:e.show_send_button})).append(this.occupantsview.$el),this.renderToolbar(u),this.$content=this.$el.find(".chat-content")),this.toggleOccupants(null,!0),this},createOccupantsView:function(){var t=new e.ChatRoomOccupants;t.chatroomview=this,this.occupantsview=new e.ChatRoomOccupantsView({model:t});var n=S("converse.occupants"+e.bare_jid+this.model.get("jid"));return this.occupantsview.model.browserStorage=new Backbone.BrowserStorage.session(n),this.occupantsview.render(),this.occupantsview.model.fetch({add:!0}),this},insertIntoDOM:function(){if(!document.querySelector("body").contains(this.el)){var t=e.chatboxviews.get("controlbox");return t?this.$el.insertAfter(t.$el):N("#conversejs").prepend(this.$el),this}},generateHeadingHTML:function(){return s(A.extend(this.model.toJSON(),{info_close:D("Close and leave this room"),info_configure:D("Configure this room"),description:this.model.get("description")||""}))},afterShown:function(){e.connection.connected&&this.model.save(),this.occupantsview.setOccupantsHeight()},afterConnected:function(){this.model.get("connection_status")===M.ENTERED&&(this.setChatState(e.ACTIVE),this.scrollDown(),this.focus())},getExtraMessageClasses:function(t){var n=e.ChatBoxView.prototype.getExtraMessageClasses.apply(this,arguments);return this.is_chatroom&&"them"===t.sender&&new RegExp("\\b"+this.model.get("nick")+"\\b").test(t.message)&&(n+=" mentioned"),n},getToolbarOptions:function(){return A.extend(e.ChatBoxView.prototype.getToolbarOptions.apply(this,arguments),{label_hide_occupants:D("Hide the list of occupants"),show_occupants_toggle:this.is_chatroom&&e.visible_toolbar_buttons.toggle_occupants})},close:function(e){this.leave()},toggleOccupants:function(e,t){e&&(e.preventDefault(),e.stopPropagation()),t&&this.model.set({hidden_occupants:!this.model.get("hidden_occupants")}),this.model.get("hidden_occupants")?(this.model.save({hidden_occupants:!1}),this.$(".icon-show-users").removeClass("icon-show-users").addClass("icon-hide-users"),this.$(".chat-area").removeClass("full"),this.$("div.occupants").removeClass("hidden"),this.scrollDown()):(this.model.save({hidden_occupants:!0}),this.$(".icon-hide-users").removeClass("icon-hide-users").addClass("icon-show-users"),this.$(".occupants").addClass("hidden"),this.$(".chat-area").addClass("full"),this.scrollDown())},onOccupantClicked:function(e){this.insertIntoTextArea(e.target.textContent)},requestMemberList:function(t,n){var i=new N.Deferred;n=n||"member";var o=y({to:t,type:"get"}).c("query",{xmlns:b.NS.MUC_ADMIN}).c("item",{affiliation:n});return e.connection.sendIQ(o,i.resolve,i.reject),i.promise()},parseMemberListIQ:function(e){return A.map(N(e).find('query[xmlns="'+b.NS.MUC_ADMIN+'"] item'),function(e){return{jid:e.getAttribute("jid"),affiliation:e.getAttribute("affiliation")}})},computeAffiliationsDelta:function(e,t,n,i){var o=A.map(n,"jid"),s=A.map(i,"jid"),r=A.map(A.difference(o,s),function(e){return n[A.indexOf(o,e)]});return e||(r=r.concat(A.filter(n,function(e){var t=A.indexOf(s,e.jid);return t>=0&&e.affiliation!==i[t].affiliation}))),t&&(r=r.concat(A.map(A.difference(s,o),function(e){return{jid:e,affiliation:"none"}}))),r},sendAffiliationIQ:function(t,n,i){var o=new N.Deferred,s=y({to:t,type:"set"}).c("query",{xmlns:b.NS.MUC_ADMIN}).c("item",{affiliation:i.affiliation||n,jid:i.jid});return A.isUndefined(i.reason)||s.c("reason",i.reason),e.connection.sendIQ(s,o.resolve,o.reject),o},setAffiliation:function(e,t){t=A.filter(t,function(t){return A.isUndefined(t.affiliation)||t.affiliation===e});var n=A.map(t,A.partial(this.sendAffiliationIQ,this.model.get("jid"),e));return N.when.apply(N,n)},setAffiliations:function(e,t,n){if(A.isEmpty(e))return void t(null);var i=A.uniq(A.map(e,"affiliation")),o=A.map(i,A.partial(this.setAffiliation.bind(this),A,e));N.when.apply(N,o).done(t).fail(n)},marshallAffiliationIQs:function(){return A.flatMap(arguments,this.parseMemberListIQ)},getJidsWithAffiliations:function(e){A.isString(e)&&(e=[e]);var t=new N.Deferred,n=A.map(e,A.partial(this.requestMemberList,this.model.get("jid")));return N.when.apply(N,n).always(A.flow(this.marshallAffiliationIQs.bind(this),t.resolve)),t.promise()},updateMemberLists:function(e,t,n){var i=this,o=new N.Deferred;return this.getJidsWithAffiliations(t).then(function(t){i.setAffiliations(n(e,t),o.resolve,o.reject)}),o.promise()},directInvite:function(t,n){if(this.model.get("membersonly")){var i={};i[t]="member";var o=A.partial(this.computeAffiliationsDelta,!0,!1);this.updateMemberLists([{jid:t,affiliation:"member",reason:n}],["member","owner","admin"],o)}var s={xmlns:"jabber:x:conference",jid:this.model.get("jid")};null!==n&&(s.reason=n),this.model.get("password")&&(s.password=this.model.get("password"));var r=x({from:e.connection.jid,to:t,id:e.connection.getUniqueId()}).c("x",s);e.connection.send(r),e.emit("roomInviteSent",{room:this,recipient:t,reason:n})},handleChatStateMessage:function(t){t.get("fullname")!==this.model.get("nick")&&t.get("chat_state")!==e.GONE&&e.ChatBoxView.prototype.handleChatStateMessage.apply(this,arguments)},sendChatState:function(){if(this.model.get("connection_status")===M.ENTERED){var t=this.model.get("chat_state");t!==e.GONE&&e.connection.send(x({to:this.model.get("jid"),type:"groupchat"}).c(t,{xmlns:b.NS.CHATSTATES}).up().c("no-store",{xmlns:b.NS.HINTS}).up().c("no-permanent-store",{xmlns:b.NS.HINTS}))}},sendChatRoomMessage:function(t){var n=e.connection.getUniqueId(),i=x({to:this.model.get("jid"),from:e.connection.jid,type:"groupchat",id:n}).c("body").t(t).up().c("x",{xmlns:"jabber:x:event"}).c(e.COMPOSING);e.connection.send(i),this.model.messages.create({fullname:this.model.get("nick"),sender:"me",time:E().format(),message:t,msgid:n})},modifyRole:function(t,n,i,o,s,r){var a=w("item",{nick:n,role:i}),l=y({to:t,type:"set"}).c("query",{xmlns:b.NS.MUC_ADMIN}).cnode(a.node);return null!==o&&l.c("reason",o),e.connection.sendIQ(l.tree(),s,r)},validateRoleChangeCommand:function(e,t){return!(t.length<1||t.length>2)||(this.showStatusNotification(D('Error: the "'+e+"\" command takes two arguments, the user's nickname and optionally a reason."),!0),!1)},clearChatRoomMessages:function(e){A.isUndefined(e)||e.stopPropagation();var t=confirm(D("Are you sure you want to clear the messages from this room?"));return t===!0&&this.$content.empty(),this},onCommandError:function(){this.showStatusNotification(D("Error: could not execute the command"),!0)},onMessageSubmitted:function(t){if(e.muc_disable_moderator_commands)return this.sendChatRoomMessage(t);var n=t.replace(/^\s*/,"").match(/^\/(.*?)(?: (.*))?$/)||[!1,"",""],i=n[2]&&n[2].splitOnce(" ")||[],o=n[1].toLowerCase();switch(o){case"admin":if(!this.validateRoleChangeCommand(o,i))break;this.setAffiliation("admin",[{jid:i[0],reason:i[1]}]).fail(this.onCommandError.bind(this));break;case"ban":if(!this.validateRoleChangeCommand(o,i))break;this.setAffiliation("outcast",[{jid:i[0],reason:i[1]}]).fail(this.onCommandError.bind(this));break;case"clear":this.clearChatRoomMessages();break;case"deop":if(!this.validateRoleChangeCommand(o,i))break;this.modifyRole(this.model.get("jid"),i[0],"occupant",i[1],void 0,this.onCommandError.bind(this));break;case"help":this.showHelpMessages(["<strong>/admin</strong>: "+D("Change user's affiliation to admin"),"<strong>/ban</strong>: "+D("Ban user from room"),"<strong>/clear</strong>: "+D("Remove messages"),"<strong>/deop</strong>: "+D("Change user role to occupant"),"<strong>/help</strong>: "+D("Show this menu"),"<strong>/kick</strong>: "+D("Kick user from room"),"<strong>/me</strong>: "+D("Write in 3rd person"),"<strong>/member</strong>: "+D("Grant membership to a user"),"<strong>/mute</strong>: "+D("Remove user's ability to post messages"),"<strong>/nick</strong>: "+D("Change your nickname"),"<strong>/op</strong>: "+D("Grant moderator role to user"),"<strong>/owner</strong>: "+D("Grant ownership of this room"),"<strong>/revoke</strong>: "+D("Revoke user's membership"),"<strong>/subject</strong>: "+D("Set room subject"),"<strong>/topic</strong>: "+D("Set room subject (alias for /subject)"),"<strong>/voice</strong>: "+D("Allow muted user to post messages")]);break;case"kick":if(!this.validateRoleChangeCommand(o,i))break;this.modifyRole(this.model.get("jid"),i[0],"none",i[1],void 0,this.onCommandError.bind(this));break;case"mute":if(!this.validateRoleChangeCommand(o,i))break;this.modifyRole(this.model.get("jid"),i[0],"visitor",i[1],void 0,this.onCommandError.bind(this));break;case"member":if(!this.validateRoleChangeCommand(o,i))break;this.setAffiliation("member",[{jid:i[0],reason:i[1]}]).fail(this.onCommandError.bind(this));break;case"nick":e.connection.send(C({from:e.connection.jid,to:this.getRoomJIDAndNick(n[2]),id:e.connection.getUniqueId()}).tree());break;case"owner":if(!this.validateRoleChangeCommand(o,i))break;this.setAffiliation("owner",[{jid:i[0],reason:i[1]}]).fail(this.onCommandError.bind(this));break;case"op":if(!this.validateRoleChangeCommand(o,i))break;this.modifyRole(this.model.get("jid"),i[0],"moderator",i[1],void 0,this.onCommandError.bind(this));break;case"revoke":if(!this.validateRoleChangeCommand(o,i))break;this.setAffiliation("none",[{jid:i[0],reason:i[1]}]).fail(this.onCommandError.bind(this));break;case"topic":case"subject":e.connection.send(x({to:this.model.get("jid"),from:e.connection.jid,type:"groupchat"}).c("subject",{xmlns:"jabber:client"}).t(n[2]).tree());break;case"voice":if(!this.validateRoleChangeCommand(o,i))break;this.modifyRole(this.model.get("jid"),i[0],"occupant",i[1],void 0,this.onCommandError.bind(this));break;default:this.sendChatRoomMessage(t)}},handleMUCMessage:function(e){var t=e.querySelector("status[code='104']"),n=e.querySelector("status[code='170']"),i=e.querySelector("status[code='171']"),o=e.querySelector("status[code='172']"),s=e.querySelector("status[code='173']"),r=e.querySelector("status[code='173']");return(t||n||i||o||s||r)&&this.getRoomFeatures(),A.flow(this.showStatusMessages.bind(this),this.onChatRoomMessage.bind(this))(e),!0},getRoomJIDAndNick:function(e){e?this.model.save({nick:e}):e=this.model.get("nick");var t=this.model.get("jid"),n=b.getNodeFromJid(t),i=b.getDomainFromJid(t);return n+"@"+i+(null!==e?"/"+e:"")},registerHandlers:function(){var t=this.model.get("jid");this.removeHandlers(),this.presence_handler=e.connection.addHandler(this.onChatRoomPresence.bind(this),b.NS.MUC,"presence",null,null,t,{ignoreNamespaceFragment:!0,matchBareFromJid:!0}),this.message_handler=e.connection.addHandler(this.handleMUCMessage.bind(this),null,"message",null,null,t,{matchBareFromJid:!0})},removeHandlers:function(){return this.message_handler&&(e.connection.deleteHandler(this.message_handler),delete this.message_handler),this.presence_handler&&(e.connection.deleteHandler(this.presence_handler),delete this.presence_handler),this},join:function(t,n){if(t=t?t:this.model.get("nick"),!t)return this.checkForReservedNick();if(this.model.get("connection_status")===M.ENTERED)return this;var i=C({from:e.connection.jid,to:this.getRoomJIDAndNick(t)}).c("x",{xmlns:b.NS.MUC}).c("history",{maxstanzas:e.muc_history_max_stanzas}).up();return n&&i.cnode(b.xmlElement("password",[],n)),this.model.save("connection_status",M.CONNECTING),e.connection.send(i),this},cleanup:function(){this.model.save("connection_status",M.DISCONNECTED),this.removeHandlers(),e.ChatBoxView.prototype.close.apply(this,arguments)},leave:function(t){if(this.hide(),this.occupantsview.model.reset(),this.occupantsview.model.browserStorage._clear(),!e.connection.connected||this.model.get("connection_status")===M.DISCONNECTED)return void this.cleanup();var n=C({type:"unavailable",from:e.connection.jid,to:this.getRoomJIDAndNick()});null!==t&&n.c("status",t),e.connection.sendPresence(n,this.cleanup.bind(this),this.cleanup.bind(this),2e3)},renderConfigurationForm:function(e){var t=this,n=this.$(".chatroom-body");n.children().addClass("hidden"),n.find("form.chatroom-form").remove(),n.append(o());var i=n.find("form.chatroom-form"),s=i.children("fieldset:first"),r=N(e),a=r.find("field"),l=r.find("title").text(),c=r.find("instructions").text();s.find("span.spinner").remove(),s.append(N("<legend>").text(l)),c&&c!==l&&s.append(N('<p class="instructions">').text(c)),A.each(a,function(e){s.append(j.xForm2webForm(N(e),r))}),i.append("<fieldset></fieldset>"),s=i.children("fieldset:last"),s.append('<input type="submit" class="pure-button button-primary" value="'+D("Save")+'"/>'),s.append('<input type="button" class="pure-button button-cancel" value="'+D("Cancel")+'"/>'),s.find("input[type=button]").on("click",function(e){e.preventDefault(),t.cancelConfiguration()}),i.on("submit",function(e){e.preventDefault(),t.saveConfiguration(e.target)})},sendConfiguration:function(t,n,i){var o=y({to:this.model.get("jid"),type:"set"}).c("query",{xmlns:b.NS.MUC_OWNER}).c("x",{xmlns:b.NS.XFORM,type:"submit"});return A.each(t||[],function(e){o.cnode(e).up()}),n=A.isUndefined(n)?A.noop:A.partial(n,o.nodeTree),i=A.isUndefined(i)?A.noop:A.partial(i,o.nodeTree),e.connection.sendIQ(o,n,i)},saveConfiguration:function(e){var t=new N.Deferred,n=this,i=N(e).find(":input:not([type=button]):not([type=submit])"),o=[];return i.each(function(){o.push(j.webForm2xForm(this))}),this.sendConfiguration(o,t.resolve,t.reject),this.$el.find("div.chatroom-form-container").hide(function(){N(this).remove(),n.renderAfterTransition()}),t.promise()},autoConfigureChatRoom:function(e){var t=this,n=[],i=N(e).find("field"),o=i.length,s=this.model.get("roomconfig");i.each(function(){var e,i=this.getAttribute("var").replace("muc#roomconfig_",""),r=this.getAttribute("type");if(i in s){switch(r){case"boolean":e=s[i]?1:0;break;case"list-multi":e=this.innerHTML;break;default:e=s[i]}this.innerHTML=w("value").t(e)}n.push(this),--o||t.sendConfiguration(n)})},cancelConfiguration:function(){var e=this;this.$el.find("div.chatroom-form-container").hide(function(){N(this).remove(),e.renderAfterTransition()})},fetchRoomConfiguration:function(t){var n=this,i=new N.Deferred;return e.connection.sendIQ(y({to:this.model.get("jid"),type:"get"}).c("query",{xmlns:b.NS.MUC_OWNER}),function(e){t&&t.apply(n,arguments),i.resolve(e)},i.reject),i.promise()},getRoomFeatures:function(){var t=new N.Deferred,n=this;return e.connection.disco.info(this.model.get("jid"),null,function(e){var i={features_fetched:!0};A.each(e.querySelectorAll("feature"),function(e){var t=e.getAttribute("var");return t.startsWith("muc_")?void(i[t.replace("muc_","")]=!0):void(t===b.NS.MAM&&(i.mam_enabled=!0))});var o=e.querySelector('field[var="muc#roominfo_description"] value');return A.isNull(o)||(i.description=o.textContent),n.model.save(i),t.resolve()},t.reject,5e3),t.promise()},configureChatRoom:function(e){A.isUndefined(e)&&this.model.get("auto_configure")?this.fetchRoomConfiguration().then(this.autoConfigureChatRoom.bind(this)):(!A.isUndefined(e)&&e.preventDefault&&e.preventDefault(),this.showSpinner(),this.fetchRoomConfiguration().then(this.renderConfigurationForm.bind(this)))},submitNickname:function(e){e.preventDefault();var t=this.$el.find("input[name=nick]"),n=t.val();return n?(t.removeClass("error"),this.$el.find(".chatroom-form-container").replaceWith('<span class="spinner centered"/>'),void this.join(n)):void t.addClass("error")},checkForReservedNick:function(){return this.showSpinner(),e.connection.sendIQ(y({to:this.model.get("jid"),from:e.connection.jid,type:"get"}).c("query",{xmlns:b.NS.DISCO_INFO,node:"x-roomuser-item"}),this.onNickNameFound.bind(this),this.onNickNameNotFound.bind(this)),this},onNickNameFound:function(e){var t=N(e).find('query[node="x-roomuser-item"] identity').attr("name");t?this.join(t):this.onNickNameNotFound()},onNickNameNotFound:function(t){e.muc_nickname_from_jid?this.join(b.unescapeNode(b.getNodeFromJid(e.bare_jid))):this.renderNicknameForm(t)},getDefaultNickName:function(){return b.unescapeNode(b.getNodeFromJid(e.bare_jid))},onNicknameClash:function(t){if(e.muc_nickname_from_jid){var n=t.getAttribute("from").split("/")[1];if(n===this.getDefaultNickName())this.join(n+"-2");else{var i=n.lastIndexOf("-"),o=n.substring(i+1,n.length);this.join(n.substring(0,i+1)+String(Number(o)+1))}}else this.renderNicknameForm(D("The nickname you chose is reserved or currently in use, please choose a different one."))},renderNicknameForm:function(e){this.$(".chatroom-body").children().addClass("hidden"),this.$("span.centered.spinner").remove(),A.isString(e)||(e=""),this.$(".chatroom-body").append(a({heading:D("Please choose your nickname"),label_nickname:D("Nickname"),label_join:D("Enter room"),validation_message:e})),this.model.save("connection_status",M.NICKNAME_REQUIRED),this.$(".chatroom-form").on("submit",this.submitNickname.bind(this))},submitPassword:function(e){e.preventDefault();var t=this.$el.find(".chatroom-form").find("input[type=password]").val();this.$el.find(".chatroom-form-container").replaceWith('<span class="spinner centered"/>'),this.join(this.model.get("nick"),t)},renderPasswordForm:function(){this.$(".chatroom-body").children().addClass("hidden"),this.$("span.centered.spinner").remove(),this.$(".chatroom-body").append(l({heading:D("This chatroom requires a password"),label_password:D("Password: "),label_submit:D("Submit")})),this.model.save("connection_status",M.PASSWORD_REQUIRED),this.$(".chatroom-form").on("submit",this.submitPassword.bind(this))},showDisconnectMessage:function(e){this.$(".chat-area").addClass("hidden"),this.$(".occupants").addClass("hidden"),this.$("span.centered.spinner").remove(),this.$(".chatroom-body").append(N("<p>"+e+"</p>"))},getMessageFromStatus:function(t,n,i){var o,s=t.getAttribute("code");if("110"!==s){if(s in e.muc.info_messages)return e.muc.info_messages[s];if(i){if(s in e.muc.new_nickname_messages)return i&&"210"===s?o=b.getResourceFromJid(n.getAttribute("from")):i&&"303"===s&&(o=n.querySelector("x item").getAttribute("nick")),D(e.muc.new_nickname_messages[s],o)}else if(s in e.muc.action_info_messages)return o=b.getResourceFromJid(n.getAttribute("from")),D(e.muc.action_info_messages[s],o)}},saveAffiliationAndRole:function(t){var n=k('x[xmlns="'+b.NS.MUC_USER+'"] item',t).pop();if(!A.isNil(n)){var i=n.getAttribute("jid");if(b.getBareJidFromJid(i)===e.bare_jid){var o=n.getAttribute("affiliation"),s=n.getAttribute("role");o&&this.model.save({affiliation:o}),s&&this.model.save({role:s})}}},parseXUserElement:function(t,n,i){var o=t.querySelectorAll("status"),s=A.partial(this.getMessageFromStatus,A,n,i),r={},a=A.reject(A.map(o,s),A.isUndefined);a.length&&(r.messages=a);var l=A.invokeMap(o,Element.prototype.getAttribute,"code"),c=A.intersection(l,A.keys(e.muc.disconnect_messages)),u=i&&c.length>0;u&&(r.disconnected=!0,r.disconnection_message=e.muc.disconnect_messages[c[0]]);var d=t.querySelector("item");if(!A.isNull(d)){var h=d.querySelector("reason");h&&(r.reason=h?h.textContent:void 0);var p=d.querySelector("actor");p&&(r.actor=p?p.getAttribute("nick"):void 0)}return r},displayNotificationsforUser:function(e){var t=this;return e.disconnected?(this.showDisconnectMessage(e.disconnection_message),e.actor&&this.showDisconnectMessage(D(F("This action was done by %1$s."),e.actor)),e.reason&&this.showDisconnectMessage(D(F('The reason given is: "%1$s".'),e.reason)),void this.model.save("connection_status",M.DISCONNECTED)):(A.each(e.messages,function(e){t.$content.append(h({message:e}))}),e.reason&&this.showStatusNotification(D('The reason given is: "'+e.reason+'"'),!0),void(e.messages.length&&this.scrollDown()))},getJoinLeaveMessages:function(e){var t=b.getResourceFromJid(e.getAttribute("from")),n=e.querySelector("status");return"unavailable"===e.getAttribute("type")?!A.isNull(n)&&n.textContent?[{messages:[D(t+' has left the room. "'+n.textContent+'"')]}]:[{messages:[D(t+" has left the room")]}]:this.occupantsview.model.find({nick:t})?void 0:!A.isNull(n)&&n.textContent?[{messages:[D(t+' has joined the room. "'+n.textContent+'"')]}]:[{messages:[D(t+" has joined the room.")]}]},showStatusMessages:function(t){var n=k('x[xmlns="'+b.NS.MUC_USER+'"]',t),i=t.querySelectorAll("status[code='110']").length,o=A.partial(this.parseXUserElement.bind(this),A,t,i),s=A.reject(A.map(n,o),A.isEmpty);return A.isEmpty(s)&&e.muc_show_join_leave&&"presence"===t.nodeName&&this.model.get("connection_status")===M.ENTERED&&(s=this.getJoinLeaveMessages(t)),A.each(s,this.displayNotificationsforUser.bind(this)),t},showErrorMessage:function(e){var t=e.querySelector("error");"auth"===t.getAttribute("type")?A.isNull(t.querySelector("not-authorized"))?A.isNull(t.querySelector("registration-required"))?A.isNull(t.querySelector("forbidden"))||this.showDisconnectMessage(D("You have been banned from this room")):this.showDisconnectMessage(D("You are not on the member list of this room")):this.renderPasswordForm():"modify"===t.getAttribute("type")?A.isNull(t.querySelector("jid-malformed"))||this.showDisconnectMessage(D("No nickname was specified")):"cancel"===t.getAttribute("type")&&(A.isNull(t.querySelector("not-allowed"))?A.isNull(t.querySelector("not-acceptable"))?A.isNull(t.querySelector("conflict"))?A.isNull(t.querySelector("item-not-found"))?A.isNull(t.querySelector("service-unavailable"))||this.showDisconnectMessage(D("This room has reached its maximum number of occupants")):this.showDisconnectMessage(D("This room does not (yet) exist")):this.onNicknameClash(e):this.showDisconnectMessage(D("Your nickname doesn't conform to this room's policies")):this.showDisconnectMessage(D("You are not allowed to create new rooms")))},renderAfterTransition:function(){this.model.get("connection_status")==M.NICKNAME_REQUIRED?this.renderNicknameForm():this.model.get("connection_status")==M.PASSWORD_REQUIRED?this.renderPasswordForm():(this.$el.find(".chat-area").removeClass("hidden"),this.$el.find(".occupants").removeClass("hidden"),this.occupantsview.setOccupantsHeight(),this.scrollDown())},showSpinner:function(){this.$(".chatroom-body").children().addClass("hidden"),this.$el.find(".chatroom-body").prepend('<span class="spinner centered"/>')},hideSpinner:function(){var e=this.el.querySelector(".spinner");return A.isNull(e)||(e.parentNode.removeChild(e),this.renderAfterTransition()),this},createInstantRoom:function(){this.saveConfiguration().then(this.getRoomFeatures.bind(this))},onChatRoomPresence:function(t){if("error"===t.getAttribute("type"))return this.model.save("connection_status",M.DISCONNECTED),this.showErrorMessage(t),!0;var n=t.querySelector("status[code='110']"),i=t.querySelector("status[code='201']");if(n){if(this.saveAffiliationAndRole(t),i)if(e.muc_instant_rooms)this.createInstantRoom();else if(this.configureChatRoom(),!this.model.get("auto_configure"))return;this.model.save("connection_status",M.ENTERED),this.hideSpinner()}return i||this.model.get("features_fetched")||this.model.get("connection_status")===M.CONNECTED||this.getRoomFeatures(),this.hideSpinner().showStatusMessages(t),this.occupantsview.updateOccupantsOnPresence(t),"none"!==this.model.get("role")&&this.model.get("connection_status")===M.CONNECTING&&this.model.save("connection_status",M.CONNECTED),!0},setChatRoomSubject:function(e,t){this.$content.append(h({message:D("Topic set by %1$s to: %2$s",e,t)})),this.scrollDown()},onChatRoomMessage:function(t){var n,i=t,o=t.querySelector("forwarded");A.isNull(o)||(t=o.querySelector("message"),n=o.querySelector("delay"));var s=t.getAttribute("from"),r=t.getAttribute("id"),a=b.getResourceFromJid(s),l=a&&b.unescapeNode(a)||"",c=A.propertyOf(t.querySelector("subject"))("textContent"),u=r&&this.model.messages.filter(function(e){return e.get("msgid")===r&&e.get("fullname")===l});return!(!u||!u.length)||(c&&this.setChatRoomSubject(l,c),""===l||(this.model.createMessage(t,n,i),l!==this.model.get("nick")&&e.emit("message",i),!0))}}),e.ChatRoomOccupant=Backbone.Model.extend({initialize:function(t){this.set(A.extend({id:e.connection.getUniqueId()},t))}}),e.ChatRoomOccupantView=Backbone.View.extend({tagName:"li",initialize:function(){this.model.on("change",this.render,this),this.model.on("destroy",this.destroy,this)},render:function(){var t=this.model.get("show")||"online",n=p(A.extend({jid:"",show:t,hint_show:e.PRETTY_CHAT_STATUS[t],hint_occupant:D("Click to mention "+this.model.get("nick")+" in your message."),desc_moderator:D("This user is a moderator."),desc_occupant:D("This user can send messages in this room."),desc_visitor:D("This user can NOT send messages in this room.")},this.model.toJSON())),i=this.$el.parents();return i.length?(this.$el.replaceWith(n),this.setElement(i.first().children("#"+this.model.get("id")),!0),this.delegateEvents()):(this.$el.replaceWith(n),this.setElement(n,!0)),this},destroy:function(){this.$el.remove()}}),e.ChatRoomOccupants=Backbone.Collection.extend({model:e.ChatRoomOccupant}),e.ChatRoomOccupantsView=Backbone.Overview.extend({tagName:"div",className:"occupants",initialize:function(){this.model.on("add",this.onOccupantAdded,this),this.chatroomview=this.model.chatroomview,this.chatroomview.model.on("change:open",this.renderInviteWidget,this),this.chatroomview.model.on("change:affiliation",this.renderInviteWidget,this),this.chatroomview.model.on("change:hidden",this.onFeatureChanged,this),this.chatroomview.model.on("change:mam_enabled",this.onFeatureChanged,this),this.chatroomview.model.on("change:membersonly",this.onFeatureChanged,this),this.chatroomview.model.on("change:moderated",this.onFeatureChanged,this),this.chatroomview.model.on("change:nonanonymous",this.onFeatureChanged,this),
this.chatroomview.model.on("change:open",this.onFeatureChanged,this),this.chatroomview.model.on("change:passwordprotected",this.onFeatureChanged,this),this.chatroomview.model.on("change:persistent",this.onFeatureChanged,this),this.chatroomview.model.on("change:public",this.onFeatureChanged,this),this.chatroomview.model.on("change:semianonymous",this.onFeatureChanged,this),this.chatroomview.model.on("change:temporary",this.onFeatureChanged,this),this.chatroomview.model.on("change:unmoderated",this.onFeatureChanged,this),this.chatroomview.model.on("change:unsecured",this.onFeatureChanged,this)},render:function(){return this.el.innerHTML=c(A.extend(this.chatroomview.model.toJSON(),{allow_muc_invitations:e.allow_muc_invitations,label_occupants:D("Occupants")})),e.allow_muc_invitations&&e.api.waitUntil("rosterContactsFetched").then(this.renderInviteWidget.bind(this)),this.renderRoomFeatures()},renderInviteWidget:function(){var e=this.el.querySelector("form.room-invite");if(this.shouldInviteWidgetBeShown()){if(A.isNull(e)){var t=this.el.querySelector(".occupants-heading");e=r({label_invitation:D("Invite")}),t.insertAdjacentHTML("afterend",e),this.initInviteWidget()}}else A.isNull(e)||e.remove();return this},renderRoomFeatures:function(){var e=A.pick(this.chatroomview.model.attributes,R),t=function(e,t){return e||t},n=this.el.querySelector(".chatroom-features");return n.innerHTML=i(A.extend(this.chatroomview.model.toJSON(),{has_features:A.reduce(A.values(e),t),label_features:D("Features"),label_hidden:D("Hidden"),label_mam_enabled:D("Message archiving"),label_membersonly:D("Members only"),label_moderated:D("Moderated"),label_nonanonymous:D("Non-anonymous"),label_open:D("Open"),label_passwordprotected:D("Password protected"),label_persistent:D("Persistent"),label_public:D("Public"),label_semianonymous:D("Semi-anonymous"),label_temporary:D("Temporary"),label_unmoderated:D("Unmoderated"),label_unsecured:D("Unsecured"),tt_hidden:D("This room is not publicly searchable"),tt_mam_enabled:D("Messages are archived on the server"),tt_membersonly:D("This room is restricted to members only"),tt_moderated:D("This room is being moderated"),tt_nonanonymous:D("All other room occupants can see your Jabber ID"),tt_open:D("Anyone can join this room"),tt_passwordprotected:D("This room requires a password before entry"),tt_persistent:D("This room persists even if it's unoccupied"),tt_public:D("This room is publicly searchable"),tt_semianonymous:D("Only moderators can see your Jabber ID"),tt_temporary:D("This room will disappear once the last person leaves"),tt_unmoderated:D("This room is not being moderated"),tt_unsecured:D("This room does not require a password upon entry")})),this.setOccupantsHeight(),this},onFeatureChanged:function(e){A.isUndefined(this.debouncedRenderRoomFeatures)&&(this.debouncedRenderRoomFeatures=A.debounce(this.renderRoomFeatures,100,{leading:!1}));var t={};A.each(A.keys(e.changed),function(n){A.isNil(T[n])||(t[T[n]]=!e.changed[n])}),this.chatroomview.model.save(t,{silent:!0}),this.debouncedRenderRoomFeatures()},setOccupantsHeight:function(){var e=this.el.querySelector(".chatroom-features");this.el.querySelector(".occupant-list").style.cssText="height: calc(100% - "+e.offsetHeight+"px - 5em);"},onOccupantAdded:function(t){var n=this.get(t.get("id"));n?(delete n.model,n.model=t,n.initialize()):n=this.add(t.get("id"),new e.ChatRoomOccupantView({model:t})),this.$(".occupant-list").append(n.render().$el)},parsePresence:function(e){var t=b.getResourceFromJid(e.getAttribute("from")),n={nick:t,type:e.getAttribute("type"),states:[]};return A.each(e.childNodes,function(e){switch(e.nodeName){case"status":n.status=e.textContent||null;break;case"show":n.show=e.textContent||"online";break;case"x":e.getAttribute("xmlns")===b.NS.MUC_USER&&A.each(e.childNodes,function(e){switch(e.nodeName){case"item":n.affiliation=e.getAttribute("affiliation"),n.role=e.getAttribute("role"),n.jid=e.getAttribute("jid"),n.nick=e.getAttribute("nick")||n.nick;break;case"status":e.getAttribute("code")&&n.states.push(e.getAttribute("code"))}})}}),n},findOccupant:function(e){var t=b.getBareJidFromJid(e.jid);return null!==t?this.model.where({jid:t}).pop():this.model.where({nick:e.nick}).pop()},updateOccupantsOnPresence:function(e){var t=this.parsePresence(e);if("error"===t.type)return!0;var n=this.findOccupant(t);switch(t.type){case"unavailable":n&&n.destroy();break;default:var i=b.getBareJidFromJid(t.jid),o=A.extend(t,{jid:i?i:void 0,resource:t.jid?b.getResourceFromJid(t.jid):void 0});n?n.save(o):this.model.create(o)}},promptForInvite:function(e){var t=prompt(D(F('You are about to invite %1$s to the chat room "%2$s". '),e.text.label,this.model.get("id"))+D("You may optionally include a message, explaining the reason for the invitation."));null!==t&&this.chatroomview.directInvite(e.text.value,t),e.target.value=""},inviteFormSubmitted:function(e){e.preventDefault();var t=e.target.querySelector("input.invited-contact");this.promptForInvite({target:t,text:{label:t.value,value:t.value}})},shouldInviteWidgetBeShown:function(){return e.allow_muc_invitations&&(this.chatroomview.model.get("open")||"owner"===this.chatroomview.model.get("affiliation"))},initInviteWidget:function(){var t=this.el.querySelector("form.room-invite");if(!A.isNull(t)){t.addEventListener("submit",this.inviteFormSubmitted.bind(this));var n=this.el.querySelector("input.invited-contact"),i=e.roster.map(function(e){var t=e.get("fullname")||e.get("jid");return{label:t,value:e.get("jid")}});new g(n,{minChars:1,list:i});n.addEventListener("awesomplete-selectcomplete",this.promptForInvite.bind(this))}}}),e.RoomsPanel=Backbone.View.extend({tagName:"div",className:"controlbox-pane",id:"chatrooms",events:{"submit form.add-chatroom":"createChatRoom","click input#show-rooms":"showRooms","click a.open-room":"createChatRoom","click a.room-info":"toggleRoomInfo","change input[name=server]":"setDomain","change input[name=nick]":"setNick"},initialize:function(e){this.$parent=e.$parent,this.model.on("change:muc_domain",this.onDomainChange,this),this.model.on("change:nick",this.onNickChange,this)},render:function(){this.$parent.append(this.$el.html(f({server_input_type:e.hide_muc_server&&"hidden"||"text",server_label_global_attr:e.hide_muc_server&&" hidden"||"",label_room_name:D("Room name"),label_nickname:D("Nickname"),label_server:D("Server"),label_join:D("Join Room"),label_show_rooms:D("Show rooms")}))),this.$tabs=this.$parent.parent().find("#controlbox-tabs");var t=e.chatboxes.get("controlbox");return this.$tabs.append(d({label_rooms:D("Rooms"),is_current:t.get("active-panel")===v})),t.get("active-panel")!==v&&this.$el.addClass("hidden"),this},onDomainChange:function(t){var n=this.$el.find("input.new-chatroom-server");n.val(t.get("muc_domain")),e.auto_list_rooms&&this.updateRoomsList()},onNickChange:function(e){var t=this.$el.find("input.new-chatroom-nick");t.val(e.get("nick"))},informNoRoomsFound:function(){var e=this.$el.find("#available-chatrooms");e.html("<dt>"+D("No rooms on %1$s",this.model.get("muc_domain"))+"</dt>"),N("input#show-rooms").show().siblings("span.spinner").remove()},onRoomsFound:function(e){var t,n,i,o,s=this.$el.find("#available-chatrooms");if(this.rooms=N(e).find("query").find("item"),this.rooms.length){for(s.html("<dt>"+D("Rooms on %1$s",this.model.get("muc_domain"))+"</dt>"),o=document.createDocumentFragment(),i=0;i<this.rooms.length;i++)t=b.unescapeNode(N(this.rooms[i]).attr("name")||N(this.rooms[i]).attr("jid")),n=N(this.rooms[i]).attr("jid"),o.appendChild(N(m({name:t,jid:n,open_title:D("Click to open this room"),info_title:D("Show more information on this room")}))[0]);s.append(o),N("input#show-rooms").show().siblings("span.spinner").remove()}else this.informNoRoomsFound();return!0},updateRoomsList:function(){e.connection.sendIQ(y({to:this.model.get("muc_domain"),from:e.connection.jid,type:"get"}).c("query",{xmlns:b.NS.DISCO_ITEMS}),this.onRoomsFound.bind(this),this.informNoRoomsFound.bind(this))},showRooms:function(){var e=this.$el.find("#available-chatrooms"),t=this.$el.find("input.new-chatroom-server"),n=t.val();return n?(this.$el.find("input.new-chatroom-name").removeClass("error"),t.removeClass("error"),e.empty(),N("input#show-rooms").hide().after('<span class="spinner"/>'),this.model.save({muc_domain:n}),void this.updateRoomsList()):void t.addClass("error")},insertRoomInfo:function(e,t){var n=N(t);N(e).find("span.spinner").replaceWith(_({desc:n.find('field[var="muc#roominfo_description"] value').text(),occ:n.find('field[var="muc#roominfo_occupants"] value').text(),hidden:n.find('feature[var="muc_hidden"]').length,membersonly:n.find('feature[var="muc_membersonly"]').length,moderated:n.find('feature[var="muc_moderated"]').length,nonanonymous:n.find('feature[var="muc_nonanonymous"]').length,open:n.find('feature[var="muc_open"]').length,passwordprotected:n.find('feature[var="muc_passwordprotected"]').length,persistent:n.find('feature[var="muc_persistent"]').length,publicroom:n.find('feature[var="muc_public"]').length,semianonymous:n.find('feature[var="muc_semianonymous"]').length,temporary:n.find('feature[var="muc_temporary"]').length,unmoderated:n.find('feature[var="muc_unmoderated"]').length,label_desc:D("Description:"),label_occ:D("Occupants:"),label_features:D("Features:"),label_requires_auth:D("Requires authentication"),label_hidden:D("Hidden"),label_requires_invite:D("Requires an invitation"),label_moderated:D("Moderated"),label_non_anon:D("Non-anonymous"),label_open_room:D("Open room"),label_permanent_room:D("Permanent room"),label_public:D("Public"),label_semi_anon:D("Semi-anonymous"),label_temp_room:D("Temporary room"),label_unmoderated:D("Unmoderated")}))},toggleRoomInfo:function(t){var n=t.target,i=N(n).parent("dd"),o=i.find("div.room-info");o.length?o.remove():(i.find("span.spinner").remove(),i.append('<span class="spinner hor_centered"/>'),e.connection.disco.info(N(n).attr("data-room-jid"),null,A.partial(this.insertRoomInfo,i[0])))},createChatRoom:function(t){t.preventDefault();var n,i,o,s,r;if("click"===t.type)n=N(t.target).text(),r=N(t.target).attr("data-room-jid");else{if(i=this.$el.find("input.new-chatroom-name"),s=this.$el.find("input.new-chatroom-server"),o=s.val(),n=i.val().trim(),i.val(""),!n||!o)return n||i.addClass("error"),void(o||s.addClass("error"));r=b.escapeNode(n.toLowerCase())+"@"+o.toLowerCase(),i.removeClass("error"),s.removeClass("error"),this.model.save({muc_domain:o})}e.createChatRoom({id:r,jid:r,name:n||b.unescapeNode(b.getNodeFromJid(r)),type:"chatroom",box_id:S(r)})},setDomain:function(e){this.model.save({muc_domain:e.target.value})},setNick:function(e){this.model.save({nick:e.target.value})}}),e.onDirectMUCInvitation=function(t){var n,i=N(t),o=i.children('x[xmlns="jabber:x:conference"]'),s=b.getBareJidFromJid(i.attr("from")),r=o.attr("jid"),a=o.attr("reason"),l=e.roster.get(s);if(e.auto_join_on_invite?n=!0:(l=l?l.get("fullname"):b.getNodeFromJid(s),n=a?confirm(D(F('%1$s has invited you to join a chat room: %2$s, and left the following reason: "%3$s"'),l,r,a)):confirm(D(F("%1$s has invited you to join a chat room: %2$s"),l,r))),n===!0){var c=e.createChatRoom({id:r,jid:r,name:b.unescapeNode(b.getNodeFromJid(r)),nick:b.unescapeNode(b.getNodeFromJid(e.connection.jid)),type:"chatroom",box_id:S(r),password:o.attr("password")});c.get("connection_status")===M.DISCONNECTED&&e.chatboxviews.get(r).join()}},e.allow_muc_invitations){var O=function(){e.connection.addHandler(function(t){return e.onDirectMUCInvitation(t),!0},"jabber:x:conference","message")};e.on("connected",O),e.on("reconnected",O)}var I=function(){A.each(e.auto_join_rooms,function(t){A.isString(t)?e.api.rooms.open(t):A.isObject(t)?e.api.rooms.open(t.jid,t.nick):e.log('Invalid room criteria specified for "auto_join_rooms"',"error")})};e.on("chatBoxesFetched",I),e.getChatRoom=function(t,n,i){return t=t.toLowerCase(),e.getViewForChatBox(i(A.extend({id:t,jid:t,name:b.unescapeNode(b.getNodeFromJid(t)),type:"chatroom",box_id:S(t)},n)))},A.extend(e.api,{rooms:{close:function(t){if(A.isUndefined(t))e.chatboxviews.each(function(e){e.is_chatroom&&e.model&&e.close()});else if(A.isString(t)){var n=e.chatboxviews.get(t);n&&n.close()}else A.each(t,function(t){var n=e.chatboxviews.get(t);n&&n.close()})},open:function(t,n){if(A.isString(n)?n={nick:n}:A.isUndefined(n)&&(n={}),A.isUndefined(n.maximize)&&(n.maximize=!1),!n.nick&&e.muc_nickname_from_jid&&(n.nick=b.getNodeFromJid(e.bare_jid)),A.isUndefined(t))throw new TypeError("rooms.open: You need to provide at least one JID");return A.isString(t)?e.getChatRoom(t,n,e.createChatRoom):A.map(t,A.partial(e.getChatRoom,A,n,e.createChatRoom))},get:function(t,n,i){if(A.isString(n)?n={nick:n}:A.isUndefined(n)&&(n={}),A.isUndefined(t)){var o=[];return e.chatboxes.each(function(t){"chatroom"===t.get("type")&&o.push(e.getViewForChatBox(t))}),o}var s=A.partial(e.chatboxviews.getChatBox.bind(e.chatboxviews),A,i);return n.nick||(n.nick=b.getNodeFromJid(e.bare_jid)),A.isString(t)?e.getChatRoom(t,n,s):A.map(t,A.partial(e.getChatRoom,A,n,s))}}});var B=function(){e.chatboxviews.each(function(e){"chatroom"===e.model.get("type")&&(e.model.save("connection_status",M.DISCONNECTED),e.join())})};e.on("reconnected",B);var $=function(){e.chatboxes.each(function(e){"chatroom"===e.get("type")&&e.save("connection_status",M.DISCONNECTED)})};e.on("reconnecting",$),e.on("disconnecting",$)}})}),define("tpl!chatroom_bookmark_form",["lodash"],function(_){return function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj)__p+='<div class="chatroom-form-container">\n    <form class="pure-form converse-form chatroom-form">\n        <fieldset>\n            <legend>'+__e(heading)+"</legend>\n            <label>"+__e(label_name)+'</label>\n            <input type="text" name="name" required="required"/>\n            <label>'+__e(label_autojoin)+'</label>\n            <input type="checkbox" name="autojoin"/>\n            <label>'+__e(label_nick)+'</label>\n            <input type="text" name="nick" value="'+__e(default_nick)+'"/>\n        </fieldset>\n        <fieldset>\n            <input class="pure-button button-primary" type="submit" value="'+__e(label_submit)+'"/>\n            <input class="pure-button button-cancel" type="button" value="'+__e(label_cancel)+'"/>\n        </fieldset>\n    </form>\n</div>\n';return __p}}),define("tpl!chatroom_bookmark_toggle",["lodash"],function(_){return function(obj){function print(){__p+=__j.call(arguments,"")}obj||(obj={});var __t,__p="",__e=_.escape,__j=Array.prototype.join;with(obj)__p+='<a class="chatbox-btn toggle-bookmark icon-pushpin\n   ',bookmarked&&(__p+="\n    button-on\n   "),__p+='" title="'+__e(info_toggle_bookmark)+'"></a>\n';return __p}}),define("tpl!bookmark",["lodash"],function(_){return function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj)__p+='<dd class="available-chatroom">\n    <a class="open-room" data-room-jid="'+__e(jid)+'" title="'+__e(open_title)+'" href="#">'+__e(name)+'</a>\n    <a class="remove-bookmark icon-close" data-room-jid="'+__e(jid)+'" data-bookmark-name="'+__e(name)+'"\n       title="'+__e(info_remove)+'" href="#">&nbsp;</a>\n    <a class="room-info icon-room-info" data-room-jid="'+__e(jid)+'"\n       title="'+__e(info_title)+'" href="#">&nbsp;</a>\n</dd>\n';return __p}}),define("tpl!bookmarks_list",["lodash"],function(_){return function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj)__p+='<a href="#" class="bookmarks-toggle icon-'+__e(toggle_state)+'" title="'+__e(desc_bookmarks)+'">'+__e(label_bookmarks)+'</a>\n<dl class="bookmarks rooms-list"></dl>\n';return __p}}),function(e,t){define("converse-bookmarks",["utils","converse-core","converse-muc","tpl!chatroom_bookmark_form","tpl!chatroom_bookmark_toggle","tpl!bookmark","tpl!bookmarks_list"],t)}(this,function(e,t,n,i,o,s,r){var a=t.env.jQuery,l=t.env.Strophe,c=t.env.$iq,u=t.env.b64_sha1,d=t.env._;t.plugins.add("converse-bookmarks",{overrides:{clearSession:function(){this.__super__.clearSession.apply(this,arguments),d.isUndefined(this.bookmarks)||this.bookmarks.browserStorage._clear()},ChatRoomView:{events:{"click .toggle-bookmark":"toggleBookmark"},initialize:function(){this.__super__.initialize.apply(this,arguments),this.model.on("change:bookmarked",this.onBookmarked,this),this.setBookmarkState()},generateHeadingHTML:function(){var e=this.__super__._converse,t=e.__,n=this.__super__.generateHeadingHTML.apply(this,arguments);if(e.allow_bookmarks){var i=document.createElement("div");i.innerHTML=n;var s=o(d.assignIn(this.model.toJSON(),{info_toggle_bookmark:t("Bookmark this room"),bookmarked:this.model.get("bookmarked")})),r=i.querySelector(".close-chatbox-button");return r.insertAdjacentHTML("afterend",s),i.innerHTML}return n},checkForReservedNick:function(){var e=this.__super__._converse;if(d.isUndefined(e.bookmarks)||!e.allow_bookmarks)return this.__super__.checkForReservedNick.apply(this,arguments);var t=e.bookmarks.findWhere({jid:this.model.get("jid")});return d.isUndefined(t)||!t.get("nick")?this.__super__.checkForReservedNick.apply(this,arguments):void this.join(t.get("nick"))},onBookmarked:function(){this.model.get("bookmarked")?this.$(".icon-pushpin").addClass("button-on"):this.$(".icon-pushpin").removeClass("button-on")},setBookmarkState:function(){var e=this.__super__._converse;if(!d.isUndefined(e.bookmarks)){var t=e.bookmarks.where({jid:this.model.get("jid")});t.length?this.model.save("bookmarked",!0):this.model.save("bookmarked",!1)}},renderBookmarkForm:function(){var e=this.__super__._converse,t=e.__,n=this.$(".chatroom-body");n.children().addClass("hidden"),n.find("form.chatroom-form").remove(),n.append(i({heading:t("Bookmark this room"),label_name:t("The name for this bookmark:"),label_autojoin:t("Would you like this room to be automatically joined upon startup?"),label_nick:t("What should your nickname for this room be?"),default_nick:this.model.get("nick"),label_submit:t("Save"),label_cancel:t("Cancel")})),this.$(".chatroom-form").submit(this.onBookmarkFormSubmitted.bind(this)),this.$(".chatroom-form .button-cancel").on("click",this.cancelConfiguration.bind(this))},onBookmarkFormSubmitted:function(e){e.preventDefault();var t=this.__super__._converse,n=a(e.target),i=this;t.bookmarks.createBookmark({jid:this.model.get("jid"),autojoin:n.find('input[name="autojoin"]').prop("checked"),name:n.find("input[name=name]").val(),nick:n.find("input[name=nick]").val()}),this.$el.find("div.chatroom-form-container").hide(function(){a(this).remove(),i.renderAfterTransition()})},toggleBookmark:function(e){e&&(e.preventDefault(),e.stopPropagation());var t=this.__super__._converse,n=t.bookmarks.where({jid:this.model.get("jid")});n.length?(d.forEach(n,function(e){e.destroy()}),this.$(".icon-pushpin").removeClass("button-on")):this.renderBookmarkForm()}}},initialize:function(){var e=this._converse,t=e.__,n=e.___;this.updateSettings({allow_bookmarks:!0}),e.Bookmark=Backbone.Model,e.BookmarksList=Backbone.Model.extend({defaults:{"toggle-state":e.OPENED}}),e.Bookmarks=Backbone.Collection.extend({model:e.Bookmark,initialize:function(){this.on("add",d.flow(this.openBookmarkedRoom,this.markRoomAsBookmarked)),this.on("remove",this.markRoomAsUnbookmarked,this),this.on("remove",this.sendBookmarkStanza,this);var t="converse.room-bookmarks"+e.bare_jid;this.cached_flag=u(t+"fetched"),this.browserStorage=new Backbone.BrowserStorage[e.storage](u(t))},openBookmarkedRoom:function(t){return t.get("autojoin")&&e.api.rooms.open(t.get("jid"),t.get("nick")),t},fetchBookmarks:function(){var e=new a.Deferred,t=e.promise();return window.sessionStorage.getItem(this.browserStorage.name)?this.fetch({success:d.bind(this.onCachedBookmarksFetched,this,e),error:d.bind(this.onCachedBookmarksFetched,this,e)}):window.sessionStorage.getItem(this.cached_flag)?e.resolve():this.fetchBookmarksFromServer(e),t},onCachedBookmarksFetched:function(e){return e.resolve()},createBookmark:function(t){e.bookmarks.create(t),e.bookmarks.sendBookmarkStanza()},sendBookmarkStanza:function(){var t=c({type:"set",from:e.connection.jid}).c("pubsub",{xmlns:l.NS.PUBSUB}).c("publish",{node:"storage:bookmarks"}).c("item",{id:"current"}).c("storage",{xmlns:"storage:bookmarks"});this.each(function(e){t=t.c("conference",{name:e.get("name"),autojoin:e.get("autojoin"),jid:e.get("jid")}).c("nick").t(e.get("nick")).up().up()}),t.up().up().up(),t.c("publish-options").c("x",{xmlns:l.NS.XFORM,type:"submit"}).c("field",{var:"FORM_TYPE",type:"hidden"}).c("value").t("http://jabber.org/protocol/pubsub#publish-options").up().up().c("field",{var:"pubsub#persist_items"}).c("value").t("true").up().up().c("field",{var:"pubsub#access_model"}).c("value").t("whitelist"),e.connection.sendIQ(t,null,this.onBookmarkError.bind(this))},onBookmarkError:function(n){e.log("Error while trying to add bookmark","error"),e.log(n),this.reset(),this.fetchBookmarksFromServer(null),window.alert(t("Sorry, something went wrong while trying to save your bookmark."))},fetchBookmarksFromServer:function(t){var n=c({from:e.connection.jid,type:"get"}).c("pubsub",{xmlns:l.NS.PUBSUB}).c("items",{node:"storage:bookmarks"});e.connection.sendIQ(n,d.bind(this.onBookmarksReceived,this,t),d.bind(this.onBookmarksReceivedError,this,t))},markRoomAsBookmarked:function(t){var n=e.chatboxes.get(t.get("jid"));d.isUndefined(n)||n.save("bookmarked",!0)},markRoomAsUnbookmarked:function(t){var n=e.chatboxes.get(t.get("jid"));d.isUndefined(n)||n.save("bookmarked",!1)},onBookmarksReceived:function(e,t){var n=a(t).find('items[node="storage:bookmarks"] item[id="current"] storage conference'),i=this;if(d.forEach(n,function(e){i.create({jid:e.getAttribute("jid"),name:e.getAttribute("name"),autojoin:"true"===e.getAttribute("autojoin"),nick:e.querySelector("nick").textContent})}),!d.isUndefined(e))return e.resolve()},onBookmarksReceivedError:function(t,n){if(window.sessionStorage.setItem(this.cached_flag,!0),e.log("Error while fetching bookmarks"),e.log(n),!d.isUndefined(t))return t.reject()}}),e.BookmarksView=Backbone.View.extend({tagName:"div",className:"bookmarks-list",events:{"click .remove-bookmark":"removeBookmark","click .bookmarks-toggle":"toggleBookmarksList"},initialize:function(){this.model.on("add",this.renderBookmarkListElement,this),this.model.on("remove",this.removeBookmarkListElement,this);var t="converse.room-bookmarks"+e.bare_jid+"-list-model";this.list_model=new e.BookmarksList,this.list_model.id=t,this.list_model.browserStorage=new Backbone.BrowserStorage[e.storage](u(t)),this.list_model.fetch(),this.render()},render:function(){this.$el.html(r({toggle_state:this.list_model.get("toggle-state"),desc_bookmarks:t("Click to toggle the bookmarks list"),label_bookmarks:t("Bookmarked Rooms")})).hide(),this.list_model.get("toggle-state")!==e.OPENED&&this.$(".bookmarks").hide(),this.model.each(this.renderBookmarkListElement.bind(this));var n=e.chatboxviews.get("controlbox");return d.isUndefined(n)||this.$el.prependTo(n.$("#chatrooms")),this.$el},removeBookmark:function(i){i.preventDefault();var o=a(i.target).data("bookmarkName"),s=a(i.target).data("roomJid");confirm(t(n('Are you sure you want to remove the bookmark "%1$s"?'),o))&&d.invokeMap(e.bookmarks.where({jid:s}),Backbone.Model.prototype.destroy)},renderBookmarkListElement:function(e){var n=a(s({name:e.get("name"),jid:e.get("jid"),open_title:t("Click to open this room"),info_title:t("Show more information on this room"),info_remove:t("Remove this bookmark")}));this.$(".bookmarks").append(n),this.$el.is(":visible")||this.$el.show()},removeBookmarkListElement:function(e){this.$('[data-room-jid="'+e.get("jid")+'"]:first').parent().remove(),0===this.model.length&&this.$el.hide()},toggleBookmarksList:function(t){t&&t.preventDefault&&t.preventDefault();var n=a(t.target);n.hasClass("icon-opened")?(this.$(".bookmarks").slideUp("fast"),this.list_model.save({"toggle-state":e.CLOSED}),n.removeClass("icon-opened").addClass("icon-closed")):(n.removeClass("icon-closed").addClass("icon-opened"),this.$(".bookmarks").slideDown("fast"),this.list_model.save({"toggle-state":e.OPENED}))}});var i=function(){e.allow_bookmarks&&(e.bookmarks=new e.Bookmarks,e.bookmarks.fetchBookmarks().always(function(){e.bookmarksview=new e.BookmarksView({model:e.bookmarks})}))};e.on("chatBoxesFetched",i);var o=function(){e.allow_bookmarks&&(d.isUndefined(e.bookmarksview)?i():e.bookmarksview.render())};e.on("reconnected",o)}})}),function(e,t){define("converse-mam",["converse-core","converse-chatview","converse-muc","strophe.rsm"],t)}(this,function(e){"use strict";var t=e.env.jQuery,n=e.env.Strophe,i=e.env.$iq,o=e.env._,s=e.env.moment,r=["max","first","last","after","before","index","count"],a=["with","start","end"];n.addNamespace("MAM","urn:xmpp:mam:0"),n.addNamespace("RSM","http://jabber.org/protocol/rsm"),e.plugins.add("converse-mam",{overrides:{Features:{addClientFeatures:function(){var e=this.__super__._converse;return e.connection.disco.addFeature(n.NS.MAM),this.__super__.addClientFeatures.apply(this,arguments)}},ChatBox:{getMessageAttributes:function(e,i,o){var s=this.__super__.getMessageAttributes.apply(this,arguments);return s.archive_id=t(o).find('result[xmlns="'+n.NS.MAM+'"]').attr("id"),s}},ChatBoxView:{render:function(){var e=this.__super__.render.apply(this,arguments);return this.disable_mam||this.$content.on("scroll",o.debounce(this.onScroll.bind(this),100)),e},afterMessagesFetched:function(){var e=this.__super__._converse;return this.disable_mam||!e.features.findWhere({var:n.NS.MAM})?this.__super__.afterMessagesFetched.apply(this,arguments):(!this.model.get("mam_initialized")&&this.model.messages.length<e.archived_messages_page_size&&(this.fetchArchivedMessages({before:"",with:this.model.get("jid"),max:e.archived_messages_page_size}),this.model.save({mam_initialized:!0})),this.__super__.afterMessagesFetched.apply(this,arguments))},fetchArchivedMessages:function(e){var t=this.__super__._converse;return t.features.findWhere({var:n.NS.MAM})?void(this.disable_mam||(this.addSpinner(),t.queryForArchivedMessages(e,function(e){this.clearSpinner(),e.length&&o.each(e,t.chatboxes.onMessage.bind(t.chatboxes))}.bind(this),function(){this.clearSpinner(),t.log("Error or timeout while trying to fetch archived messages","error")}.bind(this)))):void t.log("Attempted to fetch archived messages but this user's server doesn't support XEP-0313")},onScroll:function(e){var n=this.__super__._converse;0===t(e.target).scrollTop()&&this.model.messages.length&&this.fetchArchivedMessages({before:this.model.messages.at(0).get("archive_id"),with:this.model.get("jid"),max:n.archived_messages_page_size})}},ChatRoomView:{render:function(){var e=this.__super__.render.apply(this,arguments);return this.disable_mam||this.$content.on("scroll",o.debounce(this.onScroll.bind(this),100)),e},handleMUCMessage:function(e){var i=t(e).find('[xmlns="'+n.NS.MAM+'"]').length>0;return!!i||this.__super__.handleMUCMessage.apply(this,arguments)},fetchArchivedMessages:function(e){var t=this,i=this.__super__._converse;return i.features.findWhere({var:n.NS.MAM})?void(this.model.get("mam_enabled")&&(this.addSpinner(),i.api.archive.query(o.extend(e,{groupchat:!0}),function(e){t.clearSpinner(),e.length&&o.each(e,t.onChatRoomMessage.bind(t))},function(){t.clearSpinner(),i.log("Error while trying to fetch archived messages","error")}))):void i.log("Attempted to fetch archived messages but this user's server doesn't support XEP-0313")}}},initialize:function(){var e=this._converse;this.updateSettings({archived_messages_page_size:"50",message_archiving:void 0,message_archiving_timeout:8e3}),e.queryForArchivedMessages=function(l,c,u){var d,h=[];o.isFunction(l)&&(c=l,u=c);var p=e.connection.getUniqueId(),_={type:"set"};if(!o.isUndefined(l)&&l.groupchat){if(!l.with)throw new Error('You need to specify a "with" value containing the chat room JID, when querying groupchat messages.');_.to=l.with}var m=i(_).c("query",{xmlns:n.NS.MAM,queryid:p});o.isUndefined(l)||(m.c("x",{xmlns:n.NS.XFORM,type:"submit"}).c("field",{var:"FORM_TYPE",type:"hidden"}).c("value").t(n.NS.MAM).up().up(),l.with&&!l.groupchat&&m.c("field",{var:"with"}).c("value").t(l.with).up().up(),o.each(["start","end"],function(e){if(l[e]){if(d=s(l[e]),!d.isValid())throw new TypeError("archive.query: invalid date provided for: "+e);m.c("field",{var:e}).c("value").t(d.format()).up().up()}}),m.up(),l instanceof n.RSM?m.cnode(l.toXML()):o.intersection(r,o.keys(l)).length&&m.cnode(new n.RSM(l).toXML())),o.isFunction(c)&&e.connection.addHandler(function(e){var i,s=t(e),r=s.find('fin[xmlns="'+n.NS.MAM+'"]');return r.length&&r.attr("queryid")===p?(i=new n.RSM({xml:r.find("set")[0]}),o.extend(i,o.pick(l,["max"])),o.extend(i,o.pick(l,a)),c(h,i),!1):(p===s.find("result").attr("queryid")&&h.push(e),!0)},n.NS.MAM),e.connection.sendIQ(m,null,u,e.message_archiving_timeout)},o.extend(e.api,{archive:{query:e.queryForArchivedMessages.bind(e)}}),e.onMAMError=function(n){t(n).find("feature-not-implemented").length?e.log("Message Archive Management (XEP-0313) not supported by this browser"):(e.log("An error occured while trying to set archiving preferences."),e.log(n))},e.onMAMPreferences=function(s,r){var a,l=t(r).find('prefs[xmlns="'+n.NS.MAM+'"]'),c=l.attr("default");c!==e.message_archiving?(a=i({type:"set"}).c("prefs",{xmlns:n.NS.MAM,default:e.message_archiving}),l.children().each(function(e,t){a.cnode(t).up()}),e.connection.sendIQ(a,o.partial(function(t,n){t.save({preferences:{default:e.message_archiving}})},s),e.onMAMError)):s.save({preferences:{default:e.message_archiving}})};var l=function(t){var s=t.get("preferences")||{};t.get("var")!==n.NS.MAM||s.default===e.message_archiving||o.isUndefined(e.message_archiving)||e.connection.sendIQ(i({type:"get"}).c("prefs",{xmlns:n.NS.MAM}),o.partial(e.onMAMPreferences,t),o.partial(e.onMAMError,t))};e.on("serviceDiscovered",l.bind(e.features))}})}),function(e,t){define("converse-vcard",["converse-core","strophe.vcard"],t)}(this,function(e){"use strict";var t=e.env.Strophe,n=e.env.jQuery,i=e.env._,o=e.env.moment;e.plugins.add("converse-vcard",{overrides:{Features:{addClientFeatures:function(){var e=this.__super__._converse;this.__super__.addClientFeatures.apply(this,arguments),e.use_vcards&&e.connection.disco.addFeature(t.NS.VCARD)}},RosterContacts:{createRequestingContact:function(e){var n=this.__super__._converse,o=t.getBareJidFromJid(e.getAttribute("from"));n.getVCard(o,i.partial(n.createRequestingContactFromVCard,e),function(t,i){n.log("Error while retrieving vcard for "+i),n.createRequestingContactFromVCard(e,t,i)})}}},initialize:function(){var e=this._converse;this.updateSettings({use_vcards:!0}),e.createRequestingContactFromVCard=function(i,s,r,a,l,c,u){var d=t.getBareJidFromJid(r),h=n(i).children('nick[xmlns="'+t.NS.NICK+'"]').text(),p={jid:d,subscription:"none",ask:null,requesting:!0,fullname:a||h||d,image:l,image_type:c,url:u,vcard_updated:o().format()};e.roster.create(p),e.emit("contactRequest",p)},e.onVCardError=function(t,n,i){var s=e.roster.get(t);s&&s.save({vcard_updated:o().format()}),i&&i(n,t)},e.onVCardData=function(t,s,r){var a=n(s).find("vCard"),l=a.find("FN").text(),c=a.find("BINVAL").text(),u=a.find("TYPE").text(),d=a.find("URL").text();if(t){var h=e.roster.get(t);h&&(l=i.isEmpty(l)?h.get("fullname")||t:l,h.save({fullname:l,image_type:u,image:c,url:d,vcard_updated:o().format()}))}r&&r(s,t,l,c,u,d)},e.getVCard=function(t,n,o){e.use_vcards?e.connection.vcard.get(i.partial(e.onVCardData,t,i,n),t,i.partial(e.onVCardError,t,i,o)):n&&n(null,t)};var s=function(t){if(e.use_vcards){var n=t.model.get("jid"),i=e.roster.get(n);i&&!i.get("vcard_updated")&&e.getVCard(n,function(e,n,i,o,s,r){t.model.save({fullname:i||n,url:r,image_type:s,image:o})},function(){e.log("updateVCardForChatBox: Error occured while fetching vcard")})}};e.on("chatBoxInitialized",s);var r=function(t){t.get("vcard_updated")||e.getVCard(t.get("jid"))};e.on("initialized",function(){e.roster.on("add",r)});var a=function(){void 0===e.xmppstatus.get("fullname")&&e.getVCard(null,function(t,n,i){e.xmppstatus.save({fullname:i
})})};e.on("statusInitialized",a)}})}),define("tpl!toolbar_otr",["lodash"],function(_){return function(obj){function print(){__p+=__j.call(arguments,"")}obj||(obj={});var __t,__p="",__e=_.escape,__j=Array.prototype.join;with(obj)allow_otr&&(__p+='\n    <li class="toggle-otr '+__e(otr_status_class)+'" title="'+__e(otr_tooltip)+'">\n        <span class="chat-toolbar-text">'+__e(otr_translated_status)+"</span>\n        ",otr_status==UNENCRYPTED&&(__p+='\n            <span class="icon-unlocked"></span>\n        '),__p+="\n        ",otr_status==UNVERIFIED&&(__p+='\n            <span class="icon-lock"></span>\n        '),__p+="\n        ",otr_status==VERIFIED&&(__p+='\n            <span class="icon-lock"></span>\n        '),__p+="\n        ",otr_status==FINISHED&&(__p+='\n            <span class="icon-unlocked"></span>\n        '),__p+="\n        <ul>\n            ",otr_status==UNENCRYPTED&&(__p+='\n               <li><a class="start-otr" href="#">'+__e(label_start_encrypted_conversation)+"</a></li>\n            "),__p+="\n            ",otr_status!=UNENCRYPTED&&(__p+='\n               <li><a class="start-otr" href="#">'+__e(label_refresh_encrypted_conversation)+'</a></li>\n               <li><a class="end-otr" href="#">'+__e(label_end_encrypted_conversation)+'</a></li>\n               <li><a class="auth-otr" data-scheme="smp" href="#">'+__e(label_verify_with_smp)+"</a></li>\n            "),__p+="\n            ",otr_status==UNVERIFIED&&(__p+='\n               <li><a class="auth-otr" data-scheme="fingerprint" href="#">'+__e(label_verify_with_fingerprints)+"</a></li>\n            "),__p+='\n            <li><a href="http://www.cypherpunks.ca/otr/help/3.2.0/levels.php" target="_blank" rel="noopener">'+__e(label_whats_this)+"</a></li>\n        </ul>\n    </li>\n"),__p+="\n";return __p}}),function(e,t){define("converse-otr",["converse-chatview","tpl!toolbar_otr","otr"],t)}(this,function(e,t,n){"use strict";var i=e.env.Strophe,o=e.env.utils,s=(e.env.b64_sha1,e.env.jQuery),r=e.env._,a=!r.isUndefined(crypto)&&(r.isFunction(crypto.randomBytes)||r.isFunction(crypto.getRandomValues)),l=a&&!r.isUndefined(n.OTR)&&!r.isUndefined(n.DSA),c=0,u=1,d=2,h=3,p={},_={};_[c]="unencrypted",_[u]="unverified",_[d]="verified",_[h]="finished",e.plugins.add("converse-otr",{overrides:{registerGlobalEventHandlers:function(){this.__super__.registerGlobalEventHandlers(),s(document).click(function(){s(".toggle-otr ul").is(":visible")&&s(".toggle-otr ul",this).slideUp(),s(".toggle-smiley ul").is(":visible")&&s(".toggle-smiley ul",this).slideUp()})},ChatBox:{initialize:function(){this.__super__.initialize.apply(this,arguments),"controlbox"!==this.get("box_id")&&this.save({otr_status:this.get("otr_status")||c})},shouldPlayNotification:function(e){return this.__super__.shouldPlayNotification.apply(this,arguments)&&!(o.isOTRMessage(e[0])&&!r.includes([u,d],this.get("otr_status")))},createMessage:function(e,t,n){var i=this.__super__._converse,o=r.propertyOf(e.querySelector("body"))("textContent");if(!o||!i.allow_otr)return this.__super__.createMessage.apply(this,arguments);if(o.match(/^\?OTRv23?/))this.initiateOTR(o);else if(r.includes([u,d],this.get("otr_status")))this.otr.receiveMsg(o);else{if(!o.match(/^\?OTR/))return this.__super__.createMessage.apply(this,arguments);this.otr?this.otr.receiveMsg(o):this.initiateOTR(o)}},generatePrivateKey:function(e){var t=this.__super__._converse,i=new n.DSA;t.connection.jid;return t.cache_otr_key&&this.save({otr_priv_key:i.packPrivate(),otr_instance_tag:e}),i},getSession:function(e){var t,i,o=this.__super__._converse,s=o.__;if(o.cache_otr_key&&(t=this.get("otr_instance_tag"),i=n.DSA.parsePrivate(this.get("otr_priv_key")),i&&t))return this.trigger("showHelpMessages",[s("Re-establishing encrypted session")]),void e({key:i,instance_tag:t});this.trigger("showHelpMessages",[s("Generating private key."),s("Your browser might become unresponsive.")],null,!0);var r=this;window.setTimeout(function(){var t=n.OTR.makeInstanceTag();e({key:r.generatePrivateKey(t),instance_tag:t})},500)},updateOTRStatus:function(e){switch(e){case n.OTR.CONST.STATUS_AKE_SUCCESS:this.otr.msgstate===n.OTR.CONST.MSGSTATE_ENCRYPTED&&this.save({otr_status:u});break;case n.OTR.CONST.STATUS_END_OTR:this.otr.msgstate===n.OTR.CONST.MSGSTATE_FINISHED?this.save({otr_status:h}):this.otr.msgstate===n.OTR.CONST.MSGSTATE_PLAINTEXT&&this.save({otr_status:c})}},onSMP:function(e,t){var n=this.__super__._converse,i=n.__;switch(e){case"question":this.otr.smpSecret(prompt(i("Authentication request from %1$s\n\nYour chat contact is attempting to verify your identity, by asking you the question below.\n\n%2$s",[this.get("fullname"),t])));break;case"trust":t===!0?this.save({otr_status:d}):(this.trigger("showHelpMessages",[i("Could not verify this user's identify.")],"error"),this.save({otr_status:u}));break;default:throw new TypeError("ChatBox.onSMP: Unknown type for SMP")}},initiateOTR:function(e){var t=this.__super__._converse,i=t.__;this.save({otr_status:c}),this.getSession(function(t){var o=this.__super__._converse;this.otr=new n.OTR({fragment_size:140,send_interval:200,priv:t.key,instance_tag:t.instance_tag,debug:this.debug}),this.otr.on("status",this.updateOTRStatus.bind(this)),this.otr.on("smp",this.onSMP.bind(this)),this.otr.on("ui",function(e){this.trigger("showReceivedOTRMessage",e)}.bind(this)),this.otr.on("io",function(e){this.trigger("sendMessage",new o.Message({message:e}))}.bind(this)),this.otr.on("error",function(e){this.trigger("showOTRError",e)}.bind(this)),this.trigger("showHelpMessages",[i("Exchanging private key with contact.")]),e?this.otr.receiveMsg(e):this.otr.sendQueryMsg()}.bind(this))},endOTR:function(){this.otr&&this.otr.endOtr(),this.save({otr_status:c})}},ChatBoxView:{events:{"click .toggle-otr":"toggleOTRMenu","click .start-otr":"startOTRFromToolbar","click .end-otr":"endOTR","click .auth-otr":"authOTR"},initialize:function(){var e=this.__super__._converse;this.__super__.initialize.apply(this,arguments),this.model.on("change:otr_status",this.onOTRStatusChanged,this),this.model.on("showOTRError",this.showOTRError,this),this.model.on("showSentOTRMessage",function(e){this.showMessage({message:e,sender:"me"})},this),this.model.on("showReceivedOTRMessage",function(e){this.showMessage({message:e,sender:"them"})},this),(r.includes([u,d],this.model.get("otr_status"))||e.use_otr_by_default)&&this.model.initiateOTR()},createMessageStanza:function(){var e=this.__super__.createMessageStanza.apply(this,arguments);return(this.model.get("otr_status")!==c||o.isOTRMessage(e.nodeTree))&&e.c("private",{xmlns:i.NS.CARBONS}).up().c("no-store",{xmlns:i.NS.HINTS}).up().c("no-permanent-store",{xmlns:i.NS.HINTS}).up().c("no-copy",{xmlns:i.NS.HINTS}),e},onMessageSubmitted:function(e){var t=this.__super__._converse;if(!t.connection.authenticated)return this.showHelpMessages(["Sorry, the connection has been lost, and your message could not be sent"],"error");var n=e.replace(/^\s*/,"").match(/^\/(.*)\s*$/);if(n){if(t.allow_otr&&"endotr"===n[1])return this.endOTR();if(t.allow_otr&&"otr"===n[1])return this.model.initiateOTR()}r.includes([u,d],this.model.get("otr_status"))?(this.model.otr.sendMsg(e),this.model.trigger("showSentOTRMessage",e)):this.__super__.onMessageSubmitted.apply(this,arguments)},onOTRStatusChanged:function(){this.renderToolbar().informOTRChange()},informOTRChange:function(){var e=this.__super__._converse,t=e.__,n=this.model.toJSON(),i=[];return n.otr_status===c?i.push(t("Your messages are not encrypted anymore")):n.otr_status===u?i.push(t("Your messages are now encrypted but your contact's identity has not been verified.")):n.otr_status===d?i.push(t("Your contact's identify has been verified.")):n.otr_status===h&&i.push(t("Your contact has ended encryption on their end, you should do the same.")),this.showHelpMessages(i,"info",!1)},showOTRError:function(e){var t=this.__super__._converse,n=t.__;"Message cannot be sent at this time."===e?this.showHelpMessages([n("Your message could not be sent")],"error"):"Received an unencrypted message."===e?this.showHelpMessages([n("We received an unencrypted message")],"error"):"Received an unreadable encrypted message."===e?this.showHelpMessages([n("We received an unreadable encrypted message")],"error"):this.showHelpMessages(["Encryption error occured: "+e],"error"),t.log("OTR ERROR:"+e)},startOTRFromToolbar:function(e){s(e.target).parent().parent().slideUp(),e.stopPropagation(),this.model.initiateOTR()},endOTR:function(e){r.isUndefined(e)||(e.preventDefault(),e.stopPropagation()),this.model.endOTR()},authOTR:function(e){var t,n,i,o=this.__super__._converse,r=o.__,a=s(e.target).data().scheme;"fingerprint"===a?(t=confirm(r("Here are the fingerprints, please confirm them with %1$s, outside of this chat.\n\nFingerprint for you, %2$s: %3$s\n\nFingerprint for %1$s: %4$s\n\nIf you have confirmed that the fingerprints match, click OK, otherwise click Cancel.",[this.model.get("fullname"),o.xmppstatus.get("fullname")||o.bare_jid,this.model.otr.priv.fingerprint(),this.model.otr.their_priv_pk.fingerprint()])),t===!0?this.model.save({otr_status:d}):this.model.save({otr_status:u})):"smp"===a?(alert(r("You will be prompted to provide a security question and then an answer to that question.\n\nYour contact will then be prompted the same question and if they type the exact same answer (case sensitive), their identity will be verified.")),n=prompt(r("What is your security question?")),n&&(i=prompt(r("What is the answer to the security question?")),this.model.otr.smpSecret(i,n))):this.showHelpMessages([r("Invalid authentication scheme provided")],"error")},toggleOTRMenu:function(e){e.stopPropagation(),this.$el.find(".toggle-otr ul").slideToggle(200)},getOTRTooltip:function(){var e=this.__super__._converse,t=e.__,n=this.model.toJSON();return n.otr_status===c?t("Your messages are not encrypted. Click here to enable OTR encryption."):n.otr_status===u?t("Your messages are encrypted, but your contact has not been verified."):n.otr_status===d?t("Your messages are encrypted and your contact verified."):n.otr_status===h?t("Your contact has closed their end of the private session, you should do the same"):void 0},renderToolbar:function(e,n){var i=this.__super__._converse,o=i.__;if(i.show_toolbar){var s=this.model.toJSON();return n=r.extend(n||{},{FINISHED:h,UNENCRYPTED:c,UNVERIFIED:u,VERIFIED:d,allow_otr:i.allow_otr&&!this.is_chatroom,label_end_encrypted_conversation:o("End encrypted conversation"),label_refresh_encrypted_conversation:o("Refresh encrypted conversation"),label_start_encrypted_conversation:o("Start encrypted conversation"),label_verify_with_fingerprints:o("Verify with fingerprints"),label_verify_with_smp:o("Verify with SMP"),label_whats_this:o("What's this?"),otr_status_class:_[s.otr_status],otr_tooltip:this.getOTRTooltip(),otr_translated_status:p[s.otr_status]}),this.__super__.renderToolbar.apply(this,arguments),this.$el.find(".chat-toolbar").append(t(r.extend(this.model.toJSON(),n||{}))),this}}}},initialize:function(){var e=this._converse,t=e.__;this.updateSettings({allow_otr:!0,cache_otr_key:!1,use_otr_by_default:!1}),p[c]=t("unencrypted"),p[u]=t("unverified"),p[d]=t("verified"),p[h]=t("finished"),e.allow_otr=e.allow_otr&&l,e.use_otr_by_default=e.use_otr_by_default&&e.allow_otr}})}),define("tpl!register_panel",["lodash"],function(_){return function(obj){function print(){__p+=__j.call(arguments,"")}obj||(obj={});var __t,__p="",__e=_.escape,__j=Array.prototype.join;with(obj)__p+='<form id="converse-register" class="pure-form converse-form">\n    <span class="reg-feedback"></span>\n    <label>'+__e(label_domain)+"</label>\n    ",default_domain&&(__p+="\n    \t"+__e(default_domain)+"\n    "),__p+="\n    ",default_domain||(__p+='\n    \t<input type="text" name="domain" placeholder="'+__e(domain_placeholder)+'">\n        <p class="form-help">'+__e(help_providers)+' <a href="'+__e(href_providers)+'" class="url" target="_blank" rel="noopener">'+__e(help_providers_link)+'</a>.</p>\n        <input class="pure-button button-primary" type="submit" value="'+__e(label_register)+'">\n    '),__p+="\n</form>\n";return __p}}),define("tpl!register_tab",["lodash"],function(_){return function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj)__p+='<li><a class="s" data-id="register" href="#register">'+__e(label_register)+"</a></li>\n";return __p}}),define("tpl!registration_form",["lodash"],function(_){return function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj)__p+='<p class="provider-title">'+__e(domain)+"</p>\n<a href='https://xmpp.net/result.php?domain="+__e(domain)+"&amp;type=client'>\n    <img class=\"provider-score\" src='https://xmpp.net/badge.php?domain="+__e(domain)+"' alt='xmpp.net score' />\n</a>\n<p class=\"title\">"+__e(title)+'</p>\n<p class="instructions">'+__e(instructions)+"</p>\n";return __p}}),define("tpl!registration_request",["lodash"],function(_){return function(obj){function print(){__p+=__j.call(arguments,"")}obj||(obj={});var __t,__p="",__e=_.escape,__j=Array.prototype.join;with(obj)__p+='<span class="spinner login-submit"></span>\n<p class="info">'+__e(info_message)+"</p>\n",cancel&&(__p+='\n\t<button class="pure-button button-cancel hor_centered">'+__e(cancel)+"</button>\n"),__p+="\n";return __p}}),function(e,t){define("converse-register",["converse-core","tpl!form_username","tpl!register_panel","tpl!register_tab","tpl!registration_form","tpl!registration_request","converse-controlbox"],t)}(this,function(e,t,n,i,o,s){"use strict";var r=e.env.Strophe,a=e.env.utils,l=e.env.$iq,c=e.env.jQuery,u=e.env._;r.addNamespace("REGISTER","jabber:iq:register");var d=0;u.each(u.keys(r.Status),function(e){d=Math.max(d,r.Status[e])}),r.Status.REGIFAIL=d+1,r.Status.REGISTERED=d+2,r.Status.CONFLICT=d+3,r.Status.NOTACCEPTABLE=d+5,e.plugins.add("converse-register",{overrides:{ControlBoxView:{switchTab:function(e){var t=this.__super__._converse,n=this.__super__.switchTab.apply(this,arguments);return t.registration_domain&&"register"===e.target.getAttribute("data-id")&&!this.model.get("registration_form_rendered")&&this.registerpanel.fetchRegistrationForm(t.registration_domain),n},renderLoginPanel:function(){this.__super__.renderLoginPanel.apply(this,arguments);var e=this.__super__._converse;return e.allow_registration&&(this.registerpanel=new e.RegisterPanel({$parent:this.$el.find(".controlbox-panes"),model:this.model}),this.registerpanel.render().$el.addClass("hidden")),this}}},initialize:function(){var e=this._converse,d=e.__;e.templates.form_username=t,e.templates.register_panel=n,e.templates.register_tab=i,e.templates.registration_form=o,e.templates.registration_request=s,this.updateSettings({allow_registration:!0,domain_placeholder:d(" e.g. conversejs.org"),providers_link:"https://xmpp.net/directory.php"}),e.RegisterPanel=Backbone.View.extend({tagName:"div",id:"register",className:"controlbox-pane",events:{"submit form#converse-register":"onProviderChosen"},initialize:function(e){this.reset(),this.$parent=e.$parent,this.$tabs=e.$parent.parent().find("#controlbox-tabs"),this.registerHooks()},render:function(){return this.model.set("registration_form_rendered",!1),this.$parent.append(this.$el.html(n({default_domain:e.registration_domain,label_domain:d("Your XMPP provider's domain name:"),label_register:d("Fetch registration form"),help_providers:d("Tip: A list of public XMPP providers is available"),help_providers_link:d("here"),href_providers:e.providers_link,domain_placeholder:e.domain_placeholder}))),this.$tabs.append(i({label_register:d("Register")})),this},registerHooks:function(){var t=e.connection,n=t._connect_cb.bind(t);t._connect_cb=function(e,t,i){this._registering?this.getRegistrationFields(e,t,i)&&(this._registering=!1):n(e,t,i)}.bind(this)},getRegistrationFields:function(t,n,i){var o=e.connection;o.connected=!0;var s=o._proto._reqToData(t);if(s){if(o._proto._connect_cb(s)===r.Status.CONNFAIL)return!1;var a=s.getElementsByTagName("register"),c=s.getElementsByTagName("mechanism");return 0===a.length&&0===c.length?(o._proto._no_auth_received(n),!1):0===a.length?(o._changeConnectStatus(r.Status.REGIFAIL,d("Sorry, the given provider does not support in band account registration. Please try with a different provider.")),!0):(o._addSysHandler(this.onRegistrationFields.bind(this),null,"iq",null,null),o.send(l({type:"get"}).c("query",{xmlns:r.NS.REGISTER}).tree()),o.connected=!1,!0)}},onRegistrationFields:function(t){return 1!==t.getElementsByTagName("query").length?(e.connection._changeConnectStatus(r.Status.REGIFAIL,"unknown"),!1):(this.setFields(t),this.renderRegistrationForm(t),!1)},reset:function(e){var t={fields:{},urls:[],title:"",instructions:"",registered:!1,_registering:!1,domain:null,form_type:null};u.extend(this,t),e&&u.extend(this,u.pick(e,u.keys(t)))},onProviderChosen:function(e){e&&e.preventDefault&&e.preventDefault();var t=c(e.target),n=t.find("input[name=domain]"),i=n.val();return i?(t.find("input[type=submit]").hide(),void this.fetchRegistrationForm(i,d("Cancel"))):void n.addClass("error")},fetchRegistrationForm:function(t,n){return this.renderRegistrationRequest(n),this.reset({domain:r.getDomainFromJid(t),_registering:!0}),e.connection.connect(this.domain,"",this.onRegistering.bind(this)),!1},renderRegistrationRequest:function(t){var n=this.el.querySelector("#converse-register");if(a.createElementsFromString(n,s({cancel:t,info_message:e.__("Requesting a registration form from the XMPP server")})),!e.registration_domain){var i=document.querySelector("button.button-cancel");i.addEventListener("click",this.cancelRegistration.bind(this))}},giveFeedback:function(e,t){this.$(".reg-feedback").attr("class","reg-feedback").text(e),t&&c(".reg-feedback").addClass(t)},onRegistering:function(t,n){var i;e.log("onRegistering"),u.includes([r.Status.DISCONNECTED,r.Status.CONNFAIL,r.Status.REGIFAIL,r.Status.NOTACCEPTABLE,r.Status.CONFLICT],t)?(e.log("Problem during registration: Strophe.Status is: "+t),this.cancelRegistration(),n?this.giveFeedback(n,"error"):this.giveFeedback(d('Something went wrong while establishing a connection with "%1$s". Are you sure it exists?',this.domain),"error")):t===r.Status.REGISTERED&&(e.log("Registered successfully."),e.connection.reset(),i=this,this.$("form").hide(function(){c(this).replaceWith('<span class="spinner centered"/>'),i.fields.password&&i.fields.username?(e.connection.connect(i.fields.username.toLowerCase()+"@"+i.domain.toLowerCase(),i.fields.password,e.onConnectStatusChanged),e.chatboxviews.get("controlbox").switchTab({target:i.$tabs.find(".current")}),e.giveFeedback(d("Now logging you in"))):(e.chatboxviews.get("controlbox").renderLoginPanel(),e.giveFeedback(d("Registered successfully"))),i.reset()}))},renderRegistrationForm:function(n){this.model.set("registration_form_rendered",!0);var i,s,r=this.$("form"),l=c(n);r.empty().append(o({domain:this.domain,title:this.title,instructions:this.instructions})),"xform"===this.form_type?(i=l.find("field"),u.each(i,function(e){r.append(a.xForm2webForm.bind(this,c(e),l))}.bind(this))):(u.each(u.keys(this.fields),function(e){"username"===e?s=t({domain:" @"+this.domain,name:e,type:"text",label:e,value:"",required:1}):(r.append("<label>"+e+"</label>"),s=c('<input placeholder="'+e+'" name="'+e+'"></input>'),"password"!==e&&"email"!==e||s.attr("type",e)),r.append(s)}.bind(this)),u.each(this.urls,function(e){r.append(c('<a target="blank"></a>').attr("href",e).text(e))}.bind(this))),this.fields?(r.append('<input type="submit" class="pure-button button-primary" value="'+d("Register")+'"/>'),r.on("submit",this.submitRegistrationForm.bind(this)),r.append('<input type="button" class="pure-button button-cancel" value="'+d("Cancel")+'"/>'),r.find("input[type=button]").on("click",this.cancelRegistration.bind(this))):(r.append('<input type="button" class="submit" value="'+d("Return")+'"/>'),r.find("input[type=button]").on("click",this.cancelRegistration.bind(this))),e.registration_domain&&r.find("input[type=button]").hide()},reportErrors:function(e){var t,n=this.$("form"),i=c(e).find("error text"),o=n.find(".form-errors");o.length?o.empty():(t='<legend class="form-errors"></legend>',n.find("p.instructions").length?n.find("p.instructions").append(t):n.prepend(t),o=n.find(".form-errors")),i.each(function(e,t){o.append(c("<p>").text(c(t).text()))}),i.length||o.append(c("<p>").text(d("The provider rejected your registration attempt. Please check the values you entered for correctness."))),o.show()},cancelRegistration:function(t){t&&t.preventDefault&&t.preventDefault(),e.connection.reset(),this.model.set("registration_form_rendered",!1),this.render(),e.registration_domain&&(document.querySelector("button.button-cancel").onclick=u.bind(this.fetchRegistrationForm,this,e.registration_domain,d("Retry")))},submitRegistrationForm:function(t){t&&t.preventDefault&&t.preventDefault();var n=u.reduce(this.el.querySelectorAll("input.required"),function(e,t){return""===t.value?(t.classList.add("error"),e+1):e},0);if(!n){var i=c(t.target).find(":input:not([type=button]):not([type=submit])"),o=l({type:"set"}).c("query",{xmlns:r.NS.REGISTER});"xform"===this.form_type?(o.c("x",{xmlns:r.NS.XFORM,type:"submit"}),i.each(function(){o.cnode(a.webForm2xForm(this)).up()})):i.each(function(){var e=c(this);o.c(e.attr("name"),{},e.val())}),this.model.set("registration_form_rendered",!1),e.connection._addSysHandler(this._onRegisterIQ.bind(this),null,"iq",null,null),e.connection.send(o),this.setFields(o.tree())}},setFields:function(e){var t,n=c(e).find("query");n.length>0&&(t=n.find('x[xmlns="'+r.NS.XFORM+'"]'),t.length>0?this._setFieldsFromXForm(t):this._setFieldsFromLegacy(n))},_setFieldsFromLegacy:function(e){e.children().each(function(e,t){var n=c(t);return"instructions"===t.tagName.toLowerCase()?void(this.instructions=r.getText(t)):"x"===t.tagName.toLowerCase()?void("jabber:x:oob"===n.attr("xmlns")&&n.find("url").each(function(e,t){this.urls.push(c(t).text())}.bind(this))):void(this.fields[t.tagName.toLowerCase()]=r.getText(t))}.bind(this)),this.form_type="legacy"},_setFieldsFromXForm:function(t){this.title=t.find("title").text(),this.instructions=t.find("instructions").text(),t.find("field").each(function(t,n){var i=n.getAttribute("var");i?this.fields[i.toLowerCase()]=c(n).children("value").text():e.log("WARNING: Found field we couldn't parse")}.bind(this)),this.form_type="xform"},_onRegisterIQ:function(t){var n=null,i=t.getElementsByTagName("query");if(i.length>0&&(i=i[0]),"error"===t.getAttribute("type")){if(e.log("Registration failed."),n=t.getElementsByTagName("error"),1!==n.length)return e.connection._changeConnectStatus(r.Status.REGIFAIL,"unknown"),!1;n=n[0].firstChild.tagName.toLowerCase(),"conflict"===n?e.connection._changeConnectStatus(r.Status.CONFLICT,n):"not-acceptable"===n?e.connection._changeConnectStatus(r.Status.NOTACCEPTABLE,n):e.connection._changeConnectStatus(r.Status.REGIFAIL,n),this.reportErrors(t)}else e.connection._changeConnectStatus(r.Status.REGISTERED,null);return!1},remove:function(){this.$tabs.empty(),this.$el.parent().empty()}})}})}),function(e,t){define("converse-ping",["converse-core","strophe.ping"],t)}(this,function(e){"use strict";var t=e.env.Strophe,n=e.env._;e.plugins.add("converse-ping",{initialize:function(){var e=this._converse;this.updateSettings({ping_interval:180}),e.ping=function(i,o,s,r){return e.lastStanzaDate=new Date,n.isNil(i)&&(i=t.getDomainFromJid(e.bare_jid)),n.isUndefined(r)&&(r=null),n.isUndefined(o)&&(o=null),n.isUndefined(s)&&(s=null),!!e.connection&&(e.connection.ping.ping(i,o,s,r),!0)},e.pong=function(t){return e.lastStanzaDate=new Date,e.connection.ping.pong(t),!0},e.registerPongHandler=function(){e.connection.disco.addFeature(t.NS.PING),e.connection.ping.addPingHandler(e.pong)},e.registerPingHandler=function(){e.registerPongHandler(),e.ping_interval>0&&(e.connection.addHandler(function(){return e.lastStanzaDate=new Date,!0}),e.connection.addTimedHandler(1e3,function(){var t=new Date;return e.lastStanzaDate||(e.lastStanzaDate=t),!((t-e.lastStanzaDate)/1e3>e.ping_interval)||e.ping()}))};var i=function(){e.registerPingHandler()};e.on("connected",i),e.on("reconnected",i)}})}),function(e,t){define("converse-notification",["converse-core"],t)}(this,function(e){"use strict";var t=e.env.utils,n=e.env.Strophe,i=e.env._;e.plugins.add("converse-notification",{initialize:function(){var o=this._converse,s=o.__,r=o.___;o.supports_html5_notification="Notification"in window,this.updateSettings({notify_all_room_messages:!1,show_desktop_notifications:!0,show_chatstate_notifications:!1,chatstate_notification_blacklist:[],play_sounds:!0,sounds_path:"/sounds/",notification_icon:"/logo/conversejs128.png"}),o.isOnlyChatStateNotification=function(e){return i.isNull(e.querySelector("body"))&&(i.isNull(e.querySelector(o.ACTIVE))||i.isNull(e.querySelector(o.COMPOSING))||i.isNull(e.querySelector(o.INACTIVE))||i.isNull(e.querySelector(o.PAUSED))||i.isNull(e.querySelector(o.GONE)))},o.shouldNotifyOfGroupMessage=function(e){var t=o.notify_all_room_messages,s=e.getAttribute("from"),r=n.getResourceFromJid(s),a=n.getBareJidFromJid(s),l=r&&n.unescapeNode(r)||"";if(""===l||e.querySelectorAll("delay").length>0)return!1;var c=o.chatboxes.get(a),u=e.querySelector("body");if(i.isNull(u))return!1;var d=new RegExp("\\b"+c.get("nick")+"\\b").test(u.textContent);return t=t===!0||i.isArray(t)&&i.includes(t,a),!(l===c.get("nick")||!t&&!d)},o.shouldNotifyOfMessage=function(e){if(t.isOTRMessage(e))return!1;var s=e.querySelector("forwarded");if(!i.isNull(s))return!1;if("groupchat"===e.getAttribute("type"))return o.shouldNotifyOfGroupMessage(e);if(t.isHeadlineMessage(e))return!0;var r=n.getBareJidFromJid(e.getAttribute("from"))===o.bare_jid;return!o.isOnlyChatStateNotification(e)&&!r},o.playSoundNotification=function(){var e;o.play_sounds&&!i.isUndefined(window.Audio)&&(e=new Audio(o.sounds_path+"msg_received.ogg"),e.canPlayType("/audio/ogg")?e.play():(e=new Audio(o.sounds_path+"msg_received.mp3"),e.play()))},o.areDesktopNotificationsEnabled=function(e){var t=o.supports_html5_notification&&o.show_desktop_notifications&&"granted"===Notification.permission;return e?t:t&&"hidden"===o.windowState},o.showMessageNotification=function(t){var a,l,c=n.getBareJidFromJid(t.getAttribute("from"));if("headline"===t.getAttribute("type")){if(i.includes(c,"@")&&!o.allow_non_roster_messaging)return;a=s(r("Notification from %1$s"),c)}else if(i.includes(c,"@"))if("groupchat"===t.getAttribute("type"))a=s(r("%1$s says"),n.getResourceFromJid(c));else{if(i.isUndefined(o.roster))return void o.log("Could not send notification, because roster is undefined","error");if(l=o.roster.get(c),i.isUndefined(l)){if(!o.allow_non_roster_messaging)return;a=s(r("%1$s says"),c)}else a=s(r("%1$s says"),l.get("fullname"))}else a=s(r("Notification from %1$s"),c);var u=new Notification(a,{body:t.querySelector("body").textContent,lang:i.isEmpty(e.i18n)?"en":o.i18n.locale_data.converse[""].lang,icon:o.notification_icon});setTimeout(u.close.bind(u),5e3)},o.showChatStateNotification=function(e){if(!i.includes(o.chatstate_notification_blacklist,e.jid)){var t=e.chat_status,n=null;if("offline"===t?n=s("has gone offline"):"away"===t?n=s("has gone away"):"dnd"===t?n=s("is busy"):"online"===t&&(n=s("has come online")),null!==n){var r=new Notification(e.fullname,{body:n,lang:o.i18n.locale_data.converse[""].lang,icon:o.notification_icon});setTimeout(r.close.bind(r),5e3)}}},o.showContactRequestNotification=function(e){var t=new Notification(e.fullname,{body:s("wants to be your contact"),lang:o.i18n.locale_data.converse[""].lang,icon:o.notification_icon});setTimeout(t.close.bind(t),5e3)},o.showFeedbackNotification=function(e){if("error"===e.klass||"warn"===e.klass){var t=new Notification(e.subject,{body:e.message,lang:o.i18n.locale_data.converse[""].lang,icon:o.notification_icon});setTimeout(t.close.bind(t),5e3)}},o.handleChatStateNotification=function(e){o.areDesktopNotificationsEnabled()&&o.show_chatstate_notifications&&o.showChatStateNotification(e)},o.handleMessageNotification=function(e){return!!o.shouldNotifyOfMessage(e)&&(o.playSoundNotification(),void(o.areDesktopNotificationsEnabled()&&o.showMessageNotification(e)))},o.handleContactRequestNotification=function(e){o.areDesktopNotificationsEnabled(!0)&&o.showContactRequestNotification(e)},o.handleFeedback=function(e){o.areDesktopNotificationsEnabled(!0)&&o.showFeedbackNotification(e)},o.requestPermission=function(){o.supports_html5_notification&&!i.includes(["denied","granted"],Notification.permission)&&Notification.requestPermission()},o.on("pluginsInitialized",function(){o.on("contactRequest",o.handleContactRequestNotification),o.on("contactStatusChanged",o.handleChatStateNotification),o.on("message",o.handleMessageNotification),o.on("feedback",o.handleFeedback),o.on("connected",o.requestPermission)})}})}),define("tpl!chatbox_minimize",["lodash"],function(_){return function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj)__p+='<a class="chatbox-btn toggle-chatbox-button icon-minus" title="'+__e(info_minimize)+'"></a>\n';return __p}}),define("tpl!toggle_chats",["lodash"],function(_){return function(obj){function print(){__p+=__j.call(arguments,"")}obj||(obj={});var __t,__p="",__e=_.escape,__j=Array.prototype.join;with(obj)__p+=__e(Minimized)+' <span id="minimized-count">('+__e(num_minimized)+')</span>\n<span class="unread-message-count"\n    ',num_unread||(__p+=' style="display: none" '),__p+='\n    href="#">'+__e(num_unread)+"</span>\n";return __p}}),define("tpl!trimmed_chat",["lodash"],function(_){return function(obj){function print(){__p+=__j.call(arguments,"")}obj||(obj={});var __t,__p="",__e=_.escape,__j=Array.prototype.join;with(obj)__p+='<a class="chatbox-btn close-chatbox-button icon-close"></a>\n<a class="chat-head-message-count" \n    ',num_unread||(__p+=' style="display: none" '),__p+='\n    href="#">'+__e(num_unread)+'</a>\n<a href="#" class="restore-chat" title="'+__e(tooltip)+'">\n    '+__e(title)+"\n</a>\n";return __p}}),define("tpl!chats_panel",["lodash"],function(_){return function(obj){obj||(obj={});var __t,__p="";with(obj)__p+='<a id="toggle-minimized-chats" href="#"></a>\n<div class="flyout minimized-chats-flyout"></div>\n';return __p}}),function(e,t){define("converse-minimize",["converse-core","tpl!chatbox_minimize","tpl!toggle_chats","tpl!trimmed_chat","tpl!chats_panel","converse-controlbox","converse-chatview","converse-muc"],t)}(this,function(e,t,n,i,o){"use strict";var s=e.env.jQuery,r=e.env._,a=e.env.b64_sha1,l=e.env.moment;e.plugins.add("converse-minimize",{overrides:{initChatBoxes:function(){var e=this.__super__._converse,t=this.__super__.initChatBoxes.apply(this,arguments);return e.minimized_chats=new e.MinimizedChats({model:e.chatboxes}),t},registerGlobalEventHandlers:function(){var e=this.__super__._converse;return s(window).on("resize",r.debounce(function(t){e.connection.connected&&e.chatboxviews.trimChats()},200)),this.__super__.registerGlobalEventHandlers.apply(this,arguments)},ChatBox:{initialize:function(){this.__super__.initialize.apply(this,arguments),"controlbox"!==this.get("id")&&this.save({minimized:this.get("minimized")||!1,time_minimized:this.get("time_minimized")||l()})},maximize:function(){this.save({minimized:!1,time_opened:l().valueOf()})},minimize:function(){this.save({minimized:!0,time_minimized:l().format()})}},ChatBoxView:{events:{"click .toggle-chatbox-button":"minimize"},initialize:function(){return this.model.on("change:minimized",this.onMinimizedChanged,this),this.__super__.initialize.apply(this,arguments)},_show:function(){var e=this.__super__._converse;this.__super__._show.apply(this,arguments),this.model.get("minimized")||e.chatboxviews.trimChats(this)},shouldShowOnTextMessage:function(){return!this.model.get("minimized")&&this.__super__.shouldShowOnTextMessage.apply(this,arguments)},setChatBoxHeight:function(e){if(!this.model.get("minimized"))return this.__super__.setChatBoxHeight.apply(this,arguments)},setChatBoxWidth:function(e){if(!this.model.get("minimized"))return this.__super__.setChatBoxWidth.apply(this,arguments);
},onMinimizedChanged:function(e){e.get("minimized")?this.minimize():this.maximize()},maximize:function(){var e=this.__super__._converse;return this.$el.insertAfter(e.chatboxviews.get("controlbox").$el),this.show(),e.emit("chatBoxMaximized",this),this},minimize:function(e){var t=this.__super__._converse;e&&e.preventDefault&&e.preventDefault(),this.model.save({scroll:this.$content.scrollTop()}),this.setChatState(t.INACTIVE).model.minimize(),this.hide(),t.emit("chatBoxMinimized",this)}},ChatRoomView:{events:{"click .toggle-chatbox-button":"minimize"},initialize:function(){this.model.on("change:minimized",function(e){e.get("minimized")?this.hide():this.maximize()},this);var e=this.__super__.initialize.apply(this,arguments);return this.model.get("minimized")&&this.hide(),e},generateHeadingHTML:function(){var e=this.__super__._converse,n=e.__,i=this.__super__.generateHeadingHTML.apply(this,arguments),o=document.createElement("div");o.innerHTML=i;var s=t({info_minimize:n("Minimize this chat box")}),r=o.querySelector(".close-chatbox-button");return r.insertAdjacentHTML("afterend",s),o.innerHTML}},ChatBoxes:{chatBoxMayBeShown:function(e){return this.__super__.chatBoxMayBeShown.apply(this,arguments)&&!e.get("minimized")}},ChatBoxViews:{showChat:function(e){var t=this.__super__.showChat.apply(this,arguments),n=!!r.isUndefined(e.maximize)||e.maximize;return t.get("minimized")&&n&&t.maximize(),t},getChatBoxWidth:function(e){return!e.model.get("minimized")&&e.$el.is(":visible")?e.$el.outerWidth(!0):0},getShownChats:function(){return this.filter(function(e){return!e.model.get("minimized")&&!e.model.get("closed")&&e.$el.is(":visible")})},trimChats:function(e){var t=this.__super__._converse,n=this.getShownChats();if(!(t.no_trimming||n.length<=1)&&this.getChatBoxWidth(n[0])!==s("body").outerWidth(!0)){var i,o,a,l=t.minimized_chats.$el,c=r.includes(this.model.pluck("minimized"),!0)?l.outerWidth(!0):0,u=e?e.model.get("id"):null;o=r.reduce(this.xget(u),function(e,t){return e+this.getChatBoxWidth(t)}.bind(this),e?e.$el.outerWidth(!0):0),c+o>s("body").outerWidth(!0)&&(i=this.getOldestMaximizedChat([u]),i&&(a=this.get(i.get("id")),a&&a.hide(),i.minimize()))}},getOldestMaximizedChat:function(e){e.push("controlbox");for(var t=0,n=this.model.sort().at(t);r.includes(e,n.get("id"))||n.get("minimized")===!0;)if(t++,n=this.model.at(t),!n)return null;return n}}},initialize:function(){var e=this._converse,s=e.__;e.templates.chatbox_minimize=t,e.templates.toggle_chats=n,e.templates.trimmed_chat=i,e.templates.chats_panel=o,this.updateSettings({no_trimming:!1}),e.MinimizedChatBoxView=Backbone.View.extend({tagName:"div",className:"chat-head",events:{"click .close-chatbox-button":"close","click .restore-chat":"restore"},initialize:function(){this.model.messages.on("add",function(e){e.get("message")&&this.updateUnreadMessagesCounter()},this),this.model.on("change:minimized",this.clearUnreadMessagesCounter,this),this.model.on("showReceivedOTRMessage",this.updateUnreadMessagesCounter,this),this.model.on("showSentOTRMessage",this.updateUnreadMessagesCounter,this)},render:function(){var e=r.extend(this.model.toJSON(),{tooltip:s("Click to restore this chat")});return"chatroom"===this.model.get("type")?(e.title=this.model.get("name"),this.$el.addClass("chat-head-chatroom")):(e.title=this.model.get("fullname"),this.$el.addClass("chat-head-chatbox")),this.$el.html(i(e))},clearUnreadMessagesCounter:function(){this.model.set({num_unread:0}),this.render()},updateUnreadMessagesCounter:function(){this.model.set({num_unread:this.model.get("num_unread")+1}),this.render()},close:function(t){t&&t.preventDefault&&t.preventDefault(),this.remove();var n=e.chatboxviews.get(this.model.get("id"));return n?n.close():(this.model.destroy(),e.emit("chatBoxClosed",this)),this},restore:r.debounce(function(e){e&&e.preventDefault&&e.preventDefault(),this.model.messages.off("add",null,this),this.remove(),this.model.maximize()},200,{leading:!0})}),e.MinimizedChats=Backbone.Overview.extend({tagName:"div",id:"minimized-chats",className:"hidden",events:{"click #toggle-minimized-chats":"toggle"},initialize:function(){this.render(),this.initToggle(),this.model.on("add",this.onChanged,this),this.model.on("destroy",this.removeChat,this),this.model.on("change:minimized",this.onChanged,this),this.model.on("change:num_unread",this.updateUnreadMessagesCounter,this)},tearDown:function(){return this.model.off("add",this.onChanged),this.model.off("destroy",this.removeChat),this.model.off("change:minimized",this.onChanged),this.model.off("change:num_unread",this.updateUnreadMessagesCounter),this},initToggle:function(){this.toggleview=new e.MinimizedChatsToggleView({model:new e.MinimizedChatsToggle});var t=a("converse.minchatstoggle"+e.bare_jid);this.toggleview.model.id=t,this.toggleview.model.browserStorage=new Backbone.BrowserStorage[e.storage](t),this.toggleview.model.fetch()},render:function(){return this.el.parentElement||(this.el.innerHTML=o(),e.chatboxviews.el.appendChild(this.el)),0===this.keys().length?(this.el.classList.add("hidden"),e.chatboxviews.trimChats.bind(e.chatboxviews)):this.keys().length>0&&!this.$el.is(":visible")&&(this.el.classList.remove("hidden"),e.chatboxviews.trimChats()),this.$el},toggle:function(e){e&&e.preventDefault&&e.preventDefault(),this.toggleview.model.save({collapsed:!this.toggleview.model.get("collapsed")}),this.$(".minimized-chats-flyout").toggle()},onChanged:function(e){"controlbox"!==e.get("id")&&(e.get("minimized")?this.addChat(e):this.get(e.get("id"))&&this.removeChat(e))},addChat:function(t){var n=this.get(t.get("id"));if(!n||0===n.$el.parent().length){var i=new e.MinimizedChatBoxView({model:t});this.$(".minimized-chats-flyout").append(i.render()),this.add(t.get("id"),i),this.toggleview.model.set({num_minimized:this.keys().length}),this.render()}},removeChat:function(e){this.remove(e.get("id")),this.toggleview.model.set({num_minimized:this.keys().length}),this.render()},updateUnreadMessagesCounter:function(){var e,t=this.model.pluck("num_unread"),n=0;for(e=0;e<t.length;e++)n+=t[e];this.toggleview.model.set({num_unread:n}),this.render()}}),e.MinimizedChatsToggle=Backbone.Model.extend({initialize:function(){this.set({collapsed:this.get("collapsed")||!1,num_minimized:this.get("num_minimized")||0,num_unread:this.get("num_unread")||0})}}),e.MinimizedChatsToggleView=Backbone.View.extend({el:"#toggle-minimized-chats",initialize:function(){this.model.on("change:num_minimized",this.render,this),this.model.on("change:num_unread",this.render,this),this.$flyout=this.$el.siblings(".minimized-chats-flyout")},render:function(){return this.$el.html(n(r.extend(this.model.toJSON(),{Minimized:s("Minimized")}))),this.model.get("collapsed")?this.$flyout.hide():this.$flyout.show(),this.$el}});var l=function(e){var n=e.$el.find(".toggle-chatbox-button"),i=t({info_minimize:s("Minimize this chat box")});n.length?n.replaceWith(i):e.$el.find(".close-chatbox-button").after(i)};e.on("chatBoxOpened",l),e.on("controlBoxOpened",function(t){e.connection.connected&&e.chatboxviews.trimChats(t)});var c=function(){e.minimized_chats.remove()};e.on("logout",c)}})}),define("tpl!dragresize",["lodash"],function(_){return function(obj){obj||(obj={});var __t,__p="";with(obj)__p+='<div class="dragresize dragresize-top"></div>\n<div class="dragresize dragresize-topleft"></div>\n<div class="dragresize dragresize-left"></div>\n';return __p}}),function(e,t){define("converse-dragresize",["converse-core","tpl!dragresize","converse-chatview","converse-muc","converse-controlbox"],t)}(this,function(e,t){"use strict";var n=e.env.jQuery,i=e.env._;e.plugins.add("converse-dragresize",{optional_dependencies:["converse-headline"],overrides:{registerGlobalEventHandlers:function(){var e=this;return n(document).on("mousemove",function(t){return!e.resizing||!e.allow_dragresize||(t.preventDefault(),void e.resizing.chatbox.resizeChatBox(t))}),n(document).on("mouseup",function(t){if(!e.resizing||!e.allow_dragresize)return!0;t.preventDefault();var n=e.applyDragResistance(e.resizing.chatbox.height,e.resizing.chatbox.model.get("default_height")),i=e.applyDragResistance(e.resizing.chatbox.width,e.resizing.chatbox.model.get("default_width"));e.connection.connected?(e.resizing.chatbox.model.save({height:n}),e.resizing.chatbox.model.save({width:i})):(e.resizing.chatbox.model.set({height:n}),e.resizing.chatbox.model.set({width:i})),e.resizing=null}),this.__super__.registerGlobalEventHandlers.apply(this,arguments)},ChatBox:{initialize:function(){var e=this.__super__._converse,t=this.__super__.initialize.apply(this,arguments),n=this.get("height"),i=this.get("width"),o="controlbox"===this.get("id")?this.set.bind(this):this.save.bind(this);return o({height:e.applyDragResistance(n,this.get("default_height")),width:e.applyDragResistance(i,this.get("default_width"))}),t}},ChatBoxView:{events:{"mousedown .dragresize-top":"onStartVerticalResize","mousedown .dragresize-left":"onStartHorizontalResize","mousedown .dragresize-topleft":"onStartDiagonalResize"},initialize:function(){n(window).on("resize",i.debounce(this.setDimensions.bind(this),100)),this.__super__.initialize.apply(this,arguments)},render:function(){var e=this.__super__.render.apply(this,arguments);return this.setWidth(),e},setWidth:function(){this.model.get("width")&&this.$el.css("width",this.model.get("width"))},_show:function(){this.initDragResize().setDimensions(),this.__super__._show.apply(this,arguments)},initDragResize:function(){var e=this.__super__._converse,t=this.$el.find(".box-flyout");if(i.isUndefined(this.model.get("height"))){var n=t.height(),o=t.width();this.model.set("height",n),this.model.set("default_height",n),this.model.set("width",o),this.model.set("default_width",o)}var s=t.css("min-width"),r=t.css("min-height");return this.model.set("min_width",s.endsWith("px")?Number(s.replace(/px$/,"")):0),this.model.set("min_height",r.endsWith("px")?Number(r.replace(/px$/,"")):0),this.prev_pageY=0,this.prev_pageX=0,e.connection.connected&&(this.height=this.model.get("height"),this.width=this.model.get("width")),this},setDimensions:function(){this.adjustToViewport(),this.setChatBoxHeight(this.model.get("height")),this.setChatBoxWidth(this.model.get("width"))},setChatBoxHeight:function(e){var t=this.__super__._converse;e=e?t.applyDragResistance(e,this.model.get("default_height"))+"px":"",this.$el.children(".box-flyout")[0].style.height=e},setChatBoxWidth:function(e){var t=this.__super__._converse;e=e?t.applyDragResistance(e,this.model.get("default_width"))+"px":"",this.$el[0].style.width=e,this.$el.children(".box-flyout")[0].style.width=e},adjustToViewport:function(){var e=Math.max(document.documentElement.clientWidth,window.innerWidth||0),t=Math.max(document.documentElement.clientHeight,window.innerHeight||0);e<=480?(this.model.set("height",void 0),this.model.set("width",void 0)):e<=this.model.get("width")?this.model.set("width",void 0):t<=this.model.get("height")&&this.model.set("height",void 0)},onStartVerticalResize:function(e){var t=this.__super__._converse;return!t.allow_dragresize||(this.height=this.$el.children(".box-flyout").height(),t.resizing={chatbox:this,direction:"top"},void(this.prev_pageY=e.pageY))},onStartHorizontalResize:function(e){var t=this.__super__._converse;return!t.allow_dragresize||(this.width=this.$el.children(".box-flyout").width(),t.resizing={chatbox:this,direction:"left"},void(this.prev_pageX=e.pageX))},onStartDiagonalResize:function(e){var t=this.__super__._converse;this.onStartHorizontalResize(e),this.onStartVerticalResize(e),t.resizing.direction="topleft"},resizeChatBox:function(e){var t,n=this.__super__._converse;0===n.resizing.direction.indexOf("top")&&(t=e.pageY-this.prev_pageY,t&&(this.height=this.height-t>(this.model.get("min_height")||0)?this.height-t:this.model.get("min_height"),this.prev_pageY=e.pageY,this.setChatBoxHeight(this.height))),i.includes(n.resizing.direction,"left")&&(t=this.prev_pageX-e.pageX,t&&(this.width=this.width+t>(this.model.get("min_width")||0)?this.width+t:this.model.get("min_width"),this.prev_pageX=e.pageX,this.setChatBoxWidth(this.width)))}},HeadlinesBoxView:{events:{"mousedown .dragresize-top":"onStartVerticalResize","mousedown .dragresize-left":"onStartHorizontalResize","mousedown .dragresize-topleft":"onStartDiagonalResize"},initialize:function(){return n(window).on("resize",i.debounce(this.setDimensions.bind(this),100)),this.__super__.initialize.apply(this,arguments)},render:function(){return n(window).on("resize",i.debounce(this.setWidth.bind(this),100)),this.__super__.render.apply(this,arguments)}},ControlBoxView:{events:{"mousedown .dragresize-top":"onStartVerticalResize","mousedown .dragresize-left":"onStartHorizontalResize","mousedown .dragresize-topleft":"onStartDiagonalResize"},initialize:function(){n(window).on("resize",i.debounce(this.setDimensions.bind(this),100)),this.__super__.initialize.apply(this,arguments)},renderLoginPanel:function(){var e=this.__super__.renderLoginPanel.apply(this,arguments);return this.initDragResize().setDimensions(),e},renderContactsPanel:function(){var e=this.__super__.renderContactsPanel.apply(this,arguments);return this.initDragResize().setDimensions(),e}},ChatRoomView:{events:{"mousedown .dragresize-top":"onStartVerticalResize","mousedown .dragresize-left":"onStartHorizontalResize","mousedown .dragresize-topleft":"onStartDiagonalResize"},initialize:function(){n(window).on("resize",i.debounce(this.setDimensions.bind(this),100)),this.__super__.initialize.apply(this,arguments)},render:function(){var e=this.__super__.render.apply(this,arguments);return this.renderDragResizeHandles(),this.setWidth(),e},renderDragResizeHandles:function(){var e=(this.__super__._converse,this.el.querySelector(".box-flyout")),n=document.createElement("div");n.innerHTML=t(),e.insertBefore(n,e.firstChild)}}},initialize:function(){var e=this._converse;this.updateSettings({allow_dragresize:!0}),e.applyDragResistance=function(e,t){if(!i.isUndefined(e)){if(i.isUndefined(t))return e;var n=10;return e!==t&&Math.abs(e-t)<n?t:e}}}})}),function(e,t){define("converse-headline",["converse-core","tpl!chatbox","converse-chatview"],t)}(this,function(e,t){"use strict";var n=e.env._,i=e.env.utils;e.plugins.add("converse-headline",{overrides:{ChatBoxViews:{onChatBoxAdded:function(e){var t=this.__super__._converse,n=this.get(e.get("id"));return n||"headline"!==e.get("type")?this.__super__.onChatBoxAdded.apply(this,arguments):(n=new t.HeadlinesBoxView({model:e}),this.add(e.get("id"),n),n)}}},initialize:function(){var e=this._converse,o=e.__;e.HeadlinesBoxView=e.ChatBoxView.extend({className:"chatbox headlines",events:{"click .close-chatbox-button":"close","click .toggle-chatbox-button":"minimize","keypress textarea.chat-textarea":"keyPressed"},initialize:function(){this.disable_mam=!0,this.model.messages.on("add",this.onMessageAdded,this),this.model.on("show",this.show,this),this.model.on("destroy",this.hide,this),this.model.on("change:minimized",this.onMinimizedChanged,this),this.render().fetchMessages().insertIntoDOM().hide(),e.emit("chatBoxInitialized",this)},render:function(){return this.$el.attr("id",this.model.get("box_id")).html(t(n.extend(this.model.toJSON(),{show_toolbar:e.show_toolbar,show_textarea:!1,show_send_button:e.show_send_button,title:this.model.get("fullname"),unread_msgs:o("You have unread messages"),info_close:o("Close this box"),label_personal_message:""}))),this.$content=this.$el.find(".chat-content"),e.emit("chatBoxOpened",this),i.refreshWebkit(),this}});var s=function(t){var o=t.getAttribute("from");if(i.isHeadlineMessage(t)){if(n.includes(o,"@")&&!e.allow_non_roster_messaging)return;e.chatboxes.create({id:o,jid:o,fullname:o,type:"headline"}).createMessage(t,void 0,t),e.emit("message",t)}return!0},r=function(){e.connection.addHandler(s,null,"message")};e.on("connected",r),e.on("reconnected",r)}})}),"undefined"!=typeof define&&define("converse",["converse-core","converse-chatview","converse-controlbox","converse-bookmarks","converse-mam","converse-muc","converse-vcard","converse-otr","converse-register","converse-ping","converse-notification","converse-minimize","converse-dragresize","converse-headline"],function(e){return e}),define("jquery",[],function(){return jQuery}),define("jquery-private",[],function(){return jQuery}),define("jquery.browser",[],function(){return jQuery}),define("awesomplete",[],function(){return jQuery}),define("lodash",[],function(){return _}),define("moment_with_locales",[],function(){return moment}),define("strophe",[],function(){return{Strophe:Strophe,$build:$build,$iq:$iq,$msg:$msg,$pres:$pres,SHA1:SHA1,MD5:MD5,b64_hmac_sha1:SHA1.b64_hmac_sha1,b64_sha1:SHA1.b64_sha1,str_hmac_sha1:SHA1.str_hmac_sha1,str_sha1:SHA1.str_sha1}});var strophePlugin=function(){return Strophe},emptyFunction=function(){};return define("strophe.disco",["strophe"],strophePlugin),define("strophe.ping",["strophe"],strophePlugin),define("strophe.rsm",["strophe"],strophePlugin),define("strophe.vcard",["strophe"],strophePlugin),define("backbone",[],emptyFunction),define("backbone.browserStorage",["backbone"],emptyFunction),define("backbone.overview",["backbone"],emptyFunction),define("otr",[],function(){return{DSA:DSA,OTR:OTR}}),define("locales",[],emptyFunction),require("converse")});